<!DOCTYPE html>
<html lang="zh">
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
<title>標籤: testing - Leo&#39;s Coding Life</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<base href="/">



    <meta property="og:type" content="website">
<meta property="og:title" content="Leo&#39;s Coding Life">
<meta property="og:url" content="https://blog.leochen.dev/tags/testing/index.html">
<meta property="og:site_name" content="Leo&#39;s Coding Life">
<meta property="og:locale" content="zh-TW">
<meta property="og:image" content="https://blog.leochen.dev/images/og_image.png">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Leo&#39;s Coding Life">
<meta name="twitter:image" content="https://blog.leochen.dev/images/og_image.png">







<link rel="icon" href="/images/favicon.ico">


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.7.2/css/bulma.css">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.4.1/css/all.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:400,600|Source+Code+Pro">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css">


    
    
    
    <style>body>.footer,body>.navbar,body>.section{opacity:0}</style>
    

    
    
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css">
    

    
    

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.css">


    
    
    
    

<link rel="stylesheet" href="/css/back-to-top.css">


    
    
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-145121750-1"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', "UA-145121750-1");
</script>


    
    
    
    

    
    
<link rel="stylesheet" href="/css/progressbar.css">
<script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script>

    
    
    

    
    
    


<link rel="stylesheet" href="/css/style.css">
</head>
<body class="is-3-column">
    <nav class="navbar navbar-main">
    <div class="container">
        <div class="navbar-brand is-flex-center">
            <a class="navbar-item navbar-logo" href="/">
            
                <img src="/images/logo.png" alt="Leo&#39;s Coding Life" height="28">
            
            </a>
        </div>
        <div class="navbar-menu">
            
            <div class="navbar-start">
                
                <a class="navbar-item" href="/">Home</a>
                
                <a class="navbar-item" href="/archives">Archives</a>
                
                <a class="navbar-item" href="/categories">Categories</a>
                
                <a class="navbar-item" href="/tags">Tags</a>
                
            </div>
            
            <div class="navbar-end">
                
                    
                    
                    <a class="navbar-item" target="_blank" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus">
                        
                        <i class="fab fa-github"></i>
                        
                    </a>
                    
                
                
                
                <a class="navbar-item search" title="搜尋" href="javascript:;">
                    <i class="fas fa-search"></i>
                </a>
                
            </div>
        </div>
    </div>
</nav>
    
    <section class="section">
        <div class="container">
            <div class="columns">
                <div class="column is-8-tablet is-8-desktop is-6-widescreen has-order-2 column-main"><div class="card">
    <div class="card-content">
        <nav class="breadcrumb" aria-label="breadcrumbs">
        <ul>
            <li><a href="/tags">標籤</a></li>
            <li class="is-active"><a href="#" aria-current="page">testing</a></li>
        </ul>
        </nav>
    </div>
</div>

    <div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2021-10-15T15:30:20.000Z">2021-10-15</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/Web-前端/">Web 前端</a>&nbsp;/&nbsp;<a class="has-link-grey -link" href="/categories/Web-前端/iThome2021鐵人賽/">iThome2021鐵人賽</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    16 分鐘 閱讀文 (大約 2345 個字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2021/10/15/angular-30days-form-and-test-30/">Angular 深入淺出三十天：表單與測試 Day30 - 表單原理</a>
            
        </h1>
        <div class="content">
            <p><img src="https://i.imgur.com/J1xtemM.jpg" alt="Day30"></p>
<p>經過前面二十九天的的練習與學習，相信大家應該在表單的實作上都熟悉了不少，只要不是太複雜、太特別的表單應該也都難不倒你們。</p>
<p>今天是本系列文的最後一天，就讓我們來好好地深入了解一下 Angular 表單會這麼強大的原因吧！</p>
<p>首先，我想趁大家記憶猶新時，先帶大家來看為什麼我們昨天可以用 <code>ControlContainer</code> 來自訂一個可以被 <strong>Template Driven Forms</strong> 或是 <strong>Reactive Forms</strong> 所使用的 Component 。</p>
<h2 id="ControlContainer"><a href="#ControlContainer" class="headerlink" title="ControlContainer"></a>ControlContainer</h2><p><img src="https://i.imgur.com/WDY226J.jpg" alt="Diagram"></p>
<p>上圖是我根據 Angular 的 Source Code 找出 <code>ControlContainer</code> 的關係所畫的（斜體表抽象類別）。</p>
<p>從圖中我們會發現， <code>ControlContainer</code> 其實只是一個<strong>抽象類別</strong>，並繼承了另一個<strong>抽象類別</strong> <code>AbstractControlDirective</code> ，而 <code>AbstractControlDirective</code> 這個抽象類別其實也被另一個抽象類別 <code>NgControl</code> 所繼承。</p>
<blockquote>
<p><code>NgControl</code> 晚點會提到，此處暫不多做說明。</p>
</blockquote>
<p>至於 <code>ControlContainer</code> ，它其實也被 <code>AbstractFormGroupDirect</code> 、 <code>NgForm</code> 、 <code>FormGroupDirective</code> 與 <code>FormArrayName</code> 這四個 Directive 所繼承；甚至 <code>AbstractFormGroupDirect</code> 還被 <code>FormGroupName</code> 與 <code>NgModelGroup</code> 這兩個 Directive 所繼承。</p>
<p>換句話說， Angular 根據 <code>ControlContainer</code> 為基底，做出了以下五個 Directive ：</p>
<ul>
<li><code>FormGroupDirective</code></li>
<li><code>FormGroupName</code></li>
<li><code>FormArrayName</code></li>
<li><code>NgForm</code></li>
<li><code>NgModelGroup</code></li>
</ul>
<p>在這五個 Directive 裡，前面三個是為什麼我們在用 <strong>Reactive Forms</strong> 的方式來開發表單時，可以在 Template 裡用 <code>[formGroup]</code> 、 <code>[formGroupName]</code> 、 <code>[formArrayName]</code> 的方式將元素與 <code>FormGroup</code> 、 <code>FormArray</code> 綁定的原因。</p>
<blockquote>
<p>大家應該都還記得我們是怎麼將 <code>FormGroup</code> 與 <code>FormArray</code> 綁定到元素上的吧？！</p>
</blockquote>
<p>而後面兩個則是為什麼我們在用 <strong>Template Driven Forms</strong> 的方式來開發表單時，可以在 Template 裡在元素上使用 <code>#XXX=&quot;ngForm&#39;</code> 、 <code>#XXX=&quot;ngModelGroup&quot;</code> 之後，可以拿到 <code>NgForm</code> 與 <code>NgModelGroup</code> 的實體的原因。</p>
<blockquote>
<p>雖然本系列文沒有特別提到 <code>ngModelGroup</code> 的用法，想知道的朋友可以參考官方的 <a href="https://angular.io/api/forms/NgModelGroup" target="_blank" rel="noopener">NgModelGroup API</a> 文件</p>
</blockquote>
<p>那為什麼我們可以使用 <code>ControlContainer</code> 來自訂元件呢？</p>
<p>其實這正是因為上述五個 Directive 都透過 <code>ControlContainer</code> 這個令牌，把自己註冊到 Angular 的 DI 系統裡，讓想使用它們的類別，可以很方便地透過 Angular 的 DI 系統來找到它們的實體。</p>
<p>像是在<a href="https://ithelp.ithome.com.tw/articles/10281652" target="_blank" rel="noopener">昨天的文章</a>裡所分享的那樣（Reactive Forms 的方式）：</p>
<figure class="highlight typescript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> AddressInfoComponent &#123;</span><br><span class="line">  <span class="hljs-keyword">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> controlContainer: ControlContainer</span>) &#123; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Template Driven Forms 則是透過 <code>viewProvider</code> 的方式，忘記的話請看<a href="https://ithelp.ithome.com.tw/articles/10281652" target="_blank" rel="noopener">昨天的文章</a>。</p>
</blockquote>
<h2 id="NgControl"><a href="#NgControl" class="headerlink" title="NgControl"></a>NgControl</h2><p><img src="https://i.imgur.com/Oa5GgVA.jpg" alt="Diagram"></p>
<p>同樣地， Angular 也根據 <code>NgControl</code> 為基底，做出了以下三個 Directive ：</p>
<ul>
<li><code>FormControlName</code></li>
<li><code>FormControlDirective</code></li>
<li><code>NgModel</code></li>
</ul>
<p>在這三個 Directive 裡，前面兩個是為什麼我們在用 <strong>Reactive Forms</strong> 的方式來開發表單時，可以在 Template 裡用 <code>[formControl]</code> 、 <code>[formControlName]</code> 的方式將元素與 <code>FormControl</code> 綁定的原因。</p>
<blockquote>
<p>大家應該都還記得我們是怎麼將 <code>FormControl</code> 綁定到元素上的吧？！</p>
</blockquote>
<p>而最後一個則是為什麼我們在用 <strong>Template Driven Forms</strong> 的方式來開發表單時，會在 Template 裡在元素上使用 <code>#XXX=&quot;ngModel&#39;</code> 之後，可以拿到 <code>NgForm</code> 與 <code>NgModelGroup</code> 的實體的原因。</p>
<p>不過，大家還記不記得我們在<a href="https://ithelp.ithome.com.tw/articles/10281361" target="_blank" rel="noopener">第二十八天</a>的時候，是怎麼自訂表單元件的嗎？</p>
<p>沒錯！就是 <code>ControlValueAccessor</code> 。</p>
<p>上述三個 Directive 實作時，也是透過 DI 拿到實作了 <code>ControlValueAccessor</code> 介面的實體，並在初始化的時候透過 <code>ControlValueAccessor</code> 這個介面，搭建 <code>FormControl</code> 與實作了它的實體之間的溝通管道。</p>
<blockquote>
<p>想看原始碼的朋友可以<a href="https://github.com/angular/angular/blob/master/packages/forms/src/directives/reactive_directives/form_control_directive.ts#L53-L178" target="_blank" rel="noopener">點我</a>看原始碼。</p>
<p>如果想知道 <code>@Self</code> 與 <code>@Optional</code> 裝飾器是幹嘛用的，可以參考這篇很前顯易懂的文章： <a href="https://medium.com/frontend-coach/self-or-optional-host-the-visual-guide-to-angular-di-decorators-73fbbb5c8658" target="_blank" rel="noopener">@Self or @Optional @Host? The visual guide to Angular DI decorators.</a></p>
</blockquote>
<p>但除了 <code>ControlValueAccessor</code> 之外，其實 Angular 還有其他內建的 ValueAccessor：</p>
<p><img src="https://i.imgur.com/JdzzegU.jpg" alt="Diagram"></p>
<p>從上圖中我們可以發現，內建的 ValueAccessor 基本上都是繼承於 <code>BaseControlValueAccessor</code> 這個類別，然後分別被 <code>DefaultValueAccessor</code> 與 <code>BuiltInControlValueAccessor</code> 繼承，而只有 <code>DefaultValueAccessor</code> 有實作 <code>ControlValueAccessor</code> 這個介面。</p>
<p>然後 Angular 再基於 <code>BuiltInControlValueAccessor</code> 之上去建立了以下六個 ValueAccessor：</p>
<ul>
<li><code>NumberValueAccessor</code></li>
<li><code>RangeValueAccessor</code></li>
<li><code>RadioControlValueAccessor</code></li>
<li><code>CheckboxControlValueAccessor</code></li>
<li><code>SelectControlValueAccessor</code></li>
<li><code>SelectMultipleControlValueAccessor</code></li>
</ul>
<p>而這六個 ValueAccessor 對於我們的表單開發來說是至關重要的存在，沒有了它們，我們就沒辦法在這些元素上綁定我們的表單控制項。</p>
<p>但其實 <code>BaseControlValueAccessor</code> 與 <code>BuiltInControlValueAccessor</code> 本身並沒有什麼比較特別的實作或定義，之所以會有 <code>DefaultValueAccessor</code> 與 <code>BuiltInControlValueAccessor</code> 的區別，是為了在機制上，能夠做到一個優先權判斷的機制。</p>
<p>當我們在使用自訂的 <code>ValueAccessor</code> 時候， <code>DefaultValueAccessor</code> 或是上述六個 ValueAccessor 其實都有可能與我們自訂的 <code>ValueAccessor</code> 同時存在。</p>
<p>因此，在將我們的表單控制項與元素綁定的時候， Angular 會根據以下的優先權來抓取對應的 ValueAccessor ：</p>
<ol>
<li>CustomValueAccessor</li>
<li>BuiltInValueAccessor</li>
<li>DefaultValueAccessor</li>
</ol>
<p>如此一來，只要我們沒有自訂 ValueAccessor ，預設就是會使用內建的 ValueAccessor 來搭建表單控制項與元素之間的溝通橋樑。</p>
<blockquote>
<p>我覺得 Angular 的開發團隊真的很聰明！</p>
</blockquote>
<h2 id="同步與非同步"><a href="#同步與非同步" class="headerlink" title="同步與非同步"></a>同步與非同步</h2><p>除了上述的東西之外，其實還有一個比較特別的點，就是關於同步更新與非同步更新的問題。</p>
<p>在 <a href="https://ithelp.ithome.com.tw/articles/10275677" target="_blank" rel="noopener">Day16 - Template Driven Forms vs Reactive Forms</a> 的小結裡，我分享了一個表格，表格裡提到了 Template Driven Forms 的可預測性是<strong>非同步</strong>的。</p>
<p>而這件事情其實可以在 <code>NgModel</code> 的<a href="https://github.com/angular/angular/blob/master/packages/forms/src/directives/ng_model.ts#L222" target="_blank" rel="noopener">原始碼第 222 行</a> 看出一點端倪。</p>
<p><a href="https://github.com/angular/angular/blob/master/packages/forms/src/directives/ng_model.ts#L222" target="_blank" rel="noopener">原始碼第 222 行</a>這行是指 <code>NgModel</code> 在初始化的時候，會去設置表單控制項。</p>
<p>而在<a href="https://github.com/angular/angular/blob/bd0d7c15c195c990b59cad3361f22caa10a9b1aa/packages/forms/src/directives/ng_model.ts#L268" target="_blank" rel="noopener">原始碼第 268 行</a>中可以看到，它會判斷該 NgModel 是不是 <code>_isStandalone</code> ，也就是它是不是單獨存在，還是有被 <code>&lt;form&gt;&lt;/form&gt;</code> 包住。</p>
<p>如果是單獨存在， <code>NgModel</code> 的行為其實會跟 <code>FormControlDirective</code> 與 <code>FormControlName</code> 一樣，因為他們會用<a href="https://github.com/angular/angular/blob/master/packages/forms/src/directives/shared.ts#L34-#L50" target="_blank" rel="noopener">一樣的方法</a>設置表單控制項。</p>
<p>但如果不是單獨存在，它會用 <code>NgForm</code> 的 <code>addControl</code> 來設置表單控制項，這時，它就會是非同步的，因為他必須等到 <code>resolvedPromise</code> 發出 <code>resolver</code> 事件的時候，才會進行設置。</p>
<blockquote>
<p><code>addControl</code> 的實作在<a href="https://github.com/angular/angular/blob/master/packages/forms/src/directives/ng_form.ts#L187-#L196" target="_blank" rel="noopener">原始碼的第 187 行到 196 行</a></p>
<p><code>resolvedPromise</code> 的定義則是在<a href="https://github.com/angular/angular/blob/master/packages/forms/src/directives/ng_form.ts#L27" target="_blank" rel="noopener">原始碼的第 27 行</a></p>
</blockquote>
<p>我其實不太懂 Angular 為什麼要在 <code>NgModel</code> 被 <code>&lt;form&gt;&lt;/form&gt;</code> 包起來的時候這樣子做，因為 <code>resolvedPromise</code> 其實也沒什麼特別的地方，但它們就讓 <code>NgForm</code> 在 <code>addControl</code> 、 <code>removeControl</code> 、 <code>addFormGroup</code> 與 <code>removeFormGroup</code> 這四個方法要變成非同步的方式處理。</p>
<p>如果大家有興趣，或許找個時間研究一下，說不定，你就幫官方解決了一個問題呢！</p>
<h2 id="本日小結"><a href="#本日小結" class="headerlink" title="本日小結"></a>本日小結</h2><p>今天主要是幫本系列文做個結尾，希望能讓大家透過我的分享，更熟悉、更了解 Angular 一點。</p>
<p>也因為分享的關係，其實在撰寫本系列文的同時，我也得到了許多。</p>
<p>以前尚不熟悉的更熟悉了；以前不知道的知道了。</p>
<p>這或許就是所謂的「施比受更有福」吧？！</p>
<p>未來，還會不會再寫鐵人賽還不曉得（目前是不想再寫了，哈哈！）。</p>
<p>但是，寫鐵人賽真的是一個非常好的學習機會。</p>
<p>透過撰寫文章，來疏理自己所學，仔細咀嚼後再回饋給社群、回饋給社會。</p>
<p>如果你還沒寫過鐵人賽，我衷心推薦你這一輩子一定至少要寫一次鐵人賽。</p>
<p>最後，我想感謝訂閱我的文章、閱讀我的文章、喜歡我的文章的你們，謝謝你們不嫌棄，也謝謝你們願意讓我能夠幫到你們。</p>
<p>我也想感謝我的家人們，寫鐵人賽的這段期間，真的是非常地疏於陪伴，謝謝他們的支持（雖然他們看不到）。</p>
<p>感謝大家的收看，我們有緣再見！ ：）</p>
<h2 id="其他資源"><a href="#其他資源" class="headerlink" title="其他資源"></a>其他資源</h2><ul>
<li><a href="https://www.facebook.com/groups/augularjs.tw/" target="_blank" rel="noopener">Angular Taiwan 臉書社團</a></li>
<li><a href="https://forum.angular.tw/" target="_blank" rel="noopener">Angular Taiwan 討論區</a></li>
<li><a href="https://www.facebook.com/groups/angularstudygroup/" target="_blank" rel="noopener">Angular Taiwan 線上讀書會社團</a></li>
<li><a href="https://www.youtube.com/channel/UCIawWId4sXgkVZ_mCF25qGw/videos" target="_blank" rel="noopener">Angular Taiwan Youtube 頻道</a></li>
</ul>

        </div>
        
        
        
    </div>
</div>








    <div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2021-10-14T14:45:12.000Z">2021-10-14</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/Web-前端/">Web 前端</a>&nbsp;/&nbsp;<a class="has-link-grey -link" href="/categories/Web-前端/iThome2021鐵人賽/">iThome2021鐵人賽</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    8 分鐘 閱讀文 (大約 1210 個字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2021/10/14/angular-30days-form-and-test-29/">Angular 深入淺出三十天：表單與測試 Day29 - ControlContainer</a>
            
        </h1>
        <div class="content">
            <p><img src="https://i.imgur.com/i2QD8xM.jpg" alt="Day29"></p>
<p>昨天跟大家分享了自訂表單元件的作法，但昨天的作法只適用於一個欄位、一個 <code>FormControl</code> 。</p>
<p>雖然 <code>FormControl</code> 裡是可以設 <code>{}</code> 的值，但如果我們真的想要的是一個可以直接用 <code>[formGroup]</code> 、 <code>[formArray]</code> 所使用的元件呢？</p>
<blockquote>
<p><del>沒問題，只要你想要， Angular 都給你</del></p>
</blockquote>
<h2 id="實作開始"><a href="#實作開始" class="headerlink" title="實作開始"></a>實作開始</h2><p>大家還記得之前我們做了個「被保人表單」吧？</p>
<p>一開始只有「姓名」、「性別」跟「年齡」這三個欄位，後來我們加了「聯絡資訊」的欄位，這次我們再幫它加個「聯絡地址」的欄位吧！</p>
<p>一般來說，聯絡地址的欄位通常會分成「縣市」、「鄉鎮市區」、「郵遞區號」與「地址」，而「縣市」、「鄉鎮市區」與「郵遞區號」之間會有一些連動邏輯，縣市」與「鄉鎮市區」這兩個欄位也通常會是下拉選單，其他的則是一般的 <code>input</code> 欄位。</p>
<p>首先一樣先把 HTML 準備好，像這樣：</p>
<figure class="highlight html hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>聯絡地址：<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">select</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">""</span>&gt;</span>請選擇縣市<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">select</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">""</span>&gt;</span>請選擇鄉鎮市區<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"width: 4rem"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"郵遞區號"</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">place</span>=<span class="hljs-string">"請輸入地址"</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>畫面：</p>
<p><img src="https://i.imgur.com/PvbkpwX.jpg" alt="Template View"></p>
<blockquote>
<p>樣式用 <code>inline</code> 的方式設定是方便教學，小朋友們要盡量少用噢！</p>
</blockquote>
<p>接著，在 <code>.ts</code> 裡加入地址的相關欄位的 <code>FormGroup</code> 與 <code>FormControl</code> ：</p>
<figure class="highlight typescript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">const</span> addressInfoFormGroup = <span class="hljs-keyword">this</span>.formBuilder.group(&#123;</span><br><span class="line">  city: <span class="hljs-string">''</span>,</span><br><span class="line">  district: <span class="hljs-string">''</span>,</span><br><span class="line">  zip: <span class="hljs-string">''</span>,</span><br><span class="line">  address: <span class="hljs-string">''</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.formBuilder.group(&#123;</span><br><span class="line">  name: [</span><br><span class="line">    <span class="hljs-string">''</span>,</span><br><span class="line">    [Validators.required, Validators.minLength(<span class="hljs-number">2</span>), Validators.maxLength(<span class="hljs-number">10</span>)]</span><br><span class="line">  ],</span><br><span class="line">  gender: [<span class="hljs-string">''</span>, Validators.required],</span><br><span class="line">  age: [<span class="hljs-string">''</span>, Validators.required],</span><br><span class="line">  contactInfoType: contactInfoTypeControl,</span><br><span class="line">  contactInfo: contactInfoControl,</span><br><span class="line">  addressInfo: addressInfoFormGroup</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>然後再將其綁與畫面上元素綁定，像這樣：</p>
<figure class="highlight html hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">ng-container</span> <span class="hljs-attr">formGroupName</span>=<span class="hljs-string">"addressInfo"</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>聯絡地址：<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">formControlName</span>=<span class="hljs-string">"city"</span>&gt;</span></span><br><span class="line">      <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">""</span>&gt;</span>請選擇縣市<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">formControlName</span>=<span class="hljs-string">"district"</span>&gt;</span></span><br><span class="line">      <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">""</span>&gt;</span>請選擇鄉鎮市區<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"width: 4rem"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"郵遞區號"</span> <span class="hljs-attr">formControlName</span>=<span class="hljs-string">"zip"</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"請輸入地址"</span> <span class="hljs-attr">formControlName</span>=<span class="hljs-string">"address"</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">ng-container</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>連動邏輯的實作就交給大家練習囉，我們今天沒有要著重於此部分的處理。</p>
</blockquote>
<p>至此，我們就完成了第一步的準備工作。</p>
<h2 id="ControlContainer"><a href="#ControlContainer" class="headerlink" title="ControlContainer"></a>ControlContainer</h2><p>接下來，我們就要將聯絡地址這塊拆成一個獨立的 Component ─ <code>AddressInfoComponent</code> 。</p>
<p>首先，先將 HTML 搬過去並稍微調整一下：</p>
<figure class="highlight html hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">ng-container</span> [<span class="hljs-attr">formGroup</span>]=<span class="hljs-string">"formGroup"</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">formControlName</span>=<span class="hljs-string">"city"</span>&gt;</span></span><br><span class="line">      <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">""</span>&gt;</span>請選擇縣市<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">formControlName</span>=<span class="hljs-string">"district"</span>&gt;</span></span><br><span class="line">      <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">""</span>&gt;</span>請選擇鄉鎮市區<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"width: 4rem"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"郵遞區號"</span> <span class="hljs-attr">formControlName</span>=<span class="hljs-string">"zip"</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"請輸入地址"</span> <span class="hljs-attr">formControlName</span>=<span class="hljs-string">"address"</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">ng-container</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>接著在 <code>AddressInfoComponent</code> 裡注入 <code>ControlContainer</code>：</p>
<figure class="highlight typescript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> AddressInfoComponent &#123;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> controlContainer: ControlContainer</span>) &#123; &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然後加上：</p>
<figure class="highlight typescript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">get</span> formGroup(): FormGroup &#123;</span><br><span class="line">  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.controlContainer.control <span class="hljs-keyword">as</span> FormGroup;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再回到被保人表單裡，把原本的聯絡地址區塊改成：</p>
<figure class="highlight html hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>聯絡地址：<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">app-address-info</span> <span class="hljs-attr">formGroupName</span>=<span class="hljs-string">"addressInfo"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">app-address-info</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>至此就大功告成了！是不是超簡單的？！</p>
<p>不過之所以這麼簡單是因為這是 <strong>Reactive Forms</strong> 的方式，今天的 <code>ControlContainer</code> 不像昨天的 <code>ControlValueAccessor</code> 可以做一次之後，兩種方式都可以使用。</p>
<p>如果今天這個元件是要讓 <strong>Template Driven Forms</strong> 使用的話，首先要先將 Template 原本用 <strong>Reactive Forms</strong> 的綁定方式改成使用 <strong>Template Driven Forms</strong> 的綁定方式，像是這樣：</p>
<figure class="highlight html hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">ng-container</span> <span class="hljs-attr">ngModelGroup</span>=<span class="hljs-string">"addressInfo"</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"zip"</span> <span class="hljs-attr">ngModel</span>&gt;</span></span><br><span class="line">      <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">""</span>&gt;</span>請選擇縣市<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"district"</span> &gt;</span></span><br><span class="line">      <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">""</span>&gt;</span>請選擇鄉鎮市區<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"width: 4rem"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"郵遞區號"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"zip"</span> <span class="hljs-attr">ngModel</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"請輸入地址"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"address"</span> <span class="hljs-attr">ngModel</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">ng-container</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>然後也不用在 <code>AddressInfoComponent</code> 裡注入 <code>ControlContainer</code> ，而是改在 <code>AddressInfoComponent</code> 的 <strong>MetaData</strong> 的 <code>viewProviders</code> 裡新增以下設定：</p>
<figure class="highlight typescript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">@Component</span>(&#123;</span><br><span class="line">  selector: <span class="hljs-string">'app-address-info'</span>,</span><br><span class="line">  templateUrl: <span class="hljs-string">'./address-info.component.html'</span>,</span><br><span class="line">  styleUrls: [<span class="hljs-string">'./address-info.component.scss'</span>],</span><br><span class="line">  viewProviders:[</span><br><span class="line">    &#123;</span><br><span class="line">      provide: ControlContainer, </span><br><span class="line">      useExisting: NgForm</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> AddressInfoComponent &#123;</span><br></pre></td></tr></table></figure>

<p>這樣就能直接用 <code>&lt;app-address-info&gt;&lt;/app-address-info&gt;</code> 的方式使用這個元件了。</p>
<p>大家覺得，是 <code>Reactive Forms</code> 的方式好用，還是 <code>Template Driven Forms</code> 的方式好用呢？</p>
<h2 id="本日小結"><a href="#本日小結" class="headerlink" title="本日小結"></a>本日小結</h2><p>今天的重點主要是讓大家知道要怎麼使用 <code>ControlContainer</code> 這個類別來<strong>包裝</strong>我們的元件，以達到提昇<strong>重用性</strong>與<strong>維護性</strong>的目的。</p>
<p>雖然麻煩的是，它沒辦法像昨天分享的 <code>ControlValueAccessor</code> 一樣，做好了之後可以適用於 <strong>Template Driven Forms</strong> 與 <strong>Reactive Forms</strong> ，但好在它的用法其實頗為簡單，主要的差異就只有在 <strong>Template Driven Forms</strong> 需要靠 <code>viewProvider</code> ，而 <strong>Reactive Froms</strong> 只要注入就行。</p>
<p>關於 viewProvider 與 provider 的差異，我推薦大家可以去看 Kevin （台灣 Angular GDE）的 <a href="https://blog.kevinyang.net/2018/01/19/angular-viewproviders-providers/" target="_blank" rel="noopener">[Angular] viewProviders V.S. providers</a> ，我覺得寫得非常的清楚。</p>
<p>此外，如果覺得我分享不好，也可以參考 Kevin 的 <a href="https://blog.kevinyang.net/2019/01/04/angular-controlContainer/" target="_blank" rel="noopener">[Angular] ControlContainer 的應用</a></p>
<p>今天的程式碼會放在 <a href="https://github.com/leochen0818/angular-30days-form-and-testing/tree/day29" target="_blank" rel="noopener">Github - Branch: day29</a> 上供大家參考，建議大家在看我的實作之前，先按照需求規格自己做一遍，之後再跟我的對照，看看自己的實作跟我的實作不同的地方在哪裡、有什麼好處與壞處，如此反覆咀嚼消化後，我相信你一定可以進步地非常快！</p>
<p>如果有任何的問題或是回饋，還請麻煩留言給我讓我知道！</p>

        </div>
        
        
        
    </div>
</div>








    <div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2021-10-13T15:38:05.000Z">2021-10-13</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/Web-前端/">Web 前端</a>&nbsp;/&nbsp;<a class="has-link-grey -link" href="/categories/Web-前端/iThome2021鐵人賽/">iThome2021鐵人賽</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    15 分鐘 閱讀文 (大約 2182 個字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2021/10/13/angular-30days-form-and-test-28/">Angular 深入淺出三十天：表單與測試 Day28 - 自訂表單元件</a>
            
        </h1>
        <div class="content">
            <p><img src="https://i.imgur.com/RfSbRb8.jpg" alt="Day28"></p>
<p>經過了這段時間的練習與學習，相信大家應該越來越能體會 Angular 表單的強大與便利。</p>
<p>不過既然 Angular 表單這麼好用，如果能讓自己做的 Component 也像 Angular 表單那樣一般使用該有多好？</p>
<p>因此，今天想要跟大家分享的是 ─ 如何<strong>自訂表單元件</strong>。</p>
<h2 id="應用場景"><a href="#應用場景" class="headerlink" title="應用場景"></a>應用場景</h2><p>大家跟我一起想像一下，假設我們今天需要做一個管理平台，在這個管理平台裡，會有很多地方都會需要用到我們昨天做的 <code>DateRangeComponent</code> ，但不一定會是在同一個表單裡，只是剛好也需要 <code>startDate</code> 與 <code>endDate</code> 這兩個欄位，而且畫面與欄位驗證的規則也都是一樣。</p>
<p>例如：</p>
<p>A 頁面是一個查詢訂單系統， B 頁面是查詢會員系統，雖然這兩個頁面的查詢條件可能都不太一樣，但恰好都可以根據<strong>起迄日</strong>來查詢相應的資料。</p>
<p>這時，我們很有可能就會將我們做好的 <code>DateRangeComponent</code> 做成<strong>表單元件</strong>，讓 A 跟 B 在使用它的時候，就像使用一般的表單元件一樣輕鬆、自然。</p>
<p>那究竟要怎麼做呢？</p>
<h2 id="ControlValueAccessor"><a href="#ControlValueAccessor" class="headerlink" title="ControlValueAccessor"></a>ControlValueAccessor</h2><p>首先要介紹給大家認識的是 <code>ControlValueAccessor</code> ，它是個 <code>Interface</code> ，而它定義了以下四個函式：</p>
<figure class="highlight typescript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">interface</span> ControlValueAccessor &#123;</span><br><span class="line">  writeValue(obj: <span class="hljs-built_in">any</span>): <span class="hljs-built_in">void</span></span><br><span class="line">  registerOnChange(fn: <span class="hljs-built_in">any</span>): <span class="hljs-built_in">void</span></span><br><span class="line">  registerOnTouched(fn: <span class="hljs-built_in">any</span>): <span class="hljs-built_in">void</span></span><br><span class="line">  setDisabledState(isDisabled: <span class="hljs-built_in">boolean</span>)?: <span class="hljs-built_in">void</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>writeValue(obj: any): void</code> ─ <strong>表單控件</strong>想要將值寫入時，會呼叫此函式</li>
<li><code>registerOnChange(fn: any): void</code> ─ <strong>表單控件初始化時</strong>會呼叫此函式，並傳入一個<strong>回呼函式</strong>，讓實作此介面的類別在其<strong>值有變動</strong>時，使用該回呼函式並<strong>傳入欲變動的值</strong></li>
<li><code>registerOnTouched(fn: any): void</code> ─ <strong>表單控件初始化時</strong>會呼叫此函式，並傳入一個<strong>回呼函式</strong>，讓實作此介面的類別在<strong>失去焦點</strong>時，使用該回呼函式以<strong>通知表單控件</strong></li>
<li><code>setDisabledState(isDisabled: boolean)?: void</code> ─ 當<strong>表單控件的狀態</strong>變成 <code>DISABLED</code> 抑或是從 <code>DISABLED</code> 改變成其他狀態時，會呼叫此函式以通知實作此介面的類別</li>
</ul>
<p>雖然我覺得我說的滿清楚的，但大家應該還是覺得很模糊，對吧？</p>
<p>不要緊，我只是先讓大家有個印象，待會實作時大家就會更加理解了。</p>
<h2 id="實作開始"><a href="#實作開始" class="headerlink" title="實作開始"></a>實作開始</h2><p>首先，我們需要另一個 Component 來用我們昨天做好的 <code>DateRangeComponent</code> ，像這樣：</p>
<figure class="highlight html hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">form</span> *<span class="hljs-attr">ngIf</span>=<span class="hljs-string">"formGroup"</span> [<span class="hljs-attr">formGroup</span>]=<span class="hljs-string">"formGroup"</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">app-date-range</span> <span class="hljs-attr">formControlName</span>=<span class="hljs-string">"dateRange"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">app-date-range</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>然後在 Component 的 <code>.ts</code> 裡準備好 <code>FormGroup</code> ，像這樣：</p>
<figure class="highlight ts hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> ReactiveFormsDateRangeComponent <span class="hljs-keyword">implements</span> OnInit &#123;</span><br><span class="line"></span><br><span class="line">  formGroup: FormGroup | <span class="hljs-literal">undefined</span>;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> formBuilder: FormBuilder</span>) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  ngOnInit(): <span class="hljs-built_in">void</span> &#123;</span><br><span class="line">    <span class="hljs-keyword">this</span>.formGroup = <span class="hljs-keyword">this</span>.formBuilder.group(&#123; dateRange: <span class="hljs-string">''</span> &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接著打開昨天做的 <code>DateRangeComponent</code> ，並在 <code>implements</code> 的後方加上 <code>ControlValueAccessor</code> ，像這樣：</p>
<figure class="highlight typescript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> DateRangeComponent <span class="hljs-keyword">implements</span> OnInit, ControlValueAccessor &#123;</span><br><span class="line">  <span class="hljs-comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>這時你應該會發現 <code>DateRangeComponent</code> 出現了一條紅色毛毛蟲，當你把滑鼠游標移到上面的時候，它說：</p>
<p><img src="https://i.imgur.com/PJLbE8u.jpg" alt="The Tooltip"></p>
<p>這是因為我們為 <code>DateRangeComponent</code> 加上實作 <code>ControlValueAccessor</code> 的宣告後，編輯器提醒我們要記得實作 <code>ControlValueAccessor</code> 的四個函式，才符合該介面的定義。</p>
<blockquote>
<p>這就像是我們如果想要 Cosplay 鋼鐵人，但我什麼盔甲都沒穿就說自己是鋼鐵人，別人只會覺得滿臉問號。</p>
<p>但只要我們戴上了頭盔，別人就會知道你在扮演鋼鐵人。</p>
</blockquote>
<p>所以我們就在 <code>DateRangeComponent</code> 裡加上以下四個函式：</p>
<figure class="highlight typescript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> DateRangeComponent <span class="hljs-keyword">implements</span> OnInit, ControlValueAccessor &#123;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">// ...</span></span><br><span class="line"></span><br><span class="line">  writeValue(obj: <span class="hljs-built_in">any</span>): <span class="hljs-built_in">void</span> &#123;</span><br><span class="line">    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'writeValue'</span>, obj);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  registerOnChange(fn: <span class="hljs-built_in">any</span>): <span class="hljs-built_in">void</span> &#123;</span><br><span class="line">    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'registerOnChange'</span>, fn);</span><br><span class="line">  &#125;</span><br><span class="line">  registerOnTouched(fn: <span class="hljs-built_in">any</span>): <span class="hljs-built_in">void</span> &#123;</span><br><span class="line">    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'registerOnTouched'</span>, fn);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  setDisabledState(isDisabled: <span class="hljs-built_in">boolean</span>): <span class="hljs-built_in">void</span> &#123;</span><br><span class="line">    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'setDisabledState'</span>, isDisabled);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下來，我們需要在 <code>DateRangeComponent</code> 的 <strong>MetaData</strong> 裡的 <code>providers</code> 裡加入一些設定，像這樣：</p>
<figure class="highlight typescript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">@Component</span>(&#123;</span><br><span class="line">  selector: <span class="hljs-string">'app-date-range'</span>,</span><br><span class="line">  templateUrl: <span class="hljs-string">'./date-range.component.html'</span>,</span><br><span class="line">  styleUrls: [<span class="hljs-string">'./date-range.component.scss'</span>],</span><br><span class="line">  providers: [</span><br><span class="line">    &#123;</span><br><span class="line">      provide: NG_VALUE_ACCESSOR,</span><br><span class="line">      useExisting: forwardRef(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> DateRangeComponent),</span><br><span class="line">      multi: <span class="hljs-literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> DateRangeComponent <span class="hljs-keyword">implements</span> OnInit, ControlValueAccessor &#123;</span><br><span class="line">  <span class="hljs-comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我們之前其實也曾經在第二十五天的文章 ─ <a href="https://ithelp.ithome.com.tw/articles/10280031" target="_blank" rel="noopener">測試進階技巧 - DI 抽換</a>裡用過類似的技巧。</p>
<p>簡單來說，這個設定是為了讓表單可以透過 <code>NG_VALUE_ACCESSOR</code> 這個 <strong>InjectionToken</strong> 取得我們這個實作了 <code>ControlValueAccessor</code> 介面的 <code>DateRangeComponent</code> 實體。</p>
<blockquote>
<p>想知道什麼是 <strong>InjectionToken</strong> 的朋友，可以參考 Mike 的 <a href="https://ithelp.ithome.com.tw/articles/10208630" target="_blank" rel="noopener">[Angular 大師之路] Day 23 - 認識 InjectionToken</a> 。</p>
<p>想知道 <code>useExisting</code> 跟 <code>useValue</code> 、 <code>useClass</code> 與 <code>useFactory</code> 有哪裡不一樣的，也可以參考 Mike 的 <a href="https://ithelp.ithome.com.tw/articles/10207990" target="_blank" rel="noopener">[Angular 大師之路] Day 20 - 在 @NgModule 的 providers: [] 自由更換注入內容 (1)</a> 與 <a href="https://ithelp.ithome.com.tw/articles/10208240" target="_blank" rel="noopener">[Angular 大師之路] Day 21 - 在 @NgModule 的 providers: [] 自由更換注入內容 (2)</a> 。</p>
<p>而 <code>forwardRef()</code> 的部份，我覺得官網的 <a href="https://angular.io/guide/dependency-injection-in-action#break-circularities-with-a-forward-class-reference-forwardref" target="_blank" rel="noopener">Dependency injection in action - Break circularities with a forward class reference</a> 講得比較清楚。</p>
<p>最後的 <code>multi: true</code> ，可以參考林穎平 EP 的 <a href="https://ithelp.ithome.com.tw/articles/10242741" target="_blank" rel="noopener">[Day 8] 所以我說那個 multi 是？</a> ，如果想要更深入的了解其原理，他也寫了一篇 <a href="https://ithelp.ithome.com.tw/articles/10243986" target="_blank" rel="noopener">[Day 10] 深度看一下 Angular 建立 multi provider 的機制</a>（真的很深入）</p>
</blockquote>
<p>至此，我們就可以儲存檔案來看一下初始化完後會印出的 Log ：</p>
<p><img src="https://i.imgur.com/z91QjIo.jpg" alt="Log"></p>
<p>接著我們在使用 <code>DateRangeComponent</code> 的 Component 裡加上以下程式碼以觀察其運作結果：</p>
<figure class="highlight typescript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ngOnInit(): <span class="hljs-built_in">void</span> &#123;</span><br><span class="line">  <span class="hljs-keyword">this</span>.formGroup = <span class="hljs-keyword">this</span>.formBuilder.group(&#123;</span><br><span class="line">    dateRange: <span class="hljs-string">''</span></span><br><span class="line">  &#125;);</span><br><span class="line">  setTimeout(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'---- 3秒後 ----'</span>);</span><br><span class="line">    <span class="hljs-keyword">this</span>.formGroup?.setValue(&#123; dateRange: <span class="hljs-string">'Leo'</span> &#125;);</span><br><span class="line">    <span class="hljs-keyword">this</span>.formGroup?.disable();</span><br><span class="line">  &#125;, <span class="hljs-number">3000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然後我們會發現：</p>
<p><img src="https://i.imgur.com/62lMvt6.jpg" alt="Log"></p>
<p>這樣大家有比較了解一開始關於 <code>ControlValueAccessor</code> 各函式的說明了嗎？</p>
<p>如果用圖示的話，現在的結構大概像這樣：</p>
<p><img src="https://i.imgur.com/tNv1FWH.jpg" alt="Image 1"></p>
<p>如果我們設值給 <code>FormControl</code> 時，則會觸發 <code>ControlValueAccessor</code> 的函式 <code>writeValue</code> ：</p>
<p><img src="https://i.imgur.com/8yIH9Xi.jpg" alt="Image 2"></p>
<p>如果我們 <code>disable</code> 或 <code>enable</code> 了該 <code>FormControl</code> ，則會觸發 <code>ControlValueAccessor</code> 的函式 <code>setDisabledState</code> ： </p>
<p><img src="https://i.imgur.com/qejX9Uo.jpg" alt="Image 3"></p>
<p>而如果使用者改動了自訂的表單元件的值，則我們自訂的表單元件應該要呼叫透過初始化時所觸發的 <code>registerOnChange</code> 所傳入的 <code>fn</code> 去通知 <code>FormControl</code>：</p>
<p><img src="https://i.imgur.com/7ngKw7A.jpg" alt="Image 4"></p>
<p>讀萬卷書不如行萬里路。接下來，我們把剩下的實作做完就會更了解這其中的運作流程了！</p>
<p>首先，先加工一下使用 <code>DateRangeComponent</code> 的 Component ：</p>
<figure class="highlight typescript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> ReactiveFormsDateRangeComponent <span class="hljs-keyword">implements</span> OnInit &#123;</span><br><span class="line"></span><br><span class="line">  formGroup: FormGroup | <span class="hljs-literal">undefined</span>;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> formBuilder: FormBuilder</span>) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  ngOnInit(): <span class="hljs-built_in">void</span> &#123;</span><br><span class="line">    <span class="hljs-keyword">const</span> date = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>();</span><br><span class="line">    <span class="hljs-keyword">this</span>.formGroup = <span class="hljs-keyword">this</span>.formBuilder.group(&#123;</span><br><span class="line">      dateRange: <span class="hljs-string">`<span class="hljs-subst">$&#123;date.getFullYear()&#125;</span>-<span class="hljs-subst">$&#123;date.getMonth() + <span class="hljs-number">1</span>&#125;</span>-<span class="hljs-subst">$&#123;date.getDate()&#125;</span>`</span></span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  enable(): <span class="hljs-built_in">void</span> &#123;</span><br><span class="line">    <span class="hljs-keyword">this</span>.formGroup?.enable();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  disable(): <span class="hljs-built_in">void</span> &#123;</span><br><span class="line">    <span class="hljs-keyword">this</span>.formGroup?.disable();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Template 的部份也加工一下：</p>
<figure class="highlight html hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">form</span> *<span class="hljs-attr">ngIf</span>=<span class="hljs-string">"formGroup"</span> [<span class="hljs-attr">formGroup</span>]=<span class="hljs-string">"formGroup"</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">app-date-range</span> <span class="hljs-attr">formControlName</span>=<span class="hljs-string">"dateRange"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">app-date-range</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"button"</span> [<span class="hljs-attr">disabled</span>]=<span class="hljs-string">"formGroup.disabled"</span> (<span class="hljs-attr">click</span>)=<span class="hljs-string">"disable()"</span>&gt;</span>DISABLE<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"button"</span> [<span class="hljs-attr">disabled</span>]=<span class="hljs-string">"formGroup.enabled"</span> (<span class="hljs-attr">click</span>)=<span class="hljs-string">"enable()"</span>&gt;</span>ENABLE<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">pre</span>&gt;</span>&#123;&#123; formGroup?.getRawValue() | json &#125;&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">pre</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>然後把 <code>DateRangeComponent</code> 改成這樣：</p>
<figure class="highlight javascript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DateRangeComponent</span> <span class="hljs-title">implements</span> <span class="hljs-title">OnInit</span>, <span class="hljs-title">ControlValueAccessor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  formGroup: FormGroup | <span class="hljs-literal">undefined</span>;</span><br><span class="line"></span><br><span class="line">  fnFormRegisterOnChange: <span class="hljs-function">(<span class="hljs-params">(dateString: string</span>) =&gt;</span> <span class="hljs-keyword">void</span>) | <span class="hljs-literal">undefined</span>;</span><br><span class="line">  fnFormRegisterOnTouched: <span class="hljs-function">(<span class="hljs-params">(</span>) =&gt;</span> <span class="hljs-keyword">void</span>) | <span class="hljs-literal">undefined</span>;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">constructor</span>(private formBuilder: FormBuilder) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  ngOnInit(): <span class="hljs-keyword">void</span> &#123;</span><br><span class="line">    <span class="hljs-keyword">this</span>.formGroup = <span class="hljs-keyword">this</span>.formBuilder.group(&#123;</span><br><span class="line">      startDate: [<span class="hljs-string">''</span>, [Validators.required, Validators.pattern(<span class="hljs-regexp">/^\d&#123;4&#125;-\d&#123;2&#125;-\d&#123;2&#125;$/</span>)]],</span><br><span class="line">      endDate: [<span class="hljs-string">''</span>, Validators.pattern(<span class="hljs-regexp">/^\d&#123;4&#125;-\d&#123;2&#125;-\d&#123;2&#125;$/</span>)]</span><br><span class="line">    &#125;, &#123; <span class="hljs-attr">validators</span>: dateRangeValidator &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">this</span>.formGroup.valueChanges.subscribe(<span class="hljs-function">(<span class="hljs-params">&#123; startDate, endDate &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="hljs-keyword">let</span> dateString = startDate;</span><br><span class="line">      <span class="hljs-keyword">if</span> (endDate) &#123;</span><br><span class="line">        dateString += <span class="hljs-string">`, <span class="hljs-subst">$&#123;endDate&#125;</span>`</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.formGroup?.errors) &#123;</span><br><span class="line">        dateString = <span class="hljs-string">''</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.fnFormRegisterOnChange) &#123;</span><br><span class="line">        <span class="hljs-keyword">this</span>.fnFormRegisterOnChange(dateString);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  writeValue(dateRangeString: string): <span class="hljs-keyword">void</span> &#123;</span><br><span class="line">    <span class="hljs-keyword">const</span> [startDate, endDate] = dateRangeString.split(<span class="hljs-string">', '</span>);</span><br><span class="line">    <span class="hljs-keyword">this</span>.formGroup?.patchValue(&#123; startDate, endDate &#125;, &#123;</span><br><span class="line">      emitEvent: <span class="hljs-literal">false</span></span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  registerOnChange(fn: <span class="hljs-function">(<span class="hljs-params">dateRangeString: string</span>) =&gt;</span> <span class="hljs-keyword">void</span>): <span class="hljs-keyword">void</span> &#123;</span><br><span class="line">    <span class="hljs-keyword">this</span>.fnFormRegisterOnChange = fn;</span><br><span class="line">  &#125;</span><br><span class="line">  registerOnTouched(fn: <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> <span class="hljs-keyword">void</span>): <span class="hljs-keyword">void</span> &#123;</span><br><span class="line">    <span class="hljs-keyword">this</span>.fnFormRegisterOnTouched = fn;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  setDisabledState(isDisabled: boolean): <span class="hljs-keyword">void</span> &#123;</span><br><span class="line">    <span class="hljs-keyword">if</span> (isDisabled) &#123;</span><br><span class="line">      <span class="hljs-keyword">this</span>.formGroup?.disable();</span><br><span class="line">    &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">      <span class="hljs-keyword">this</span>.formGroup?.enable();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>結果：</p>
<p><img src="https://i.imgur.com/mC3qQlg.gif" alt="Result"></p>
<blockquote>
<p>對了，這樣的作法不僅僅只適用於 Reactive Forms 噢！大家可以在使用 <code>DateRangeComponent</code> 的時候用 Template Driven Forms 的方式試試看，也是行得通的唷！</p>
</blockquote>
<h2 id="本日小結"><a href="#本日小結" class="headerlink" title="本日小結"></a>本日小結</h2><p>今天的實作練習應該滿好玩的吧？</p>
<p>我能理解大家第一次碰到的時候都會比較難以理解，記得我第一次碰到的時候，也只是複製人家的程式碼然後貼上而已，根本就不是了解其運作原理。</p>
<p>因此，希望我今天的文章能讓大家可以不僅僅只是複製貼上，而是對於其流程與原理有所掌握與理解。</p>
<p>今天的程式碼會放在 <a href="https://github.com/leochen0818/angular-30days-form-and-testing/tree/day28" target="_blank" rel="noopener">Github - Branch: day28</a> 上供大家參考，建議大家在看我的實作之前，先按照需求規格自己做一遍，之後再跟我的對照，看看自己的實作跟我的實作不同的地方在哪裡、有什麼好處與壞處，如此反覆咀嚼消化後，我相信你一定可以進步地非常快！</p>
<p>如果有任何的問題或是回饋，還請麻煩留言給我讓我知道！</p>

        </div>
        
        
        
    </div>
</div>








    <div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2021-10-12T01:14:51.000Z">2021-10-12</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/Web-前端/">Web 前端</a>&nbsp;/&nbsp;<a class="has-link-grey -link" href="/categories/Web-前端/iThome2021鐵人賽/">iThome2021鐵人賽</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    21 分鐘 閱讀文 (大約 3089 個字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2021/10/12/angular-30days-form-and-test-27/">Angular 深入淺出三十天：表單與測試 Day27 - Reactive Forms 進階技巧 - 跨欄位驗證</a>
            
        </h1>
        <div class="content">
            <p><img src="https://i.imgur.com/EOYJ6Cc.jpg" alt="Day27"></p>
<p>今天想要跟大家分享的是<strong>跨欄位驗證</strong>的小技巧，這個小技巧其實沒有多厲害或多特別，只是可能滿多人剛好不知道原來可以這樣用。</p>
<p>而我們在 <a href="https://ithelp.ithome.com.tw/articles/10279151" target="_blank" rel="noopener">Day 23 - Reactive Forms 進階技巧 - 欄位連動檢核邏輯</a> 所分享過欄位連動檢核邏輯的部份，就某方面來說，其實也可以使用這種方式來做，但究竟要適不適合、要不要使用，我覺得一切都還是要看需求、看想給使用者什麼樣的使用體驗來決定。</p>
<p>畢竟系統是為了服務需求而存在，至於能不能做到、能不能解決問題就看工程師的功力囉。</p>
<h2 id="實作開始"><a href="#實作開始" class="headerlink" title="實作開始"></a>實作開始</h2><p>言歸正傳，我們今天要做的功能是<strong>起迄日</strong>的<strong>日期欄位檢核</strong></p>
<blockquote>
<p>感謝我的朋友 ─ Joseph 所提供的案例<del>讓我多活了一天</del>。</p>
</blockquote>
<h3 id="規格需求"><a href="#規格需求" class="headerlink" title="規格需求"></a>規格需求</h3><p>詳細規格需求如下：</p>
<ul>
<li>起日<ul>
<li>必填，驗證有誤時需顯示錯誤訊息： <code>此欄位必填</code> </li>
<li>格式需為 <code>yyyy-MM-dd</code> ，驗證有誤時需顯示錯誤訊息： <code>日期格式不正確</code></li>
<li>需為確切存在的日期，驗證有誤時需顯示錯誤訊息： <code>此日期不存在</code> </li>
</ul>
</li>
<li>迄日<ul>
<li>非必填</li>
<li>格式需為 <code>yyyy-MM-dd</code> ，驗證有誤時需顯示錯誤訊息： <code>日期格式不正確</code></li>
<li>需為確切存在的日期，驗證有誤時需顯示錯誤訊息： <code>此日期不存在</code> </li>
<li>迄日不可早於起日，驗證有誤時需顯示錯誤訊息： <code>迄日不可早於起日</code> </li>
<li>迄日不可晚於起日超過七天，驗證有誤時需顯示錯誤訊息： <code>迄日不可晚於起日超過七天</code> </li>
</ul>
</li>
<li>以上驗證皆需在使用者輸入時動態檢查</li>
</ul>
<h3 id="準備畫面"><a href="#準備畫面" class="headerlink" title="準備畫面"></a>準備畫面</h3><p>接下來我們先把畫面準備好， HTML 如下：</p>
<figure class="highlight html hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">form</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">for</span>=<span class="hljs-string">"start-date"</span>&gt;</span>起日：<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"start-date"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"yyyy-mm-dd"</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">for</span>=<span class="hljs-string">"end-date"</span>&gt;</span>迄日：<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"end-date"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"yyyy-mm-dd"</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>畫面應該會長這樣：</p>
<p><img src="https://i.imgur.com/vM2x2KG.jpg" alt="Template View"></p>
<blockquote>
<p>我知道一般大家在實作的時候會用漂亮的 UI 套件，不過我們現在主要聚焦在功能面，所以欄位的部份我只用簡單的 <code>&lt;input type=&quot;text&quot;&gt;</code> 的方式實作。</p>
<p>其實我本來想至少用 <code>&lt;input type=&quot;date&quot;&gt;</code> 來實作的，但它會害我們無法判斷使用者到底有沒有輸入值，所以最後還是放棄了使用它的打算。</p>
</blockquote>
<h3 id="準備-FormGroup"><a href="#準備-FormGroup" class="headerlink" title="準備 FormGroup"></a>準備 FormGroup</h3><p>接著把 Reactive Forms 的 <code>FormGroup</code> 也準備好：</p>
<figure class="highlight typescript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> ReactiveFormsDateRangeComponent <span class="hljs-keyword">implements</span> OnInit &#123;</span><br><span class="line"></span><br><span class="line">  formGroup: FormGroup | <span class="hljs-literal">undefined</span>;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> formBuilder: FormBuilder</span>) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  ngOnInit(): <span class="hljs-built_in">void</span> &#123;</span><br><span class="line">    <span class="hljs-keyword">this</span>.formGroup = <span class="hljs-keyword">this</span>.formBuilder.group(&#123;</span><br><span class="line">      startDate: [</span><br><span class="line">        <span class="hljs-string">''</span>, [</span><br><span class="line">          Validators.required,</span><br><span class="line">          Validators.pattern(<span class="hljs-regexp">/^\d&#123;4&#125;-\d&#123;2&#125;-\d&#123;2&#125;$/</span>)</span><br><span class="line">        ]</span><br><span class="line">      ],</span><br><span class="line">      endDate: [<span class="hljs-string">''</span>, Validators.pattern(<span class="hljs-regexp">/^\d&#123;4&#125;-\d&#123;2&#125;-\d&#123;2&#125;$/</span>)]</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>其實這邊的 <code>Validators.required</code> 與 <code>Validators.pattern(/^\d{4}-\d{2}-\d{2}$/)</code> 可以不加，只不過後續就要把判斷寫在另一個地方，看大家想要稍稍彈性一點，還是直接寫死在另外一個地方都可以。</p>
</blockquote>
<p>然後綁定到 Template 的表單上：</p>
<figure class="highlight html hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">form</span> *<span class="hljs-attr">ngIf</span>=<span class="hljs-string">"formGroup"</span> [<span class="hljs-attr">formGroup</span>]=<span class="hljs-string">"formGroup"</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">for</span>=<span class="hljs-string">"start-date"</span>&gt;</span>起日：<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"start-date"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"yyyy-mm-dd"</span> <span class="hljs-attr">formControlName</span>=<span class="hljs-string">"startDate"</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">for</span>=<span class="hljs-string">"end-date"</span>&gt;</span>迄日：<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"end-date"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"yyyy-mm-dd"</span> <span class="hljs-attr">formControlName</span>=<span class="hljs-string">"endDate"</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>再次提醒大家，在使用 Reactive Forms 的方式來開發表單時，請記得到 <code>.module.ts</code> 裡的引入 <code>FormsModule</code> 與 <code>ReactiveFormsModule</code></p>
<p>大家不要覺得我像老頭子一樣囉哩囉嗦的，都已經做了幾次的練習了還要一直提醒大家記得引入 <code>FormsModule</code> 和 <code>ReactiveFormsModule</code> 。</p>
<p>相信我，如果我沒提醒，一定會有很多還不是很熟悉的朋友會卡住。</p>
<p>所以大家互相體諒包容一下，熟悉的朋友快速略過就好。</p>
</blockquote>
<h3 id="自訂驗證器-─-dateRangeValidator"><a href="#自訂驗證器-─-dateRangeValidator" class="headerlink" title="自訂驗證器 ─ dateRangeValidator"></a>自訂驗證器 ─ dateRangeValidator</h3><p>接著我們來用昨天分享過的自訂驗證器的的技巧來自訂一個名為 <code>dateRangeValidator</code> 的驗證器，程式碼如下：</p>
<figure class="highlight typescript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> dateRangeValidator: ValidatorFn = <span class="hljs-function">(<span class="hljs-params">formGroup</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="hljs-built_in">console</span>.log(formGroup.value);</span><br><span class="line">  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>先把它掛在 FormGroup 上：</p>
<figure class="highlight typescript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">this</span>.formGroup = <span class="hljs-keyword">this</span>.formBuilder.group(&#123;</span><br><span class="line">  startDate: [</span><br><span class="line">    <span class="hljs-string">''</span>, [</span><br><span class="line">      Validators.required,</span><br><span class="line">      Validators.pattern(<span class="hljs-regexp">/^\d&#123;4&#125;-\d&#123;2&#125;-\d&#123;2&#125;$/</span>)</span><br><span class="line">    ]</span><br><span class="line">  ],</span><br><span class="line">  endDate: [<span class="hljs-string">''</span>, Validators.pattern(<span class="hljs-regexp">/^\d&#123;4&#125;-\d&#123;2&#125;-\d&#123;2&#125;$/</span>)]</span><br><span class="line">&#125;, &#123; validators: dateRangeValidator &#125;);</span><br></pre></td></tr></table></figure>

<p>然後我們就可以在控制台裡看到 ─ 當 FormGroup 裡的欄位的值有變動時，就會觸發我們自訂的驗證器：</p>
<p><img src="https://i.imgur.com/vuMi83r.gif" alt="Template View"></p>
<blockquote>
<p>一開始的四個 <code>{ startDate: &#39;&#39;, endDate: &#39;&#39; }</code> 是 FormGroup 在初始化的時後所觸發的。</p>
</blockquote>
<p>其實今天要做的這個功能最關鍵、最重要的兩件事情就是：</p>
<ol>
<li>實作自訂驗證器</li>
<li>把它掛在 FormGroup 上</li>
</ol>
<p><del>所以我們已經做完了，今天的文章就分享到這邊。</del></p>
<blockquote>
<p>謎之音：喂！你給我回來！（抓回）</p>
</blockquote>
<p>接下來在實作驗證器之前，我想先制定該驗證器在驗證有誤時，所要回傳的 <code>ValidationErrors</code> 格式。</p>
<h4 id="制定驗證器的-ValidationErrors"><a href="#制定驗證器的-ValidationErrors" class="headerlink" title="制定驗證器的 ValidationErrors"></a>制定驗證器的 ValidationErrors</h4><p>之所以想要先制定 <code>ValidationErrors</code> 的格式，一方面是因為待會實作驗證邏輯的時候需要用到；另一方面則是因為這個格式如果訂得好，後續實作時會輕鬆許多。</p>
<p>我的預期是這樣：</p>
<figure class="highlight typescript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123; </span><br><span class="line">  dateRange: &#123;</span><br><span class="line">    startDate: <span class="hljs-literal">null</span> | ValidationErrors;</span><br><span class="line">    endDate: <span class="hljs-literal">null</span> | ValidationErrors;</span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>這樣制定的意思是，如果起日欄位沒有錯誤，則 <code>dateRange.startDate</code> 的值會是 <code>null</code> ；而如果迄日欄位沒有錯誤，則 <code>dateRange.endDate</code> 的值會是 <code>null</code> ；又如果兩個欄位都沒錯誤，則該驗證器就會直接回傳 <code>null</code> 。</p>
<p>反之，如果起日欄位有錯誤，則 <code>dateRange.startDate</code> 的值會是我們接下來要制定的錯誤；迄日欄位亦然。</p>
<p>如此一來，如果驗證有誤時，我們比較能夠從驗證器所回傳的 <code>ValidationErrors</code> 來解析是哪個欄位有誤。</p>
<p>而 <code>dateRange.startDate</code> 與 <code>dateRange.endDate</code> 究竟會有哪些錯誤呢？</p>
<p>先複習一下規格：</p>
<ul>
<li>起日<ul>
<li>必填，驗證有誤時需顯示錯誤訊息： <code>此欄位必填</code> </li>
<li>格式需為 <code>yyyy-MM-dd</code> ，驗證有誤時需顯示錯誤訊息： <code>日期格式不正確</code></li>
<li>需為確切存在的日期，驗證有誤時需顯示錯誤訊息： <code>此日期不存在</code> </li>
</ul>
</li>
<li>迄日<ul>
<li>非必填</li>
<li>格式需為 <code>yyyy-MM-dd</code> ，驗證有誤時需顯示錯誤訊息： <code>日期格式不正確</code></li>
<li>需為確切存在的日期，驗證有誤時需顯示錯誤訊息： <code>此日期不存在</code> </li>
<li>迄日不可早於起日，驗證有誤時需顯示錯誤訊息： <code>迄日不可早於起日</code> </li>
<li>迄日不可晚於起日超過七天，驗證有誤時需顯示錯誤訊息： <code>迄日不可晚於起日超過七天</code> </li>
</ul>
</li>
</ul>
<p>除了必填與日期格式的部份已經用官方提供的 Validator 外，其他的錯誤應該就剩下：</p>
<ol>
<li><p>不存在的日期：</p>
 <figure class="highlight typescript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  inexistentDate: <span class="hljs-literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>迄日早於起日：</p>
 <figure class="highlight typescript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  lessThanStartDate: <span class="hljs-literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>迄日晚於起日七天</p>
 <figure class="highlight typescript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  greaterThanStartDate: &#123;</span><br><span class="line">    actualGreater: <span class="hljs-number">8</span></span><br><span class="line">    requiredGreater: <span class="hljs-number">7</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<blockquote>
<p>以上格式是我自訂的，大家可以不用跟我一樣沒關係。</p>
</blockquote>
<p>接著我們可以把錯誤訊息稍微訂個 <code>type</code> ，以便後續使用：</p>
<figure class="highlight typescript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> DateRangeValidationErrors = &#123;</span><br><span class="line">  dateRange: &#123;</span><br><span class="line">    startDate: <span class="hljs-literal">null</span> | DateErrors;</span><br><span class="line">    endDate: <span class="hljs-literal">null</span> | DateErrors;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> DateErrors =</span><br><span class="line">  | RequiredError</span><br><span class="line">  | PatternError</span><br><span class="line">  | InexistentDateError</span><br><span class="line">  | LessThanStartDateError</span><br><span class="line">  | GreaterThanStartDateError</span><br><span class="line">  | ValidationErrors;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> RequiredError = &#123;</span><br><span class="line">  required: <span class="hljs-literal">true</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> PatternError = &#123;</span><br><span class="line">  pattern: &#123;</span><br><span class="line">    actualValue: <span class="hljs-built_in">string</span>;</span><br><span class="line">    requiredPattern: <span class="hljs-built_in">string</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> InexistentDateError = &#123;</span><br><span class="line">  inexistentDate: <span class="hljs-literal">true</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> LessThanStartDateError = &#123;</span><br><span class="line">  lessThanStartDate: <span class="hljs-literal">true</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> GreaterThanStartDateError = &#123;</span><br><span class="line">  greaterThanStartDate: &#123;</span><br><span class="line">    actualGreater: <span class="hljs-built_in">number</span>;</span><br><span class="line">    requiredGreater: <span class="hljs-built_in">number</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>如此一來，我們差不多就可以開始來寫驗證器的邏輯囉！</p>
<h4 id="實作驗證器的邏輯"><a href="#實作驗證器的邏輯" class="headerlink" title="實作驗證器的邏輯"></a>實作驗證器的邏輯</h4><p>首先，我們先處理判斷使用者所輸入的日期是否真實存在的邏輯。</p>
<p>舉例來說，大家覺得 <code>2021-02-29</code> 這個日期是存在的嗎？大家應該翻一下年曆就會知道，今年不是閏年，所以二月不會有第二十九天。</p>
<p>但是如果單純用 <code>Date</code> 來判斷，它其實可以算得出來：</p>
<figure class="highlight javascript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-built_in">console</span>.log(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(<span class="hljs-string">'2021-02-29'</span>));</span><br><span class="line"><span class="hljs-comment">// Mon Mar 01 2021 08:00:00 GMT+0800 (Taipei Standard Time)</span></span><br></pre></td></tr></table></figure>

<p>那 <code>2021-02-31</code> 呢？</p>
<figure class="highlight javascript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-built_in">console</span>.log(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(<span class="hljs-string">'2021-02-31'</span>));</span><br><span class="line"><span class="hljs-comment">// Mon Mar 03 2021 08:00:00 GMT+0800 (Taipei Standard Time)</span></span><br></pre></td></tr></table></figure>

<p>為什麼會這樣呢？</p>
<p>以上述例子來說， 用字串來建立 <code>Date</code> 的時候，它只會幫我們驗證兩件事情：</p>
<ol>
<li>月份不可以超過 <code>12</code></li>
<li>日期不可以超過 <code>31</code></li>
</ol>
<p>只要合乎上述這兩件事情，它就不會是 <code>Invalid Date</code> 。</p>
<blockquote>
<p>那年份呢？我很無聊的幫大家試了一下，可以到 <code>275759</code> 年唷！</p>
</blockquote>
<p>為了處理這件事情，我很偷懶的 Google 了一下大家的解法，最後借用了 <a href="https://cythilya.github.io/" target="_blank" rel="noopener">Summer。桑莫。夏天</a>的 <a href="https://cythilya.github.io/2017/05/19/javascript-is-date-exist/" target="_blank" rel="noopener">JavaScript：檢查日期是否存在</a>文中的程式碼，並且稍稍調整了一下以符合我的需求：</p>
<figure class="highlight typescript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> isDateExist = <span class="hljs-function">(<span class="hljs-params">dateString: <span class="hljs-built_in">string</span></span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="hljs-keyword">const</span> dateObj = dateString.split(<span class="hljs-string">'-'</span>); <span class="hljs-comment">// yyyy-mm-dd</span></span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">//列出12個月，每月最大日期限制</span></span><br><span class="line">  <span class="hljs-keyword">const</span> limitInMonth = [<span class="hljs-number">31</span>, <span class="hljs-number">28</span>, <span class="hljs-number">31</span>, <span class="hljs-number">30</span>, <span class="hljs-number">31</span>, <span class="hljs-number">30</span>, <span class="hljs-number">31</span>, <span class="hljs-number">31</span>, <span class="hljs-number">30</span>, <span class="hljs-number">31</span>, <span class="hljs-number">30</span>, <span class="hljs-number">31</span>];</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">const</span> theYear = <span class="hljs-built_in">parseInt</span>(dateObj[<span class="hljs-number">0</span>]);</span><br><span class="line">  <span class="hljs-keyword">const</span> theMonth = <span class="hljs-built_in">parseInt</span>(dateObj[<span class="hljs-number">1</span>]);</span><br><span class="line">  <span class="hljs-keyword">const</span> theDay = <span class="hljs-built_in">parseInt</span>(dateObj[<span class="hljs-number">2</span>]);</span><br><span class="line">  <span class="hljs-keyword">const</span> isLeap = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(theYear, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>).getDate() === <span class="hljs-number">29</span>; <span class="hljs-comment">// 是否為閏年?</span></span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">if</span> (isLeap) &#123;</span><br><span class="line">    <span class="hljs-comment">// 若為閏年，最大日期限制改為 29</span></span><br><span class="line">    limitInMonth[<span class="hljs-number">1</span>] = <span class="hljs-number">29</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">// 月份不可以大於 12， 並比對該日是否超過每個月份最大日期限制</span></span><br><span class="line">  <span class="hljs-keyword">return</span> theMonth &lt; <span class="hljs-number">12</span> &amp;&amp; theDay &lt;= limitInMonth[theMonth - <span class="hljs-number">1</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>感謝每一個願意分享的朋友。</p>
</blockquote>
<p>準備萬全之後，再來就是把驗證器的判斷邏輯補完：</p>
<figure class="highlight typescript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> dateRangeValidator: ValidatorFn = <span class="hljs-function">(<span class="hljs-params">formGroup</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="hljs-keyword">const</span> startDateControl = formGroup.get(<span class="hljs-string">'startDate'</span>)!;</span><br><span class="line">  <span class="hljs-keyword">const</span> endDateControl = formGroup.get(<span class="hljs-string">'endDate'</span>)!;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">let</span> errors: DateRangeValidationErrors = &#123;</span><br><span class="line">    dateRange: &#123;</span><br><span class="line">      startDate: <span class="hljs-literal">null</span>,</span><br><span class="line">      endDate: <span class="hljs-literal">null</span>,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  </span><br><span class="line">  <span class="hljs-keyword">if</span> (startDateControl.errors) &#123;</span><br><span class="line">    errors.dateRange.startDate = startDateControl.errors;</span><br><span class="line">  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!isDateExist(startDateControl.value)) &#123;</span><br><span class="line">    errors.dateRange.startDate = &#123; inexistentDate: <span class="hljs-literal">true</span> &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">if</span> (endDateControl.errors) &#123;</span><br><span class="line">    errors.dateRange.endDate = endDateControl.errors;</span><br><span class="line">  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (endDateControl.value) &#123;</span><br><span class="line">    <span class="hljs-keyword">if</span> (!isDateExist(endDateControl.value)) &#123;</span><br><span class="line">      errors.dateRange.endDate = &#123; inexistentDate: <span class="hljs-literal">true</span> &#125;;</span><br><span class="line">    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!errors.dateRange.startDate) &#123;</span><br><span class="line">      <span class="hljs-keyword">const</span> startDateTimeStamp = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(startDateControl.value).getTime();</span><br><span class="line">      <span class="hljs-keyword">const</span> endDateTimeStamp = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(endDateControl.value).getTime();</span><br><span class="line">      <span class="hljs-keyword">const</span> dayInMilliseconds = <span class="hljs-number">24</span> * <span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>;</span><br><span class="line">      <span class="hljs-keyword">const</span> duration = <span class="hljs-number">7</span> * dayInMilliseconds;</span><br><span class="line">      <span class="hljs-keyword">if</span> (endDateTimeStamp &lt; startDateTimeStamp) &#123;</span><br><span class="line">        errors.dateRange.endDate = &#123; lessThanStartDate: <span class="hljs-literal">true</span> &#125;;</span><br><span class="line">      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (endDateTimeStamp - duration &gt; startDateTimeStamp) &#123;</span><br><span class="line">        errors.dateRange.endDate = &#123;</span><br><span class="line">          greaterThanStartDate: &#123;</span><br><span class="line">            actualGreater: (endDateTimeStamp - startDateTimeStamp) / dayInMilliseconds,</span><br><span class="line">            requiredGreater: <span class="hljs-number">7</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">if</span> (!errors.dateRange.startDate &amp;&amp; !errors.dateRange.endDate) &#123;</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="hljs-keyword">return</span> errors;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>結果：</p>
<p><img src="https://i.imgur.com/932bOqf.gif" alt="Template View"></p>
<p>看起來效果不錯，接下來就是把錯誤訊息接上囉！</p>
<h3 id="ErrorMessagePipe"><a href="#ErrorMessagePipe" class="headerlink" title="ErrorMessagePipe"></a>ErrorMessagePipe</h3><p>關於錯誤訊息的部份，今天就不把邏輯寫到 Component 的 <code>.ts</code> 裡了，來做個 ErrorMessagePipe 吧！</p>
<p>程式碼如下：</p>
<figure class="highlight typescript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">@Pipe</span>(&#123;</span><br><span class="line">  name: <span class="hljs-string">'errorMessage'</span>,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> ErrorMessagePipe <span class="hljs-keyword">implements</span> PipeTransform &#123;</span><br><span class="line">  transform(errors: <span class="hljs-literal">null</span> | DateErrors, ...args: unknown[]): <span class="hljs-built_in">string</span> &#123;</span><br><span class="line">    <span class="hljs-keyword">if</span> (errors) &#123;</span><br><span class="line">      <span class="hljs-keyword">if</span> ((errors <span class="hljs-keyword">as</span> RequiredError).required) &#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-string">'此欄位必填'</span>;</span><br><span class="line">      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((errors <span class="hljs-keyword">as</span> PatternError).pattern) &#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-string">'日期格式不正確'</span>;</span><br><span class="line">      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((errors <span class="hljs-keyword">as</span> InexistentDateError).inexistentDate) &#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-string">'此日期不存在'</span>;</span><br><span class="line">      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((errors <span class="hljs-keyword">as</span> LessThanStartDateError).lessThanStartDate) &#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-string">'迄日不可早於起日'</span>;</span><br><span class="line">      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((errors <span class="hljs-keyword">as</span> GreaterThanStartDateError).greaterThanStartDate) &#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-string">'迄日不可晚於起日超過七天'</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接著再到 Template 將其接上：</p>
<figure class="highlight html hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Reactive Forms 進階技巧 ─ 跨欄位驗證<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">form</span> *<span class="hljs-attr">ngIf</span>=<span class="hljs-string">"formGroup"</span> [<span class="hljs-attr">formGroup</span>]=<span class="hljs-string">"formGroup"</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">for</span>=<span class="hljs-string">"start-date"</span>&gt;</span>起日：<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">input</span></span></span><br><span class="line"><span class="hljs-tag">      <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span></span></span><br><span class="line"><span class="hljs-tag">      <span class="hljs-attr">id</span>=<span class="hljs-string">"start-date"</span></span></span><br><span class="line"><span class="hljs-tag">      <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"yyyy-mm-dd"</span></span></span><br><span class="line"><span class="hljs-tag">      <span class="hljs-attr">formControlName</span>=<span class="hljs-string">"startDate"</span></span></span><br><span class="line"><span class="hljs-tag">    /&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">span</span></span></span><br><span class="line"><span class="hljs-tag">      <span class="hljs-attr">class</span>=<span class="hljs-string">"error-message"</span></span></span><br><span class="line"><span class="hljs-tag">      *<span class="hljs-attr">ngIf</span>=<span class="hljs-string">"formGroup.errors &amp;&amp; formGroup.dirty"</span></span></span><br><span class="line"><span class="hljs-tag">    &gt;</span></span><br><span class="line">      &#123;&#123; formGroup.errors.dateRange.startDate | errorMessage &#125;&#125;</span><br><span class="line">    <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">for</span>=<span class="hljs-string">"end-date"</span>&gt;</span>迄日：<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">input</span></span></span><br><span class="line"><span class="hljs-tag">      <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span></span></span><br><span class="line"><span class="hljs-tag">      <span class="hljs-attr">id</span>=<span class="hljs-string">"end-date"</span></span></span><br><span class="line"><span class="hljs-tag">      <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"yyyy-mm-dd"</span></span></span><br><span class="line"><span class="hljs-tag">      <span class="hljs-attr">formControlName</span>=<span class="hljs-string">"endDate"</span></span></span><br><span class="line"><span class="hljs-tag">    /&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">span</span></span></span><br><span class="line"><span class="hljs-tag">      <span class="hljs-attr">class</span>=<span class="hljs-string">"error-message"</span></span></span><br><span class="line"><span class="hljs-tag">      *<span class="hljs-attr">ngIf</span>=<span class="hljs-string">"formGroup.errors &amp;&amp; formGroup.dirty"</span></span></span><br><span class="line"><span class="hljs-tag">    &gt;</span></span><br><span class="line">      &#123;&#123; formGroup.errors.dateRange.endDate | errorMessage &#125;&#125;</span><br><span class="line">    <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>最終成果：</p>
<p><img src="https://i.imgur.com/CYEtNZO.gif" alt="Template View"></p>
<h2 id="本日小結"><a href="#本日小結" class="headerlink" title="本日小結"></a>本日小結</h2><p>今天主要想告訴大家的是 <code>FormGroup</code> 、 <code>FormArray</code> 以及 <code>FormControl</code> 其實都可以設定 <code>Validator</code> 與 <code>AsyncValidator</code> ，不管是在初始化時就設定還是初始化後再動態設定都沒問題。</p>
<p>但可能是因為沒有遇過需要用到的場景，所以滿多對 Reactive Forms 還不太熟的朋友還是會不知道。</p>
<p>雖說今天主要想讓大家的知道的是 <code>FormGroup</code> 上也可以設定 <code>Validator</code> 與 <code>AsyncValidator</code> ，但寫著寫著又不知不覺寫了很多東西，希望這些東西都有幫助到大家。</p>
<p>此外， Template Driven Forms 當然也是可以跨欄位驗證，不過由於之前已經說過不會再分享 Template Driven Forms 的關係，所以有興趣的朋友可以參考官方的 <a href="https://angular.io/guide/form-validation#adding-cross-validation-to-template-driven-forms" target="_blank" rel="noopener">Form Validation - Adding cross-validation to template-driven forms</a> 的文件。</p>
<blockquote>
<p>早知道就不要說不再分享，害自己少了好多篇可以寫，失策！</p>
<p>對了，測試大家可以練習寫寫看，我就不實作給大家看囉！</p>
</blockquote>
<p>今天的程式碼會放在 <a href="https://github.com/leochen0818/angular-30days-form-and-testing/tree/day27" target="_blank" rel="noopener">Github - Branch: day27</a> 上供大家參考，建議大家在看我的實作之前，先按照需求規格自己做一遍，之後再跟我的對照，看看自己的實作跟我的實作不同的地方在哪裡、有什麼好處與壞處，如此反覆咀嚼消化後，我相信你一定可以進步地非常快！</p>
<p>如果有任何的問題或是回饋，還請麻煩留言給我讓我知道！</p>

        </div>
        
        
        
    </div>
</div>








    <div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2021-10-11T11:32:17.000Z">2021-10-11</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/Web-前端/">Web 前端</a>&nbsp;/&nbsp;<a class="has-link-grey -link" href="/categories/Web-前端/iThome2021鐵人賽/">iThome2021鐵人賽</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    12 分鐘 閱讀文 (大約 1774 個字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2021/10/11/angular-30days-form-and-test-26/">Angular 深入淺出三十天：表單與測試 Day26 - 進階表單開發技巧 - 自訂驗證器</a>
            
        </h1>
        <div class="content">
            <p><img src="https://i.imgur.com/FtIne6K.jpg" alt="Day26"></p>
<p>之前在開發表單的時候，我們都是使用 <a href="https://angular.tw/api/forms/Validators" target="_blank" rel="noopener">Angular 所提供的驗證器</a>來驗證表單欄位裡的值是否符合我們的需求。</p>
<p>雖然 Angular 已經這麼貼心地提供了這麼多驗證了，但每個國家、地區的人文風土民情都不同，還有太多太多需要我們自己自訂規則才能符合需求的情況。</p>
<p>因此，今天我們就一起來看看要怎麼自訂驗證器吧！</p>
<h2 id="自訂驗證器的型別"><a href="#自訂驗證器的型別" class="headerlink" title="自訂驗證器的型別"></a>自訂驗證器的型別</h2><p>既然要自訂驗證器，就不能不知道驗證器的型別與其定義。</p>
<blockquote>
<p>其實之前在第三天的文章：<a href="https://ithelp.ithome.com.tw/articles/10266617" target="_blank" rel="noopener">Reactive Forms 實作 - 以登入為例</a> 裡就有提到驗證器的型別。</p>
</blockquote>
<h3 id="ValidatorFn"><a href="#ValidatorFn" class="headerlink" title="ValidatorFn"></a>ValidatorFn</h3><p>驗證器的型別是 <code>ValidatorFn</code> ，其原始碼定義如下：</p>
<figure class="highlight typescript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">interface</span> ValidatorFn &#123;</span><br><span class="line">  (control: AbstractControl): ValidationErrors | <span class="hljs-literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>從定義中我們可以知道，驗證器其實就只是一個函式，該函式會傳入一個型別為 <code>AbstractControl</code> 的參數來讓我們在函式中判定該欄位的值是否符合我們的需求。</p>
<p>如果驗證結果符合需求，那就回傳 <code>null</code> ，代表沒有任何的錯誤；如果驗證結果不符合需求那就回傳一個型別為 <code>ValidationErrors</code> 的錯誤。</p>
<p>那 <code>ValidationErrors</code> 又是什麼呢？</p>
<h3 id="ValidationErrors"><a href="#ValidationErrors" class="headerlink" title="ValidationErrors"></a>ValidationErrors</h3><p><code>ValidationErrors</code> 之前最早是在第二天的文章： <a href="https://ithelp.ithome.com.tw/articles/10265809" target="_blank" rel="noopener">Template Driven Forms 實作 - 以登入為例</a> 裡登場。</p>
<p>其原始碼定義如下：</p>
<figure class="highlight typescript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">type</span> ValidationErrors = &#123;</span><br><span class="line">    [key: <span class="hljs-built_in">string</span>]: <span class="hljs-built_in">any</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>沒錯，你沒看錯，就是這麼簡單！</p>
<p>從定義上看起來，基本上只要是個<strong>物件</strong>，就符合該型別的要求，而這也是因為滿足客製的條件，讓使用 Angular 的開發者有程度的規範但擁有盡可能大的彈性。</p>
<p>不過雖然大家可以隨意自訂，但我非常建議大家在自訂的時候可以參考官方的驗證器。</p>
<p>舉例來說，官方的 <code>Validators.required</code> 驗證器在驗證有誤時，會回傳的 <code>ValidationErrors</code> 是：</p>
<figure class="highlight typescript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; required: <span class="hljs-literal">true</span> &#125;</span><br></pre></td></tr></table></figure>

<p>而 <code>Validators.pattern</code> 驗證器在驗證有誤時，會回傳的 <code>ValidationErrors</code> 是：</p>
<figure class="highlight typescript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123; </span><br><span class="line">  actualValue: <span class="hljs-string">'xxx'</span>,</span><br><span class="line">  requiredPattern: <span class="hljs-string">'xxx'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Validators.minlength</code> 跟 <code>Validators.minlength</code> 驗證器在驗證有誤時，則會回傳：</p>
<figure class="highlight javascript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  actualLength: <span class="hljs-number">1</span>,</span><br><span class="line">  requiredLength: <span class="hljs-number">2</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我們從中不難發現官方會在 <code>ValidationErrors</code> 中，回傳該欄位當前的狀態以及需求的狀態；而物件的屬性名稱也會按照 <code>actual</code> 加上 <code>XXXX</code> 以及 <code>required</code> 加上 <code>XXXX</code> 的方式來命名。</p>
<p>雖然具體上還是要看實際需求，但我個人覺得我們自己在自訂驗證器的 <code>ValidationErrors</code> 時，也可以照著這個規則來處理。</p>
<p>一方面，整個系統會比較一致；另一方面，也不需要多寫太多額外的程式來處理我們自訂的錯誤。</p>
<p>舉個例子，如果我們想自訂一個欄位的值只能是 <code>Leo</code> 的驗證器，其程式碼可能會像是這樣：</p>
<figure class="highlight typescript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">export</span> leoValidator: ValidatorFn = <span class="hljs-function">(<span class="hljs-params">control: AbstractControl</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="hljs-keyword">const</span> isLeo = control.value === <span class="hljs-string">'Leo'</span>;</span><br><span class="line">  <span class="hljs-keyword">if</span> (isLeo) &#123;</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="hljs-keyword">return</span> &#123; </span><br><span class="line">    actualValue: control.value, </span><br><span class="line">    requiredValue: <span class="hljs-string">'Leo'</span></span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>如此我們就在需要用到它時，直接像這樣使用即可：</p>
<figure class="highlight typescript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">new</span> FormControl(<span class="hljs-string">''</span>, leoValidator);</span><br></pre></td></tr></table></figure>

<p>又或者是彈性一點，讓使用它的人來決定該欄位的值只能是什麼，其程式碼應該會像是這樣：</p>
<figure class="highlight typescript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">nameValidator</span>(<span class="hljs-params">name: <span class="hljs-built_in">string</span></span>): <span class="hljs-title">ValidatorFn</span> </span>&#123;</span><br><span class="line">  <span class="hljs-keyword">return</span> (control: AbstractControl): ValidationErrors | <span class="hljs-function"><span class="hljs-params">null</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="hljs-keyword">if</span> (control.value === name) &#123;</span><br><span class="line">      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-keyword">return</span> &#123; </span><br><span class="line">      actualValue: control.value, </span><br><span class="line">      requiredValue: name</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然後就可以像這樣使用：</p>
<figure class="highlight typescript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">new</span> FormControl(<span class="hljs-string">''</span>, nameValidator(<span class="hljs-string">'Leo'</span>));</span><br></pre></td></tr></table></figure>

<p>不過， <code>ValidatorFn</code> 是用<strong>同步</strong>的方式來執行驗證，萬一遇到需要<strong>非同步</strong>驗證的情況要怎麼辦？</p>
<h2 id="非同步驗證器"><a href="#非同步驗證器" class="headerlink" title="非同步驗證器"></a>非同步驗證器</h2><p>大家應該都滿喜歡玩遊戲的吧？！</p>
<blockquote>
<p><del>謎之音：不要自己愛玩就認為別人都愛玩</del></p>
</blockquote>
<p>絕大多數的遊戲，尤其是線上遊戲，在取名時不能夠取跟別人相同的名字，而當取到跟別人一樣的名字時，系統會提示「此名稱已被使用」之類的錯誤訊息。</p>
<p>面對這種應用場景，相信大部分的朋友可能會是使用 <code>valueChanges</code> 來訂閱欄位的變化事件，當使用者輸入名稱時，會呼叫 API 讓後端來幫忙驗證該名字是否已被使用，然後再根據回傳結果來決定是否顯示錯誤訊息。</p>
<blockquote>
<p>畢竟前端不可能事先取得幾千、幾萬甚至是幾十萬、幾百萬的名字再一一比對吧？</p>
</blockquote>
<p>不過如果有這樣的應用場景，我個人覺得還滿適合使用非同步驗證器來處理的。</p>
<blockquote>
<p>順帶一提，這只是我個人舉例，不代表真實應用情況。</p>
</blockquote>
<h3 id="AsyncValidator"><a href="#AsyncValidator" class="headerlink" title="AsyncValidator"></a>AsyncValidator</h3><figure class="highlight typescript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">interface</span> AsyncValidator <span class="hljs-keyword">extends</span> Validator &#123;</span><br><span class="line">  validate(control: AbstractControl): <span class="hljs-built_in">Promise</span>&lt;ValidationErrors | <span class="hljs-literal">null</span>&gt; | Observable&lt;ValidationErrors | <span class="hljs-literal">null</span>&gt;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">// inherited from forms/Validator</span></span><br><span class="line">  validate(control: AbstractControl): ValidationErrors | <span class="hljs-literal">null</span></span><br><span class="line">  registerOnValidatorChange(fn: <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> <span class="hljs-built_in">void</span>)?: <span class="hljs-built_in">void</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>從上述定義可以看出，跟<strong>同步</strong>的驗證器所不一樣的是，我們在自訂<strong>非同步的驗證器時</strong>，不是直接製作一個符合 <code>AsyncValidatorFn</code> 定義的函式</p>
<p>而是要用一個可被注入的 Class 來實作 <code>AsyncValidator</code> 這個介面。</p>
<p>就像下面這個官網的範例一樣：</p>
<figure class="highlight typescript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">@Injectable</span>(&#123; providedIn: <span class="hljs-string">'root'</span> &#125;)</span><br><span class="line"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> UniqueAlterEgoValidator <span class="hljs-keyword">implements</span> AsyncValidator &#123;</span><br><span class="line">  <span class="hljs-keyword">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> heroesService: HeroesService</span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  validate(</span><br><span class="line">    ctrl: AbstractControl</span><br><span class="line">  ): <span class="hljs-built_in">Promise</span>&lt;ValidationErrors | <span class="hljs-literal">null</span>&gt; | Observable&lt;ValidationErrors | <span class="hljs-literal">null</span>&gt; &#123;</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.heroesService.isAlterEgoTaken(ctrl.value).pipe(</span><br><span class="line">      map(<span class="hljs-function"><span class="hljs-params">isTaken</span> =&gt;</span> (isTaken ? &#123; uniqueAlterEgo: <span class="hljs-literal">true</span> &#125; : <span class="hljs-literal">null</span>)),</span><br><span class="line">      catchError(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> of(<span class="hljs-literal">null</span>))</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="使用方式"><a href="#使用方式" class="headerlink" title="使用方式"></a>使用方式</h3><p>為我們欄位設定非同步驗證器的方式也非常地簡單。</p>
<p>以 <code>FormControl</code> 來說， 我們可以用這樣子的方式來設定：</p>
<figure class="highlight typescript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">new</span> FormControl(<span class="hljs-string">''</span>, [<span class="hljs-comment">/* 一般驗證器 */</span>], [<span class="hljs-comment">/* 非同步驗證器 */</span>]);</span><br></pre></td></tr></table></figure>

<p>簡單來說，不論是用 Reactive Forms 的哪種方式建立欄位，非同步驗證器都是放在一般驗證器後面就對了！</p>
<h2 id="本日小結"><a href="#本日小結" class="headerlink" title="本日小結"></a>本日小結</h2><p>希望透過今天的分享，能讓大家可以初步掌握自訂驗證器的技巧。雖然在實務上，大家不一定遇的到需要使用非同步驗證器的場景，但如果真的有需要用到又忘記怎麼做時，至少有這篇文章在，隨時都可以回來查詢。</p>
<p>此外，雖然沒有分享自訂 Template Driven Forms 驗證器的方式，但大家可以自行參考官方的 <a href="https://angular.io/guide/form-validation#adding-custom-validators-to-template-driven-forms" target="_blank" rel="noopener">Form Validation - Adding custom validators to template-driven forms</a> 文件。</p>
<p>而在非同步驗證器的部份，官網也有提到一些<strong>優化非同步驗證器</strong>的技巧，大家可以參考官方的 <a href="https://angular.io/guide/form-validation#creating-asynchronous-validators" target="_blank" rel="noopener">Form Validation - Optimizing performance of async validators</a> 文件。</p>
<p>以上，就是今天的文章，如果有任何的問題或是回饋，還請麻煩留言給我讓我知道，感激不盡！</p>

        </div>
        
        
        
    </div>
</div>








    <div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2021-10-10T05:15:47.000Z">2021-10-10</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/Web-前端/">Web 前端</a>&nbsp;/&nbsp;<a class="has-link-grey -link" href="/categories/Web-前端/iThome2021鐵人賽/">iThome2021鐵人賽</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    20 分鐘 閱讀文 (大約 3046 個字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2021/10/10/angular-30days-form-and-test-25/">Angular 深入淺出三十天：表單與測試 Day25 - 測試進階技巧 - DI 抽換</a>
            
        </h1>
        <div class="content">
            <p><img src="https://i.imgur.com/8KCtLAa.jpg" alt="Day25"></p>
<p>好一陣子沒寫單元測試與整合測試了，大家是否覺得有些生疏了呢？</p>
<p>之前的測試都寫得很簡單，正好昨天好好地寫了搜尋輸入框還有呼叫 API ，可以藉由撰寫這個功能的測試來分享一些小技巧給大家。</p>
<blockquote>
<p>小提醒：昨天的程式碼大家可以從 <a href="https://github.com/leochen0818/angular-30days-form-and-testing/tree/day24" target="_blank" rel="noopener">Github - Branch: day24</a> 上 Clone 或者是 Fork 下來。</p>
</blockquote>
<h2 id="實作開始"><a href="#實作開始" class="headerlink" title="實作開始"></a>實作開始</h2><p>這次要撰寫測試的檔案比較多，有三個 <code>Pipe</code> 、 一個 <code>Service</code> 與一個 <code>Component</code> 的測試需要撰寫。</p>
<p>不過雖然檔案比較多，但要撰寫的測試其實不會比較難，相反地，由於我們昨天在開發的時候有把邏輯切到各個 <code>Pipe</code> 與 <code>Service</code> ，因此凡而在撰寫測試上會顯得更加地好寫。</p>
<h3 id="測試單元-BooleanInZhTwPipe"><a href="#測試單元-BooleanInZhTwPipe" class="headerlink" title="測試單元 - BooleanInZhTwPipe"></a>測試單元 - BooleanInZhTwPipe</h3><p>首先，我們來看看最簡單的 <code>BooleanInZhTwPipe</code> ，其程式碼如下：</p>
<figure class="highlight typescript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> BooleanInZhTwPipe <span class="hljs-keyword">implements</span> PipeTransform &#123;</span><br><span class="line"></span><br><span class="line">  transform(value: <span class="hljs-built_in">boolean</span>, ...args: unknown[]): <span class="hljs-built_in">string</span> &#123;</span><br><span class="line">    <span class="hljs-keyword">return</span> value ? <span class="hljs-string">'是'</span> : <span class="hljs-string">'否'</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>BooleanInZhTwPipe</code> 只有一個函式 <code>transform</code> ，因此我們只要驗證：</p>
<ol>
<li>當傳入的 <code>value</code> 為 <code>true</code> 時，則回傳 <code>是</code> 。</li>
<li>當傳入的 <code>value</code> 為 <code>false</code> 時，則回傳 <code>否</code> 。</li>
</ol>
<p>夠簡單了吧？</p>
<p>測試程式碼如下：</p>
<figure class="highlight typescript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">describe(<span class="hljs-string">'BooleanInZhTwPipe'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="hljs-keyword">let</span> pipe: BooleanInZhTwPipe;</span><br><span class="line">  beforeEach(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;</span><br><span class="line">    pipe = <span class="hljs-keyword">new</span> BooleanInZhTwPipe();</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  it(<span class="hljs-string">'create an instance'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;</span><br><span class="line">    expect(pipe).toBeTruthy();</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  describe(<span class="hljs-string">'transform'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;</span><br><span class="line">    describe(<span class="hljs-string">'when the first parameter is `true`'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;</span><br><span class="line">      it(<span class="hljs-string">'should return "是"'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="hljs-comment">// Arrange</span></span><br><span class="line">        <span class="hljs-keyword">const</span> firstParameter = <span class="hljs-literal">true</span>;</span><br><span class="line">        <span class="hljs-keyword">const</span> expectedResult = <span class="hljs-string">'是'</span>;</span><br><span class="line">        <span class="hljs-comment">// Acc</span></span><br><span class="line">        <span class="hljs-keyword">const</span> actualResult = pipe.transform(firstParameter);</span><br><span class="line">        <span class="hljs-comment">// Assert</span></span><br><span class="line">        expect(actualResult).toBe(expectedResult);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    describe(<span class="hljs-string">'when the first parameter is `false`'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;</span><br><span class="line">      it(<span class="hljs-string">'should return "否"'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="hljs-comment">// Arrange</span></span><br><span class="line">        <span class="hljs-keyword">const</span> firstParameter = <span class="hljs-literal">false</span>;</span><br><span class="line">        <span class="hljs-keyword">const</span> expectedResult = <span class="hljs-string">'否'</span>;</span><br><span class="line">        <span class="hljs-comment">// Acc</span></span><br><span class="line">        <span class="hljs-keyword">const</span> actualResult = pipe.transform(firstParameter);</span><br><span class="line">        <span class="hljs-comment">// Assert</span></span><br><span class="line">        expect(actualResult).toBe(expectedResult);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>測試結果：</p>
<p><img src="https://i.imgur.com/UkucGHs.jpg" alt="Testing Result"></p>
<h3 id="測試單元-GoogleMapLinkPipe"><a href="#測試單元-GoogleMapLinkPipe" class="headerlink" title="測試單元 - GoogleMapLinkPipe"></a>測試單元 - GoogleMapLinkPipe</h3><p><code>GoogleMapLinkPipe</code> 的部份也很簡單，其程式碼如下：</p>
<figure class="highlight typescript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> GoogleMapLinkPipe <span class="hljs-keyword">implements</span> PipeTransform &#123;</span><br><span class="line"></span><br><span class="line">  transform(&#123; PositionLat, PositionLon &#125;: StationPosition, ...args: unknown[]): <span class="hljs-built_in">string</span> &#123;</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-string">`https://www.google.com/maps?q=<span class="hljs-subst">$&#123;PositionLat&#125;</span>,<span class="hljs-subst">$&#123;PositionLon&#125;</span>&amp;z=7`</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而其驗證項目只需要驗證將傳入的第一個參數的 <code>PositionLat</code> 跟 <code>PositionLong</code> 是否有與 URL 相結合即可。</p>
<p>其測試程式碼如下：</p>
<figure class="highlight typescript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">describe(<span class="hljs-string">'GoogleMapLinkPipe'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="hljs-keyword">let</span> pipe: GoogleMapLinkPipe;</span><br><span class="line">  beforeEach(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;</span><br><span class="line">    pipe = <span class="hljs-keyword">new</span> GoogleMapLinkPipe();</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  it(<span class="hljs-string">'create an instance'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;</span><br><span class="line">    expect(pipe).toBeTruthy();</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  describe(<span class="hljs-string">'transform'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;</span><br><span class="line">    describe(<span class="hljs-string">'when the first parameter is `true`'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;</span><br><span class="line">      it(<span class="hljs-string">'should return "https://www.google.com/maps?q=2.34567,12.34567&amp;z=7"'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="hljs-comment">// Arrange</span></span><br><span class="line">        <span class="hljs-keyword">const</span> firstParameter: StationPosition = &#123;</span><br><span class="line">          PositionLon: <span class="hljs-number">12.34567</span>,</span><br><span class="line">          PositionLat: <span class="hljs-number">2.34567</span>,</span><br><span class="line">          GeoHash: <span class="hljs-string">'abcdefg'</span></span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="hljs-keyword">const</span> expectedResult = <span class="hljs-string">'https://www.google.com/maps?q=2.34567,12.34567&amp;z=7'</span>;</span><br><span class="line">        <span class="hljs-comment">// Acc</span></span><br><span class="line">        <span class="hljs-keyword">const</span> actualResult = pipe.transform(firstParameter);</span><br><span class="line">        <span class="hljs-comment">// Assert</span></span><br><span class="line">        expect(actualResult).toBe(expectedResult);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>測試結果：</p>
<p><img src="https://i.imgur.com/lzHveFr.jpg" alt="Testing Result"></p>
<h3 id="測試單元-LocationStringPipe"><a href="#測試單元-LocationStringPipe" class="headerlink" title="測試單元 - LocationStringPipe"></a>測試單元 - LocationStringPipe</h3><p>最後一個 Pipe ─ <code>LocationStringPipe</code> 的程式碼如下：</p>
<figure class="highlight typescript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> LocationStringPipe <span class="hljs-keyword">implements</span> PipeTransform &#123;</span><br><span class="line"></span><br><span class="line">  transform(&#123; PositionLat, PositionLon &#125;: StationPosition, ...args: unknown[]): <span class="hljs-built_in">string</span> &#123;</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">$&#123;PositionLat&#125;</span>, <span class="hljs-subst">$&#123;PositionLon&#125;</span>`</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其驗證項目只需要驗證將傳入的第一個參數的 <code>PositionLat</code> 跟 <code>PositionLong</code> 是否有變成字串並在其中加上逗號即可。</p>
<p>其測試程式碼如下：</p>
<figure class="highlight typescript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">describe(<span class="hljs-string">'LocationStringPipe'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="hljs-keyword">let</span> pipe: LocationStringPipe;</span><br><span class="line">  beforeEach(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;</span><br><span class="line">    pipe = <span class="hljs-keyword">new</span> LocationStringPipe();</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  it(<span class="hljs-string">'create an instance'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="hljs-keyword">const</span> pipe = <span class="hljs-keyword">new</span> LocationStringPipe();</span><br><span class="line">    expect(pipe).toBeTruthy();</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  describe(<span class="hljs-string">'transform'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;</span><br><span class="line">    describe(<span class="hljs-string">'when the first parameter is `true`'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;</span><br><span class="line">      it(<span class="hljs-string">'should return "2.34567, 12.34567"'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="hljs-comment">// Arrange</span></span><br><span class="line">        <span class="hljs-keyword">const</span> firstParameter: StationPosition = &#123;</span><br><span class="line">          PositionLon: <span class="hljs-number">12.34567</span>,</span><br><span class="line">          PositionLat: <span class="hljs-number">2.34567</span>,</span><br><span class="line">          GeoHash: <span class="hljs-string">'abcdefg'</span></span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="hljs-keyword">const</span> expectedResult = <span class="hljs-string">'2.34567, 12.34567'</span>;</span><br><span class="line">        <span class="hljs-comment">// Acc</span></span><br><span class="line">        <span class="hljs-keyword">const</span> actualResult = pipe.transform(firstParameter);</span><br><span class="line">        <span class="hljs-comment">// Assert</span></span><br><span class="line">        expect(actualResult).toBe(expectedResult);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>測試結果：</p>
<p><img src="https://i.imgur.com/dalFR4R.jpg" alt="Testing Result"></p>
<p>至此， Pipe 的部份就全測完了，相信大家這部份一定沒什麼問題。</p>
<p>而大家應該也有發現，我們在今天在驗 Pipe 的時候跟在驗 Component 的時候有一個滿明顯的不同，那就是我們今天沒有 <code>TestBed</code> 。</p>
<p>其實這是因為我們的這幾個 Pipe 很乾淨，沒有依賴任何其他的 Class ，所以在撰寫測試時，其實就把它當成一般的 Class ，用 <code>new xxxPipe()</code> 的方式產生出實體就行了。</p>
<h3 id="ReactiveFormsAutoCompleteSearchingService"><a href="#ReactiveFormsAutoCompleteSearchingService" class="headerlink" title="ReactiveFormsAutoCompleteSearchingService"></a>ReactiveFormsAutoCompleteSearchingService</h3><p>剛剛前面的 Pipe 只是先讓大家熱熱身，抓抓手感，接下來我們要為 <code>ReactiveFormsAutoCompleteSearchingService</code> 撰寫測試，算是今天的重頭戲之一。</p>
<p>雖然 <code>ReactiveFormsAutoCompleteSearchingService</code> 的程式碼也很簡單，但為什麼會是今天的重頭戲呢？</p>
<p>這是因為  <code>ReactiveFormsAutoCompleteSearchingService</code> 有用到我們之前沒有用過的 <code>httpClient</code> 。</p>
<p>先來看看它的程式碼：</p>
<figure class="highlight typescript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> ReactiveFormsAutoCompleteSearchingService &#123;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> httpClient: HttpClient</span>) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  searchStation(stationName: <span class="hljs-built_in">string</span>): Observable&lt;MetroStationDTO[]&gt; &#123;</span><br><span class="line">    <span class="hljs-keyword">let</span> url = <span class="hljs-string">'https://ptx.transportdata.tw/MOTC/v2/Rail/Metro/Station/TRTC?$format=JSON'</span>;</span><br><span class="line">    <span class="hljs-keyword">if</span> (stationName) &#123;</span><br><span class="line">      url += <span class="hljs-string">`&amp;$filter=contains(StationName/Zh_tw,'<span class="hljs-subst">$&#123;stationName&#125;</span>')`</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.httpClient.get&lt;MetroStationDTO[]&gt;(url);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>ReactiveFormsAutoCompleteSearchingService</code> 跟上面的 Pipe 一樣，都只有一個函式，不過在這個函式裡我們會需要驗兩個情境，四個案例：</p>
<ol>
<li>呼叫 <code>searchStation</code> 所帶入的參數是空字串時<ol>
<li>該函式會回傳一個 <code>Observable</code> <strong>（單元測試）</strong></li>
<li>要呼叫 <code>httpClient</code> 的 <code>get</code> 函式，並帶入參數 <code>https://ptx.transportdata.tw/MOTC/v2/Rail/Metro/Station/TRTC?$format=JSON</code> <strong>（整合測試）</strong></li>
</ol>
</li>
<li>呼叫 <code>searchStation</code> 所帶入的參數是有效字串時<ol>
<li>該函式會回傳一個 <code>Observable</code> <strong>（單元測試）</strong></li>
<li>要呼叫 <code>httpClient</code> 的 <code>get</code> 函式，並帶入參數 <code>https://ptx.transportdata.tw/MOTC/v2/Rail/Metro/Station/TRTC?$format=JSON&amp;$filter=contains(StationName/Zh_tw,&#39;xxx&#39;)</code> <strong>（整合測試）</strong></li>
</ol>
</li>
</ol>
<p>開始撰寫測試之前，我們一樣先把 <code>ReactiveFormsAutoCompleteSearchingService</code> 所依賴的項目準備好：</p>
<figure class="highlight typescript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">beforeEach(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;</span><br><span class="line">  TestBed.configureTestingModule(&#123;</span><br><span class="line">    imports: [HttpClientTestingModule],</span><br><span class="line">    providers: [ReactiveFormsAutoCompleteSearchingService]</span><br><span class="line">  &#125;);</span><br><span class="line">  service = TestBed.inject(ReactiveFormsAutoCompleteSearchingService);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>準備好依賴項目之後，就可以開始撰寫測試程式囉。</p>
<blockquote>
<p>看仔細噢！原本 Service 要使用 <code>HttpClient</code> 的話，正常要在模組內引入 <code>HttpClientModule</code> 。</p>
<p>但在撰寫測試時，我們要引入的是 <code>HttpClientTestingModule</code> 這個 Angular 幫我們準備好專門給撰寫測試所要引入的 Module 。</p>
</blockquote>
<p>我的測試程式碼如下：</p>
<figure class="highlight typescript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">describe(<span class="hljs-string">'searchStation'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;</span><br><span class="line">  describe(<span class="hljs-string">'When the stationName is a empty string'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="hljs-keyword">const</span> stationName = <span class="hljs-string">''</span>;</span><br><span class="line">    it(<span class="hljs-string">'should return a Observable'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="hljs-comment">// Act</span></span><br><span class="line">      <span class="hljs-keyword">const</span> result = service.searchStation(stationName);</span><br><span class="line">      <span class="hljs-comment">// Assert</span></span><br><span class="line">      expect(result).toBeInstanceOf(Observable);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    it(<span class="hljs-string">'should call function "get" of the "HttpClient" with the correct API\'s URL'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="hljs-comment">// Arrange</span></span><br><span class="line">      <span class="hljs-keyword">const</span> apiUrl = <span class="hljs-string">'https://ptx.transportdata.tw/MOTC/v2/Rail/Metro/Station/TRTC?$format=JSON'</span>;</span><br><span class="line">      <span class="hljs-keyword">const</span> httpClient = TestBed.inject(HttpClient);</span><br><span class="line">      spyOn(httpClient, <span class="hljs-string">'get'</span>);</span><br><span class="line">      <span class="hljs-comment">// Act</span></span><br><span class="line">      service.searchStation(stationName);</span><br><span class="line">      <span class="hljs-comment">// Assert</span></span><br><span class="line">      expect(httpClient.get).toHaveBeenCalledWith(apiUrl);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  describe(<span class="hljs-string">'When the stationName is a valid string'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="hljs-keyword">const</span> stationName = <span class="hljs-string">'Leo'</span>;</span><br><span class="line">    it(<span class="hljs-string">'should return a Observable'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="hljs-comment">// Act</span></span><br><span class="line">      <span class="hljs-keyword">const</span> result = service.searchStation(stationName);</span><br><span class="line">      <span class="hljs-comment">// Assert</span></span><br><span class="line">      expect(result).toBeInstanceOf(Observable);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    it(<span class="hljs-string">'should call function "get" of the "HttpClient" with the correct API\'s URL'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="hljs-comment">// Arrange</span></span><br><span class="line">      <span class="hljs-keyword">const</span> apiUrl = <span class="hljs-string">'https://ptx.transportdata.tw/MOTC/v2/Rail/Metro/Station/TRTC?$format=JSON&amp;$filter=contains(StationName/Zh_tw,\'Leo\')'</span>;</span><br><span class="line">      <span class="hljs-keyword">const</span> httpClient = TestBed.inject(HttpClient);</span><br><span class="line">      spyOn(httpClient, <span class="hljs-string">'get'</span>);</span><br><span class="line">      <span class="hljs-comment">// Act</span></span><br><span class="line">      service.searchStation(stationName);</span><br><span class="line">      <span class="hljs-comment">// Assert</span></span><br><span class="line">      expect(httpClient.get).toHaveBeenCalledWith(apiUrl);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>測試結果：</p>
<p><img src="https://i.imgur.com/6IlpkPo.jpg" alt="Testing Result"></p>
<h3 id="ReactiveFormsAutoCompleteSearchingComponent"><a href="#ReactiveFormsAutoCompleteSearchingComponent" class="headerlink" title="ReactiveFormsAutoCompleteSearchingComponent"></a>ReactiveFormsAutoCompleteSearchingComponent</h3><p>最後要測的是 <code>ReactiveFormsAutoCompleteSearchingComponent</code> ，由於是 Component 的關係，基本上除了 Class 本身之外，我們還要來驗證 Template 的部份。</p>
<p>先來看看 Class 的程式碼：</p>
<figure class="highlight typescript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> ReactiveFormsAutoCompleteSearchingComponent &#123;</span><br><span class="line"></span><br><span class="line">  searchingInputControl = <span class="hljs-keyword">new</span> FormControl();</span><br><span class="line">  stations$ = <span class="hljs-keyword">this</span>.searchingInputControl.valueChanges.pipe(</span><br><span class="line">    startWith(<span class="hljs-string">''</span>),</span><br><span class="line">    debounceTime(<span class="hljs-number">500</span>),</span><br><span class="line">    switchMap(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> <span class="hljs-keyword">this</span>.service.searchStation(value))</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> service: ReactiveFormsAutoCompleteSearchingService</span>) &#123; &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>這個 Component 要驗的情境有：</p>
<ol>
<li>驗證 <code>searchingInputControl</code> 是不是 <code>FormControl</code></li>
<li>驗證 <code>stations$</code> 是不是 <code>Observable</code></li>
<li>驗證 <code>stations$</code> 被訂閱時， <code>ReactiveFormsAutoCompleteSearchingService</code> 的函式 <code>searchStation</code> 會不會被呼叫並傳入空字串</li>
<li>驗證 <code>searchingInputControl</code> 的值變動時， <code>ReactiveFormsAutoCompleteSearchingService</code> 的函式 <code>searchStation</code> 會不會被呼叫並傳入 <code>searchingInputControl</code> 的值</li>
<li>驗證 <code>searchingInputControl</code> 的值快速變動兩次時，<code>ReactiveFormsAutoCompleteSearchingService</code> 的函式 <code>searchStation</code> 是否只被呼叫一次</li>
<li>驗證 <code>searchingInputControl</code> 的值變動兩次的間隔時間超過 500 毫秒時，<code>ReactiveFormsAutoCompleteSearchingService</code> 的函式 <code>searchStation</code> 是否被呼叫兩次</li>
</ol>
<p>開始測試前，一樣先把依賴的項目準備好：</p>
<figure class="highlight typescript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">describe(<span class="hljs-string">'ReactiveFormsAutoCompleteSearchingComponent'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="hljs-keyword">let</span> component: ReactiveFormsAutoCompleteSearchingComponent;</span><br><span class="line">  <span class="hljs-keyword">let</span> fixture: ComponentFixture&lt;ReactiveFormsAutoCompleteSearchingComponent&gt;;</span><br><span class="line"></span><br><span class="line">  beforeEach(<span class="hljs-keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="hljs-keyword">await</span> TestBed.configureTestingModule(&#123;</span><br><span class="line">      declarations: [ReactiveFormsAutoCompleteSearchingComponent],</span><br><span class="line">      providers: [</span><br><span class="line">        &#123;</span><br><span class="line">          provide: ReactiveFormsAutoCompleteSearchingService,</span><br><span class="line">          useValue: &#123;</span><br><span class="line">            searchStation: <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> EMPTY</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;)</span><br><span class="line">    .compileComponents();</span><br><span class="line"></span><br><span class="line">    fixture = TestBed.createComponent(ReactiveFormsAutoCompleteSearchingComponent);</span><br><span class="line">    component = fixture.componentInstance;</span><br><span class="line">    fixture.detectChanges();</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  it(<span class="hljs-string">'should create'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;</span><br><span class="line">    expect(component).toBeTruthy();</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>從上述程式碼中，大家可能會發現以前從來沒看過的程式碼：</p>
<figure class="highlight typescript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  provide: ReactiveFormsAutoCompleteSearchingService,</span><br><span class="line">  useValue: &#123;</span><br><span class="line">    searchStation: <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> EMPTY</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而這也是我們今天文章的主軸， <strong>DI 抽換</strong> 。</p>
<h4 id="DI-抽換"><a href="#DI-抽換" class="headerlink" title="DI 抽換"></a>DI 抽換</h4><p><strong>DI ，也就是 Dependency Injection ，依賴注入</strong>。</p>
<p>這點大家應該知道，而 <strong>DI 抽換</strong>是 Angular 提供的一個很有趣的功能，讓我們可以用以下三種方式替換掉想替換的 Provider ：</p>
<ol>
<li><p><code>useClass</code> ─ 提供一個繼承於想替換掉的 Provider 的 Class ，然後用新的 Class 取代原本的 Provider</p>
<p> 像是：</p>
 <figure class="highlight typescript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">class</span> MyRouter <span class="hljs-keyword">extends</span> Router &#123;</span><br><span class="line">  <span class="hljs-comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-meta">@NgModule</span>(&#123;</span><br><span class="line">  <span class="hljs-comment">// ...</span></span><br><span class="line">  providers: [</span><br><span class="line">    &#123;</span><br><span class="line">      provide: Router,</span><br><span class="line">      useClass: MyRouter</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> AbcModule &#123; &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>useValue</code> ─ 像剛剛在測試程式碼裡所寫的那樣，直接用物件抽換掉想換掉的 Provider</p>
</li>
<li><p><code>useFactory</code> ─ 用函式來抽換，像是：</p>
 <figure class="highlight typescript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">const</span> abcServiceFactory = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> AbcService();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-meta">@NgModule</span>(&#123;</span><br><span class="line">  <span class="hljs-comment">// ...</span></span><br><span class="line">  providers: [</span><br><span class="line">    &#123;</span><br><span class="line">      provide: AbcService,</span><br><span class="line">      useClass: abcServiceFactory</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> ABCModule &#123; &#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>關於這部份，真的要講很細的話可以寫一整篇，不過我今天只是想讓大家知道我們可以透過 DI 抽換的方式，把<strong>不可控</strong>的依賴變成<strong>可控</strong>的，這樣才能寫出<a href="https://ithelp.ithome.com.tw/articles/10268160" target="_blank" rel="noopener">優秀的測試</a>。</p>
<blockquote>
<p>關於 DI 抽換的部分，如果想了解更多可以參考官方的 <a href="https://angular.io/guide/dependency-injection-providers" target="_blank" rel="noopener">Dependency providers
</a> 文件。</p>
</blockquote>
<p>知道 DI 抽換是什麼概念之後，我們就來開始撰寫測試案例吧！</p>
<p>我的測試程式碼如下：</p>
<figure class="highlight typescript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">describe(<span class="hljs-string">'Property searchingInputControl'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;</span><br><span class="line">  it(<span class="hljs-string">'should be a instance of FormControl'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="hljs-comment">// Assert</span></span><br><span class="line">    expect(component.searchingInputControl).toBeInstanceOf(FormControl);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">describe(<span class="hljs-string">'Property stations$'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;</span><br><span class="line">  it(<span class="hljs-string">'should be a instance of FormControl'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="hljs-comment">// Assert</span></span><br><span class="line">    expect(component.stations$).toBeInstanceOf(Observable);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  describe(<span class="hljs-string">'when it be subscribed'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="hljs-keyword">let</span> service: ReactiveFormsAutoCompleteSearchingService;</span><br><span class="line">    beforeEach(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;</span><br><span class="line">      service = TestBed.inject(ReactiveFormsAutoCompleteSearchingService);</span><br><span class="line">      spyOn(service, <span class="hljs-string">'searchStation'</span>).and.returnValue(of([]));</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    it(<span class="hljs-string">'should call function "searchStation" of the service with empty string'</span>, <span class="hljs-function">(<span class="hljs-params">done</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="hljs-comment">// Act</span></span><br><span class="line">      component.stations$.subscribe(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="hljs-comment">// Assert</span></span><br><span class="line">        expect(service.searchStation).toHaveBeenCalledOnceWith(<span class="hljs-string">''</span>);</span><br><span class="line">        done();</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    describe(<span class="hljs-string">'when the input value changes'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;</span><br><span class="line">      it(<span class="hljs-string">'should call function "searchStation" of the service with the value'</span>, <span class="hljs-function">(<span class="hljs-params">done</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="hljs-comment">// Arrange</span></span><br><span class="line">        <span class="hljs-keyword">const</span> value = <span class="hljs-string">'Leo'</span></span><br><span class="line">        <span class="hljs-comment">// Act</span></span><br><span class="line">        component.stations$.subscribe(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="hljs-comment">// Assert</span></span><br><span class="line">          expect(service.searchStation).toHaveBeenCalledOnceWith(value);</span><br><span class="line">          done();</span><br><span class="line">        &#125;);</span><br><span class="line">        component.searchingInputControl.patchValue(value);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    describe(<span class="hljs-string">'when the input value changes twice quickly'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;</span><br><span class="line">      it(<span class="hljs-string">'should call function "searchStation" of the service once with the last value'</span>, <span class="hljs-function">(<span class="hljs-params">done</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="hljs-comment">// Arrange</span></span><br><span class="line">        <span class="hljs-keyword">const</span> firstValue = <span class="hljs-string">'Leo'</span></span><br><span class="line">        <span class="hljs-keyword">const</span> secondValue = <span class="hljs-string">'Chen'</span></span><br><span class="line">        <span class="hljs-comment">// Act</span></span><br><span class="line">        component.stations$.subscribe(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="hljs-comment">// Assert</span></span><br><span class="line">          expect(service.searchStation).toHaveBeenCalledOnceWith(secondValue);</span><br><span class="line">          done();</span><br><span class="line">        &#125;);</span><br><span class="line">        component.searchingInputControl.patchValue(firstValue);</span><br><span class="line">        component.searchingInputControl.patchValue(secondValue);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    describe(<span class="hljs-string">'when the input value changes twice slowly'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;</span><br><span class="line">      it(<span class="hljs-string">'should call function "searchStation" of the service twice'</span>, fakeAsync(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="hljs-comment">// Arrange</span></span><br><span class="line">        <span class="hljs-keyword">const</span> firstValue = <span class="hljs-string">'Leo'</span></span><br><span class="line">        <span class="hljs-keyword">const</span> secondValue = <span class="hljs-string">'Chen'</span></span><br><span class="line">        <span class="hljs-comment">// Act</span></span><br><span class="line">        component.stations$.subscribe();</span><br><span class="line">        component.searchingInputControl.patchValue(firstValue);</span><br><span class="line">        tick(<span class="hljs-number">600</span>);</span><br><span class="line">        component.searchingInputControl.patchValue(secondValue);</span><br><span class="line">        tick(<span class="hljs-number">600</span>);</span><br><span class="line">        <span class="hljs-comment">// Assert</span></span><br><span class="line">        expect(service.searchStation).toHaveBeenCalledTimes(<span class="hljs-number">2</span>);</span><br><span class="line">        expect(service.searchStation).toHaveBeenCalledWith(firstValue);</span><br><span class="line">        expect(service.searchStation).toHaveBeenCalledWith(secondValue);</span><br><span class="line">      &#125;));</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>測試結果：</p>
<p><img src="https://i.imgur.com/CL1eg0U.jpg" alt="Testing Result"></p>
<p>在上述的測試程式碼中，我們可以看到今天要分享給大家的最後一個技巧：<strong>非同步</strong>測試。</p>
<h4 id="Angular-的非同步測試技巧"><a href="#Angular-的非同步測試技巧" class="headerlink" title="Angular 的非同步測試技巧"></a>Angular 的非同步測試技巧</h4><p>在驗證非同步事件處理邏輯如 <code>Promise</code> 與 <code>Observable</code> 時，最簡單的方式當然就是直接 <code>then</code> 或是 <code>subscribe</code> 之後再驗證。</p>
<p>而這時我們會在傳入 <code>it</code> 的函式裡，多一個名為 <code>done</code> 的參數 <em>（你要取名為別的名字也可以）</em> ，如此我們就可以讓測試知道我們要等非同步事件完成後再行驗證。</p>
<p>像這樣：</p>
<figure class="highlight typescript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="hljs-string">'description'</span>, <span class="hljs-function">(<span class="hljs-params">done</span>) =&gt;</span> &#123;</span><br><span class="line">  observable.subscribe(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;</span><br><span class="line">    done();</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>但除了這個方式外，Angular 還有提供另一個方式是是永 <code>fakeAsync</code> 與 <code>tick</code> 的組合。</p>
<p>使用方式是將原本要傳入 <code>it</code> 裡的函式傳入 <code>fakeAsync()</code> 裡並用它來做替代，接著就可以在 <code>it</code> 裡面使用 <code>tick()</code> 這個函式來代表時間的流逝。</p>
<p>例如：</p>
<figure class="highlight typescript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="hljs-string">'description'</span>, fakeAsync(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="hljs-comment">// Do A</span></span><br><span class="line"></span><br><span class="line">  tick(<span class="hljs-number">300</span>) <span class="hljs-comment">// ms</span></span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">// Assert A</span></span><br><span class="line">&#125;));</span><br></pre></td></tr></table></figure>

<p>而且這個時間的流逝是假的，又或者是說，有種「時間加速器的概念」。</p>
<p>假設 <code>Do A</code> 到 <code>Assert A</code> 之間相隔十年，用了 <code>tick(10年)</code> 之後，瞬間就過完了十年，厲害吧！</p>
<blockquote>
<p>簡直媲美薩諾斯收集完無限寶石之後，一彈指就讓全宇宙的一半人口都灰飛湮滅的帥度</p>
</blockquote>
<p>今天差不多就到這邊，訊息量應該滿大的，至於剩下 Template 的測試沒什麼太特別的地方，就讓大家練習做做看囉！</p>
<h2 id="本日小結"><a href="#本日小結" class="headerlink" title="本日小結"></a>本日小結</h2><p>今天的重點：</p>
<ol>
<li>如果被測試的 Class 沒有任何依賴，則只需使用 <code>new XXX()</code> 來產生實體即可（ Component 除外）</li>
<li>如果有使用到 HttpClient 的話，撰寫測試時要引入的是 <code>HttpClientTestingModule</code> ，而不是 <code>HttpClientModule</code></li>
<li>DI 抽換</li>
<li>非同步的處理</li>
</ol>
<p>以上技巧會在大家實際撰寫測時非常大量的使用，記得要多加練習才會熟能生巧噢！</p>
<p>今天的程式碼會放在 <a href="https://github.com/leochen0818/angular-30days-form-and-testing/tree/day25" target="_blank" rel="noopener">Github - Branch: day25</a> 上供大家參考，建議大家在看我的實作之前，先按照需求規格自己做一遍，之後再跟我的對照，看看自己的實作跟我的實作不同的地方在哪裡、有什麼好處與壞處，如此反覆咀嚼消化後，我相信你一定可以進步地非常快！</p>
<p>如果有任何的問題或是回饋，還請麻煩留言給我讓我知道！</p>

        </div>
        
        
        
    </div>
</div>








    <div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2021-10-09T08:04:36.000Z">2021-10-09</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/Web-前端/">Web 前端</a>&nbsp;/&nbsp;<a class="has-link-grey -link" href="/categories/Web-前端/iThome2021鐵人賽/">iThome2021鐵人賽</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    21 分鐘 閱讀文 (大約 3100 個字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2021/10/09/angular-30days-form-and-test-24/">Angular 深入淺出三十天：表單與測試 Day24 - Reactive Forms 進階技巧 - Auto-Complete Searching</a>
            
        </h1>
        <div class="content">
            <p><img src="https://i.imgur.com/MyMnZN1.jpg" alt="Day24"></p>
<p>在日常生活中，大家應該滿常看到有些系統的搜尋輸入框是可以在一邊打字的同時，一邊將搜尋結果呈現在一個下拉選單裡，非常地貼心且方便。</p>
<p>當然，這其中其實有很多細節，不過我們今天就專注在前端的表單開發上，來用 <strong>Reactive Forms</strong> 實作這個搜尋輸入框吧！</p>
<blockquote>
<p>沒錯，就算只是個搜尋框，它也是個表單噢！</p>
</blockquote>
<p>正好最近<a href="https://www.hexschool.com/" target="_blank" rel="noopener">六角學院</a>即將舉辦<a href="https://www.hexschool.com/2021/09/09/2021-09-09-the-f2e-3-2021" target="_blank" rel="noopener">第三屆的前端 &amp; UI 修煉精神時光屋</a>的活動，這次它們與交通部合作，並提供了全國最大的<br><a href="https://tdx.transportdata.tw/api-service/swagger" target="_blank" rel="noopener">運輸資料流通服務平台 (TDX) 之交通 API</a> 給大家使用，讓大家可以透過此活動精進自己的實力，非常推薦給大家。</p>
<blockquote>
<p>想當初我第一次寫鐵人賽時，也是使用了參加六角舉辦的第一屆前端修煉精神時光屋的素材來寫，雖然這次沒有要參賽，但又跟六角有關係了呢！</p>
</blockquote>
<p>總之，藉由這次的機會與交通部提供的 <a href="https://tdx.transportdata.tw/api-service/swagger" target="_blank" rel="noopener">運輸資料流通服務平台 (TDX) 之交通 API</a> ，我們來簡單地做一個可以查詢台北捷運的車站的搜尋輸入框吧！</p>
<blockquote>
<p>這次因為有 API 可以使用的關係，會精實很多，如果跟不上的朋友，可能要再多熟悉一下 Angular 噢！</p>
</blockquote>
<h2 id="需求規格說明"><a href="#需求規格說明" class="headerlink" title="需求規格說明"></a>需求規格說明</h2><p>簡單來說，這個功能會需要一個輸入框與一個表格，當使用者在輸入框裡打字時，表格的內容也會連動呈現出搜尋結果。</p>
<blockquote>
<p>由於 Auto-Complete 的搜尋輸入框如果要自己做會需要處理不少細節，又不想安裝 UI 框架佔篇幅，所以我用這個方式來呈現查詢結果。</p>
</blockquote>
<p>表格的欄位有以下這些：</p>
<ul>
<li>車站代號</li>
<li>車站名稱</li>
<li>車站所屬縣市</li>
<li>車站所屬鄉鎮區</li>
<li>假日是否允許自行車進出站</li>
<li>位置</li>
</ul>
<p>最後呈現結果：</p>
<p><img src="https://i.imgur.com/683p5e2.gif" alt="Auto-Complete Searching View"></p>
<h2 id="實作開始"><a href="#實作開始" class="headerlink" title="實作開始"></a>實作開始</h2><p>首先，如果在需求明確的情況下，我個人習慣會先把畫面準備好。</p>
<p>HTML 的部份大概會長這樣：</p>
<figure class="highlight html hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"請輸入捷運站名稱"</span> /&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">table</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">caption</span>&gt;</span></span><br><span class="line">    台北捷運之捷運站查詢結果</span><br><span class="line">  <span class="hljs-tag">&lt;/<span class="hljs-name">caption</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">thead</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span></span><br><span class="line">      <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>車站代號<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span></span><br><span class="line">      <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>車站名稱<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span></span><br><span class="line">      <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>車站所屬縣市<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span></span><br><span class="line">      <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>車站所屬鄉鎮區<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span></span><br><span class="line">      <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>假日是否允許自行車進出站<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span></span><br><span class="line">      <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>位置<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;/<span class="hljs-name">thead</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">tbody</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span></span><br><span class="line">      <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span></span><br><span class="line">      <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span></span><br><span class="line">      <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span></span><br><span class="line">      <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span></span><br><span class="line">      <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span></span><br><span class="line">      <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span></span><br><span class="line">        <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">target</span>=<span class="hljs-string">"_blank"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">""</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span></span><br><span class="line">      <span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;/<span class="hljs-name">tbody</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">table</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>CSS 的部份大家就自行發揮囉！</p>
</blockquote>
<p>畫面看起來會像這樣：</p>
<p><img src="https://i.imgur.com/wp3BKyl.jpg" alt="Auto-Complete Searching View"></p>
<p>接著我們會需要一個 <code>FormControl</code> 來跟輸入框綁定，所以我們在 <code>.ts</code> 裡新增一個屬性 ─ <code>searchingInputControl</code>：</p>
<figure class="highlight typescript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> ReactiveFormsAutoCompleteSearchingComponent <span class="hljs-keyword">implements</span> OnInit &#123;</span><br><span class="line"></span><br><span class="line">  searchingInputControl = <span class="hljs-keyword">new</span> FormControl();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>別忘了先到 <code>.module.ts</code> 裡引入 <code>FormsModule</code> 與 <code>ReactiveFormsModule</code> 噢！</p>
</blockquote>
<p>然後將 <code>searchingInputControl</code> 與畫面輸入框綁定：</p>
<figure class="highlight html hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"請輸入捷運站名稱"</span> [<span class="hljs-attr">formControl</span>]=<span class="hljs-string">"searchingInputControl"</span> /&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>接著我們使用昨天分享過的 <code>valueChanges</code> 來確認是否已正確綁定：</p>
<figure class="highlight typescript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> ReactiveFormsAutoCompleteSearchingComponent <span class="hljs-keyword">implements</span> OnInit &#123;</span><br><span class="line"></span><br><span class="line">  searchingInputControl = <span class="hljs-keyword">new</span> FormControl();</span><br><span class="line"></span><br><span class="line">  ngOnInit(): <span class="hljs-built_in">void</span> &#123;</span><br><span class="line">    <span class="hljs-keyword">this</span>.searchingInputControl.valueChanges.subscribe(<span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="hljs-built_in">console</span>.log(value);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>結果：</p>
<p><img src="https://i.imgur.com/Vl0GEpm.gif" alt="Auto-Complete Searching View"></p>
<p>看起來已經有正確的跟搜尋輸入框綁定了，那接下來要怎麼做才好呢？</p>
<h3 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h3><p>我們的目的是希望使用者在輸入捷運站名稱的同時，只留下跟使用者的輸入有關聯的捷運站。</p>
<p>因此，我們會需要一支 Service 來幫我們呼叫交通部所提供的 <a href="https://tdx.transportdata.tw/api-service/swagger" target="_blank" rel="noopener">運輸資料流通服務平台 (TDX) 之交通 API</a> ，並把查詢結果顯示到畫面上。</p>
<p>Service 的程式碼大概會長這個樣子：</p>
<figure class="highlight typescript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">@Injectable</span>()</span><br><span class="line"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> ReactiveFormsAutoCompleteSearchingService &#123;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> httpClient: HttpClient</span>) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  searchStation(stationName: <span class="hljs-built_in">string</span>): Observable&lt;MetroStationDTO[]&gt; &#123;</span><br><span class="line">    <span class="hljs-keyword">let</span> url = <span class="hljs-string">'https://ptx.transportdata.tw/MOTC/v2/Rail/Metro/Station/TRTC?$format=JSON'</span>;</span><br><span class="line">    <span class="hljs-keyword">if</span> (stationName) &#123;</span><br><span class="line">      url += <span class="hljs-string">`&amp;$filter=contains(StationName/Zh_tw,'<span class="hljs-subst">$&#123;stationName&#125;</span>')`</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.httpClient.get&lt;MetroStationDTO[]&gt;(url);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上述程式碼中有以下幾個重點：</p>
<ol>
<li><p>要呼叫 API 的話，需要先到 <code>.module.ts</code> 裡引入 <code>HttpClientModule</code> ，才能在 Service 裡使用 <code>HttpClient</code> 來呼叫 API。</p>
</li>
<li><p><code>MetroStationDTO</code> 是我根據交通部所提供的 <a href="https://tdx.transportdata.tw/api-service/swagger" target="_blank" rel="noopener">運輸資料流通服務平台 (TDX) 之交通 API</a> 裡定義的資料介面，詳細位置需先選擇「軌道」再點選「捷運」，如下圖所示：</p>
</li>
</ol>
<p><img src="https://i.imgur.com/e2995Ac.jpg" alt="TDX API Document"></p>
<ol start="3">
<li><p>由於 <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Methods" target="_blank" rel="noopener">HTTP Method</a> 是 <code>GET</code> 的緣故，所以參數是使用 <code>Query Parameters</code> 的方式帶進 URL 之中。</p>
</li>
<li><p>如果使用者沒有輸入站名時，還帶 <code>$filter</code> 參數會收到伺服器回傳的 <code>Bed Request</code> 錯誤，因此增加一個判斷式 ─ 當傳入的 <code>stationName</code> 為 <strong><a href="https://developer.mozilla.org/en-US/docs/Glossary/Truthy" target="_blank" rel="noopener">Truthy</a></strong> 值時，才帶 <code>$filter</code> 參數。</p>
</li>
<li><p>參數 <code>$filter</code> 的值該怎麼帶這件事情其實在文件中沒有寫，算是這個文件比較美中不足的地方。好在六角學院的院長 ─ 廖洧杰院長前陣子有開直播課教學，而我猜測院長一定有在那堂課講這件事情，所以去翻了一下該堂直播課的<a href="https://hackmd.io/1nMqecIOQ266nTv9PnjSQw?both" target="_blank" rel="noopener">共筆</a>才找到該怎麼帶它的值。</p>
</li>
</ol>
<p>Service 準備好之後，接下來就要將 <code>FormControl</code> 的 <code>valueChanges</code> 事件與 API 相結合了。</p>
<blockquote>
<p>準備好<del>見證神蹟</del>了嗎？</p>
</blockquote>
<h3 id="Operators"><a href="#Operators" class="headerlink" title="Operators"></a>Operators</h3><p><a href="https://rxjs.dev/" target="_blank" rel="noopener">RxJS</a> 真的是一個很棒的函式庫，它讓我們可以很好地操作<strong>非同步</strong>與<strong>資料串流</strong>，而且還能讓我們的程式碼非常地簡潔、非常地好閱讀。</p>
<p>就像我們現在需要把使用者的輸入事件與 API 做結合時，用 RxJS 的 <a href="https://rxjs.dev/guide/operators" target="_blank" rel="noopener">Operators</a> 就可以非常完美、漂亮地結合在一起。</p>
<p>就像這樣：</p>
<figure class="highlight typescript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> ReactiveFormsAutoCompleteSearchingComponent <span class="hljs-keyword">implements</span> OnInit &#123;</span><br><span class="line"></span><br><span class="line">  searchingInputControl = <span class="hljs-keyword">new</span> FormControl();</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> service: ReactiveFormsAutoCompleteSearchingService</span>) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  ngOnInit(): <span class="hljs-built_in">void</span> &#123;</span><br><span class="line">    <span class="hljs-keyword">this</span>.searchingInputControl.valueChanges.pipe(</span><br><span class="line">      startWith(<span class="hljs-string">''</span>),</span><br><span class="line">      debounceTime(<span class="hljs-number">500</span>),</span><br><span class="line">      switchMap(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> <span class="hljs-keyword">this</span>.service.searchStation(value))</span><br><span class="line">    ).subscribe(<span class="hljs-function">(<span class="hljs-params">result</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="hljs-built_in">console</span>.log(result);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>結果：</p>
<p><img src="https://i.imgur.com/JWTH01j.gif" alt="Auto-Complete Searching View"></p>
<p>我相信在這邊一定會有非常多朋友看傻眼，這是什麼神操作？！這樣就接好了？！</p>
<p>沒錯！這樣就接好了，是不是比你想像中簡單非常多呢？</p>
<p>那這串到底做了什麼事呢？</p>
<p>首先，我希望這個畫面一開始的時候就會先查詢一次，所以我使用 <code>startWith(&#39;&#39;)</code> 來呼叫查詢 API 。</p>
<p>再者，我希望查詢的間隔不要太過快速，當使用者「可能」已經打完字的時候才查詢，所以我使用 <code>debounceTime(500)</code> 來讓查詢的時間點會在使用者停止打字 500 毫秒後才呼叫查詢 API。</p>
<p>最後，則要將原本是 <code>valueChanges</code> 的 Observable 轉換成 <strong>呼叫 API</strong> 的 Observable 這件事情 ，所以我使用 <code>switchMap(value =&gt; this.service.searchStation(value))</code> 。</p>
<blockquote>
<p>關於 <code>startWith</code> ，大家可以參考<a href="https://rxjs.dev/api/operators/startWith" target="_blank" rel="noopener">官方文件</a>或是 <a href="https://ithelp.ithome.com.tw/articles/10249369" target="_blank" rel="noopener">Mike 的文章</a>。</p>
<p>關於 <code>debounceTime</code> ，大家可以參考<a href="https://rxjs.dev/api/operators/debounceTime" target="_blank" rel="noopener">官方文件</a>或是 <a href="https://ithelp.ithome.com.tw/articles/10251680" target="_blank" rel="noopener">Mike 的文章</a>。</p>
<p>關於 <code>switchMap</code> ，大家可以參考<a href="https://rxjs.dev/api/operators/switchMap" target="_blank" rel="noopener">官方文件</a>或是 <a href="https://ithelp.ithome.com.tw/articles/10248745" target="_blank" rel="noopener">Mike 的文章</a>。</p>
</blockquote>
<h3 id="AsyncPipe"><a href="#AsyncPipe" class="headerlink" title="AsyncPipe"></a>AsyncPipe</h3><p>接著，我們要將得到的資料綁定到畫面上，而綁定到畫面上的方式大致上有兩種：</p>
<ol>
<li>自己訂閱後將資料指定給 Component 的屬性：</li>
</ol>
<figure class="highlight typescript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> ReactiveFormsAutoCompleteSearchingComponent <span class="hljs-keyword">implements</span> OnInit &#123;</span><br><span class="line"></span><br><span class="line">  searchingInputControl = <span class="hljs-keyword">new</span> FormControl();</span><br><span class="line">  stations: MetroStationDTO[] = []; </span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> service: ReactiveFormsAutoCompleteSearchingService</span>) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  ngOnInit(): <span class="hljs-built_in">void</span> &#123;</span><br><span class="line">    <span class="hljs-keyword">this</span>.searchingInputControl.valueChanges.pipe(</span><br><span class="line">      startWith(<span class="hljs-string">''</span>),</span><br><span class="line">      debounceTime(<span class="hljs-number">500</span>),</span><br><span class="line">      switchMap(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> <span class="hljs-keyword">this</span>.service.searchStation(value))</span><br><span class="line">    ).subscribe(<span class="hljs-function">(<span class="hljs-params">stations</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="hljs-keyword">this</span>.stations = stations;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然後再綁到畫面上：</p>
<figure class="highlight html hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">table</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">caption</span>&gt;</span></span><br><span class="line">    台北捷運之捷運站查詢結果</span><br><span class="line">  <span class="hljs-tag">&lt;/<span class="hljs-name">caption</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">thead</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span></span><br><span class="line">      <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>車站代號<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span></span><br><span class="line">      <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>車站名稱<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span></span><br><span class="line">      <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>車站所屬縣市<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span></span><br><span class="line">      <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>車站所屬鄉鎮區<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span></span><br><span class="line">      <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>假日是否允許自行車進出站<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span></span><br><span class="line">      <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>位置<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;/<span class="hljs-name">thead</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">tbody</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">tr</span> *<span class="hljs-attr">ngFor</span>=<span class="hljs-string">"let station of stations"</span>&gt;</span></span><br><span class="line">      <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>&#123;&#123; station.StationID &#125;&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span></span><br><span class="line">      <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>&#123;&#123; station.StationName.Zh_tw &#125;&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span></span><br><span class="line">      <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>&#123;&#123; station.LocationCity &#125;&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span></span><br><span class="line">      <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>&#123;&#123; station.LocationTown &#125;&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span></span><br><span class="line">      <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>&#123;&#123; station.BikeAllowOnHoliday &#125;&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span></span><br><span class="line">      <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span></span><br><span class="line">        <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">target</span>=<span class="hljs-string">"_blank"</span> [<span class="hljs-attr">href</span>]=<span class="hljs-string">"station.StationPosition"</span>&gt;</span></span><br><span class="line">          &#123;&#123; station.StationPosition &#125;&#125;</span><br><span class="line">        <span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span></span><br><span class="line">      <span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;/<span class="hljs-name">tbody</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">table</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>不要自己訂閱，先將 Observable 準備好並用 Component 的屬性儲存起來：</li>
</ol>
<figure class="highlight typescript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> ReactiveFormsAutoCompleteSearchingComponent &#123;</span><br><span class="line"></span><br><span class="line">  searchingInputControl = <span class="hljs-keyword">new</span> FormControl();</span><br><span class="line">  stations$ = <span class="hljs-keyword">this</span>.searchingInputControl.valueChanges.pipe(</span><br><span class="line">    startWith(<span class="hljs-string">''</span>),</span><br><span class="line">    debounceTime(<span class="hljs-number">500</span>),</span><br><span class="line">    switchMap(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> <span class="hljs-keyword">this</span>.service.searchStation(value))</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> service: ReactiveFormsAutoCompleteSearchingService</span>) &#123; &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然後透過 <code>AsyncPipe</code> 讓 Template 自己訂閱：</p>
<figure class="highlight html hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">table</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">caption</span>&gt;</span></span><br><span class="line">    台北捷運之捷運站查詢結果</span><br><span class="line">  <span class="hljs-tag">&lt;/<span class="hljs-name">caption</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">thead</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span></span><br><span class="line">      <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>車站代號<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span></span><br><span class="line">      <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>車站名稱<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span></span><br><span class="line">      <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>車站所屬縣市<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span></span><br><span class="line">      <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>車站所屬鄉鎮區<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span></span><br><span class="line">      <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>假日是否允許自行車進出站<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span></span><br><span class="line">      <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>位置<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;/<span class="hljs-name">thead</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">tbody</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">tr</span> *<span class="hljs-attr">ngFor</span>=<span class="hljs-string">"let station of (stations$ | async) || []"</span>&gt;</span></span><br><span class="line">      <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>&#123;&#123; station.StationID &#125;&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span></span><br><span class="line">      <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>&#123;&#123; station.StationName.Zh_tw &#125;&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span></span><br><span class="line">      <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>&#123;&#123; station.LocationCity &#125;&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span></span><br><span class="line">      <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>&#123;&#123; station.LocationTown &#125;&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span></span><br><span class="line">      <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>&#123;&#123; station.BikeAllowOnHoliday &#125;&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span></span><br><span class="line">      <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span></span><br><span class="line">        <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">target</span>=<span class="hljs-string">"_blank"</span> [<span class="hljs-attr">href</span>]=<span class="hljs-string">"station.StationPosition"</span>&gt;</span></span><br><span class="line">          &#123;&#123; station.StationPosition &#125;&#125;</span><br><span class="line">        <span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span></span><br><span class="line">      <span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;/<span class="hljs-name">tbody</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">table</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>就結果來說，這兩個方法基本上都可以，但我個人非常推薦使用第二種方式。</p>
<p>原因是使用第二種的方式一方面可以避免我們在 Component 被 Destroy 時忘記解除訂閱而導致 Memory Leak 的情形，另一方面是 Observable 會比單純資料好用很多。</p>
<blockquote>
<p>甚至有時候我們自己訂閱會發生「明明資料就有收到但畫面沒有更新」的詭異狀況。</p>
</blockquote>
<p>結果：</p>
<p><img src="https://i.imgur.com/r1zmX3Z.gif" alt="Auto-Complete Searching View"></p>
<h3 id="Other-Pipes"><a href="#Other-Pipes" class="headerlink" title="Other Pipes"></a>Other Pipes</h3><p>雖然目前運作良好，但還有一些小東西還沒處理完：</p>
<ol>
<li>假日是否允許自行車進出站的欄位我想讓它呈現 <code>是</code> 或是 <code>否</code> 。</li>
<li>位置的欄位我想讓它以 <code>latitude, longitude</code> 的格式呈現。</li>
<li>連結我想要可以點擊後用新的頁籤打開 Google Map ，並會看到那個捷運站的位置。</li>
</ol>
<p>以上這三個小東西非常地簡單，我想大家應該也都知道該怎麼做，但是既然都已經到了第二十四天了，這邊我覺得我們要使用 <code>Pipe</code> ，而不是像之前一樣直接寫在 Component 裡。</p>
<p>這是因為，如果像之前的 <code>getErrorMessage</code> 是寫在 Component 裡的話，其實當畫面渲染時，該函式就會被呼叫，不管該值有沒有被改變。</p>
<p>但是使用 <code>Pipe</code> 的話，在該值被改變前，是不會被呼叫第二次的。</p>
<p>再者，使用 <code>Pipe</code> 的話，重用性與可維護性也比較好。</p>
<p>所以我建議大家可以使用 <code>Pipe</code> 來完成最後的小調整。</p>
<p>我個人會建立三個 <code>Pipe</code> ─ <code>BooleanInZhTwPipe</code> 、 <code>GoogleMapLinkPipe</code> 與 <code>LocationStringPipe</code> 。</p>
<p>它們的程式碼如下：</p>
<figure class="highlight typescript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">@Pipe</span>(&#123;</span><br><span class="line">  name: <span class="hljs-string">'booleanInZhTw'</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> BooleanInZhTwPipe <span class="hljs-keyword">implements</span> PipeTransform &#123;</span><br><span class="line"></span><br><span class="line">  transform(value: <span class="hljs-built_in">boolean</span>, ...args: unknown[]): <span class="hljs-built_in">string</span> &#123;</span><br><span class="line">    <span class="hljs-keyword">return</span> value ? <span class="hljs-string">'是'</span> : <span class="hljs-string">'否'</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight typescript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">@Pipe</span>(&#123;</span><br><span class="line">  name: <span class="hljs-string">'googleMapLink'</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> GoogleMapLinkPipe <span class="hljs-keyword">implements</span> PipeTransform &#123;</span><br><span class="line"></span><br><span class="line">  transform(&#123; PositionLat, PositionLon &#125;: StationPosition, ...args: unknown[]): <span class="hljs-built_in">string</span> &#123;</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-string">`https://www.google.com/maps?q=<span class="hljs-subst">$&#123;PositionLat&#125;</span>,<span class="hljs-subst">$&#123;PositionLon&#125;</span>&amp;z=7`</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight typescript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">@Pipe</span>(&#123;</span><br><span class="line">  name: <span class="hljs-string">'locationString'</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> LocationStringPipe <span class="hljs-keyword">implements</span> PipeTransform &#123;</span><br><span class="line"></span><br><span class="line">  transform(&#123; PositionLat, PositionLon &#125;: StationPosition, ...args: unknown[]): <span class="hljs-built_in">string</span> &#123;</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">$&#123;PositionLat&#125;</span>, <span class="hljs-subst">$&#123;PositionLon&#125;</span>`</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最終結果：</p>
<p><img src="https://i.imgur.com/683p5e2.gif" alt="Auto-Complete Searching View"></p>
<h2 id="本日小結"><a href="#本日小結" class="headerlink" title="本日小結"></a>本日小結</h2><p>今天的重點主要是：</p>
<ol>
<li>學習如何使用 <a href="https://tdx.transportdata.tw/api-service/swagger" target="_blank" rel="noopener">TDX API</a> 。</li>
<li>學習如何使用 RxJS 的 Operator ─ <code>startWith</code> 、 <code>debounceTime</code> 與 <code>switchMap</code> 將 <code>valueChanges</code> 與<strong>呼叫 API</strong> 串聯。</li>
<li>學習如何使用 <strong><a href="https://angular.io/api/forms/AbstractControl#AsyncPipe" target="_blank" rel="noopener">AsyncPipe</a></strong> 。</li>
<li>學習如何自定 <code>Pipe</code> 。</li>
</ol>
<p>今天的練習對於一些剛學 Angular 的朋友來說會滿精實且資訊量有點大的，大家可以多看幾遍，多自己練習、做實驗，相信對大家來說會很有幫助。</p>
<p>關於 RxJS ，如果大家想知道更多資訊，我推薦大家去看 Mike 的<a href="https://ithelp.ithome.com.tw/users/20020617/ironman/2959" target="_blank" rel="noopener">打通 RxJS 任督二脈</a>系列文，或者是直接買實體書也行。</p>
<p>雖然今天的實作已經完成了，但還有測試的部份，我們明天來撰寫它吧！</p>
<p>今天的程式碼會放在 <a href="https://github.com/leochen0818/angular-30days-form-and-testing/tree/day24" target="_blank" rel="noopener">Github - Branch: day24</a> 上供大家參考，建議大家在看我的實作之前，先按照需求規格自己做一遍，之後再跟我的對照，看看自己的實作跟我的實作不同的地方在哪裡、有什麼好處與壞處，如此反覆咀嚼消化後，我相信你一定可以進步地非常快！</p>
<p>如果有任何的問題或是回饋，還請麻煩留言給我讓我知道！</p>

        </div>
        
        
        
    </div>
</div>








    <div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2021-10-08T01:12:41.000Z">2021-10-08</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/Web-前端/">Web 前端</a>&nbsp;/&nbsp;<a class="has-link-grey -link" href="/categories/Web-前端/iThome2021鐵人賽/">iThome2021鐵人賽</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    10 分鐘 閱讀文 (大約 1530 個字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2021/10/08/angular-30days-form-and-test-23/">Angular 深入淺出三十天：表單與測試 Day23 - Reactive Forms 進階技巧 - 欄位連動檢核邏輯</a>
            
        </h1>
        <div class="content">
            <p><img src="https://i.imgur.com/N9vYaVv.jpg" alt="Day23"></p>
<p>大家在日常生活中，應該看過滿多表單的某個欄位會隨著另個欄位的改變，而造成該欄位的驗證邏輯需要改變的情況吧？</p>
<p>舉例來說，可能會有個欄位叫做聯絡資訊，使用者可以選擇要填入手機號碼或者是 E-mail ，該欄位再根據使用所選擇的類型來檢核該欄位的值。</p>
<p>今天，我們就來用 <strong>Reactive Forms</strong> 實作這個欄位，而這個欄位我會實作在我們的被保人表單上，各位就隨意吧！</p>
<blockquote>
<p>如果已經忘記被保人表單長怎麼樣的話，可以先回頭複習一下第十一天的文章：<a href="https://ithelp.ithome.com.tw/articles/10272343" target="_blank" rel="noopener">Reactive Forms 實作 - 動態表單初體驗</a>。</p>
</blockquote>
<h2 id="實作開始"><a href="#實作開始" class="headerlink" title="實作開始"></a>實作開始</h2><p>首先，我們需要在原本的被保人表單裡新增一個欄位：聯絡資訊。</p>
<p>HTML 的部份大概會長這樣：</p>
<figure class="highlight html hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>聯絡資訊：<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">select</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">""</span>&gt;</span>請選擇<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"mobile"</span>&gt;</span>手機<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"email"</span>&gt;</span>E-Mail<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>畫面看起來會像這樣：</p>
<p><img src="https://i.imgur.com/0hfeJjz.jpg" alt="Insured View"></p>
<p>雖然聯絡資訊是一個欄位，但其實我們需要兩個 <code>FormControl</code> ，一個給下拉選單，一個給實際填值的 <code>input</code> 元素。</p>
<p>因此，我們要在原本的 <code>createInsuredFormGroup</code> 裡多加兩個欄位，像是這樣：</p>
<figure class="highlight typescript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">private</span> createInsuredFormGroup(): FormGroup &#123;</span><br><span class="line">  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.formBuilder.group(&#123;</span><br><span class="line">    name: [</span><br><span class="line">      <span class="hljs-string">''</span>,</span><br><span class="line">      [Validators.required, Validators.minLength(<span class="hljs-number">2</span>), Validators.maxLength(<span class="hljs-number">10</span>)]</span><br><span class="line">    ],</span><br><span class="line">    gender: [<span class="hljs-string">''</span>, Validators.required],</span><br><span class="line">    age: [<span class="hljs-string">''</span>, Validators.required],</span><br><span class="line">    contactInfoType: [<span class="hljs-string">''</span>, Validators.required],</span><br><span class="line">    contactInfo: [<span class="hljs-string">''</span>, Validators.required]</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然後將剛剛新增的欄位與畫面的元素綁定：</p>
<figure class="highlight html hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">formControlName</span>=<span class="hljs-string">"contactInfoType"</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">""</span>&gt;</span>請選擇<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"mobile"</span>&gt;</span>手機<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"email"</span>&gt;</span>E-Mail<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">formControlName</span>=<span class="hljs-string">"contactInfo"</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>接著我們透過把資料印在畫面上的方式來檢查是否已正確綁定，像這樣：</p>
<figure class="highlight html hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">pre</span>&gt;</span>&#123;&#123; formGroup?.getRawValue() | json &#125;&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">pre</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>結果：</p>
<p><img src="https://i.imgur.com/caEJMjG.gif" alt="Insured View"></p>
<p>看起來已經有正確跟畫面上的元素綁定了，那接下來要怎麼做才好呢？</p>
<h3 id="valueChanges"><a href="#valueChanges" class="headerlink" title="valueChanges"></a>valueChanges</h3><p><strong>FormControl</strong> 的父類別 <strong>AbstractControl</strong> 有個屬性叫做 <strong><a href="https://angular.io/api/forms/AbstractControl#valueChanges" target="_blank" rel="noopener">valueChanges</a></strong> ，它是一個 <strong>Observable</strong> 。</p>
<p>我們可以透過訂閱某個 <strong>AbstractControl</strong> 的 <strong>valueChanges</strong> 這個 <strong>Observable</strong> 來知道該欄位是否已經發生變化，並且做出相應的處理。</p>
<p>因此，我們可以這樣調整 <code>createInsuredFormGroup</code> 裡的實作：</p>
<figure class="highlight typescript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">private</span> createInsuredFormGroup(): FormGroup &#123;</span><br><span class="line">  <span class="hljs-keyword">const</span> contactInfoTypeControl = <span class="hljs-keyword">this</span>.formBuilder.control(<span class="hljs-string">''</span>, Validators.required);</span><br><span class="line">  <span class="hljs-keyword">const</span> contactInfoControl = <span class="hljs-keyword">this</span>.formBuilder.control(<span class="hljs-string">''</span>, Validators.required);</span><br><span class="line">  contactInfoTypeControl.valueChanges.subscribe(<span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="hljs-keyword">switch</span> (value) &#123;</span><br><span class="line">      <span class="hljs-keyword">case</span> <span class="hljs-string">'mobile'</span>:</span><br><span class="line">        contactInfoControl.setValidators([Validators.required, Validators.pattern(<span class="hljs-regexp">/$09\d&#123;8&#125;^/</span>)]);  </span><br><span class="line">        <span class="hljs-keyword">break</span>;</span><br><span class="line">      <span class="hljs-keyword">case</span> <span class="hljs-string">'email'</span>:</span><br><span class="line">        contactInfoControl.setValidators([Validators.required, Validators.email]);  </span><br><span class="line">        <span class="hljs-keyword">break</span>;</span><br><span class="line">      <span class="hljs-keyword">default</span>:</span><br><span class="line">        contactInfoControl.setValidators([Validators.required]);  </span><br><span class="line">        <span class="hljs-keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    contactInfoControl.updateValueAndValidity();</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.formBuilder.group(&#123;</span><br><span class="line">    name: [</span><br><span class="line">      <span class="hljs-string">''</span>,</span><br><span class="line">      [Validators.required, Validators.minLength(<span class="hljs-number">2</span>), Validators.maxLength(<span class="hljs-number">10</span>)]</span><br><span class="line">    ],</span><br><span class="line">    gender: [<span class="hljs-string">''</span>, Validators.required],</span><br><span class="line">    age: [<span class="hljs-string">''</span>, Validators.required],</span><br><span class="line">    contactInfoType: contactInfoTypeControl,</span><br><span class="line">    contactInfo: contactInfoControl</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上述程式碼中有以下三個要點：</p>
<ol>
<li><p>建立 <code>FormControl</code> 的時候可以藉由 <code>this.formBuilder.control()</code> 的方式建立，也可以直接使用 <code>new FormControl()</code> 建立，這點在前面的文章已經有提過，不過我在這邊再提醒大家一次。</p>
</li>
<li><p><code>setValidators()</code> 執行完後，記得<strong>一定要</strong>使用 <code>updateValueAndValidity()</code> 來更新當前欄位的驗證，不然就要等到該欄位的值有<strong>改變</strong>時才會以新的驗證器來驗證。</p>
</li>
<li><p>由於 <code>contactInfoType</code> 允許使用者選擇 <code>請選擇</code> 的選項，因此記得在 <code>default</code> 的區塊裡，將 <code>Validators.required</code> 給加回去。</p>
</li>
</ol>
<p>這邊改好之後，我們也順便調整一下 <code>getErrorMessage</code> 的實作，讓使用者可以知道該欄位的驗證有誤：</p>
<figure class="highlight typescript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">getErrorMessage(key: <span class="hljs-built_in">string</span>, index: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">string</span> &#123;</span><br><span class="line">  <span class="hljs-keyword">const</span> formGroup = <span class="hljs-keyword">this</span>.formArray.controls[index];</span><br><span class="line">  <span class="hljs-keyword">const</span> formControl = formGroup.get(key);</span><br><span class="line">  <span class="hljs-keyword">let</span> errorMessage: <span class="hljs-built_in">string</span>;</span><br><span class="line">  <span class="hljs-keyword">if</span> (!formControl || !formControl.errors || formControl.pristine) &#123;</span><br><span class="line">    errorMessage = <span class="hljs-string">''</span>;</span><br><span class="line">  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (formControl.errors.required) &#123;</span><br><span class="line">    errorMessage = <span class="hljs-string">'此欄位必填'</span>;</span><br><span class="line">  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (formControl.errors.minlength) &#123;</span><br><span class="line">    errorMessage = <span class="hljs-string">'姓名至少需兩個字以上'</span>;</span><br><span class="line">  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (formControl.errors.maxlength) &#123;</span><br><span class="line">    errorMessage = <span class="hljs-string">'姓名至多只能輸入十個字'</span>;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">// 增加以下兩個判斷  </span></span><br><span class="line">  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (formControl.errors.pattern) &#123;</span><br><span class="line">    errorMessage = <span class="hljs-string">'手機號碼格式錯誤'</span>;</span><br><span class="line">  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (formControl.errors.email) &#123;</span><br><span class="line">    errorMessage = <span class="hljs-string">'E-mail 格式錯誤'</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">return</span> errorMessage!;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>這邊要提醒大家的是，由於驗證 E-mail 格式的方式我今天是用 <code>Validators.email</code> 的驗證器來驗，不是之前的 <code>Validators.pattern()</code> ，所以我可以直接用 <code>formControl.errors.email</code> 來判斷。</p>
<p>如果實作時，手機號碼跟 E-mail 都是用  <code>Validators.pattern()</code> 的驗證器來驗的話，就需要進一步去比對 <code>formControl.errors.pattern</code> 裡的 Regular Expression 來分辨究竟是手機號碼的格式錯誤還是 E-mail 的格式錯誤了。</p>
<p>像是這樣：</p>
<figure class="highlight typescript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (formControl.errors.pattern) &#123;</span><br><span class="line">  <span class="hljs-keyword">const</span> requiredPattern = formControl.errors.pattern.requiredPattern;</span><br><span class="line">  <span class="hljs-keyword">if</span> (requiredPattern === <span class="hljs-string">'/A Regular Expression/'</span>) &#123;</span><br><span class="line">    errorMessage = <span class="hljs-string">'手機號碼格式錯誤'</span>;</span><br><span class="line">  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (requiredPattern === <span class="hljs-string">'/B Regular Expression/'</span>) &#123;</span><br><span class="line">    errorMessage = <span class="hljs-string">'E-mail 格式錯誤'</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如此一來，我們就完成這個欄位的功能囉！</p>
<p>結果：</p>
<p><img src="https://i.imgur.com/caEJMjG.gif" alt="Insured View"></p>
<h2 id="本日小結"><a href="#本日小結" class="headerlink" title="本日小結"></a>本日小結</h2><p>今天的重點是學會如何使用 <strong><a href="https://angular.io/api/forms/AbstractControl#valueChanges" target="_blank" rel="noopener">valueChanges</a></strong> 來動態調整相關欄位的驗證邏輯。</p>
<p>雖然是 Observable 是 RxJS 的東西，但今天並沒有太艱難或太複雜的運用，使用上的感覺會跟使用 <strong>Promise</strong> 的感覺類似，不過我個人認為 RxJS 好玩且強大許多。</p>
<p>關於 RxJS ，如果大家想知道更多資訊，我推薦大家去看 Mike 的<a href="https://ithelp.ithome.com.tw/users/20020617/ironman/2959" target="_blank" rel="noopener">打通 RxJS 任督二脈</a>系列文，或者是直接買實體書也行。</p>
<p>雖然今天的實作已經完成了，但因為有調整程式碼的關係，測試程式碼其實也需要相應的調整才不會出錯，此部份就交給大家實作我就不再用篇幅分享實作囉！</p>
<p>今天的程式碼會放在 <a href="https://github.com/leochen0818/angular-30days-form-and-testing/tree/day23" target="_blank" rel="noopener">Github - Branch: day23</a> 上供大家參考，建議大家在看我的實作之前，先按照需求規格自己做一遍，之後再跟我的對照，看看自己的實作跟我的實作不同的地方在哪裡、有什麼好處與壞處，如此反覆咀嚼消化後，我相信你一定可以進步地非常快！</p>
<p>如果有任何的問題或是回饋，還請麻煩留言給我讓我知道！</p>

        </div>
        
        
        
    </div>
</div>








    <div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2021-10-07T01:15:02.000Z">2021-10-07</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/Web-前端/">Web 前端</a>&nbsp;/&nbsp;<a class="has-link-grey -link" href="/categories/Web-前端/iThome2021鐵人賽/">iThome2021鐵人賽</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    12 分鐘 閱讀文 (大約 1741 個字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2021/10/07/angular-30days-form-and-test-22/">Angular 深入淺出三十天：表單與測試 Day22 - 把 Cypress 變成 TypeScript 版</a>
            
        </h1>
        <div class="content">
            <p><img src="https://i.imgur.com/lXYaC6G.jpg" alt="Day22"></p>
<p>平常都用慣 TypeScript 版的 Cypress，但這兩天都用 JavaScript 在寫測試，令我有點不太習慣。</p>
<p>雖然 JS 版或 TS 版的差別並沒有多大，但少了一些開發時期的型別檢查與 Intellisense 還是令人感到彆扭。</p>
<p>因此，我們今天就來分享如何把 JS 版的 Cypress 變成 TS 版吧！</p>
<h2 id="Angular-專案"><a href="#Angular-專案" class="headerlink" title="Angular 專案"></a>Angular 專案</h2><p>首先，如果你的專案是 Angular ，預設不會配有任何 E2E 自動化測試工具，如果我們想要在 Angular 的專案使用 Cypress ，可以直接在終端機輸入以下指令：</p>
<figure class="highlight shell hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">$</span> ng add @cypress/schematic</span><br></pre></td></tr></table></figure>

<p>等待它執行完成後，你會發現 Angular Schematics 除了幫你裝好 Cypress 之後，也在 <code>package.json</code> 裡的 <code>scripts</code> 區段增加了以下三個指令：</p>
<figure class="highlight json hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="hljs-attr">"scripts"</span>: &#123;</span><br><span class="line">    <span class="hljs-attr">"e2e"</span>: <span class="hljs-string">"ng e2e"</span>,</span><br><span class="line">    <span class="hljs-attr">"cypress:open"</span>: <span class="hljs-string">"cypress open"</span>,</span><br><span class="line">    <span class="hljs-attr">"cypress:run"</span>: <span class="hljs-string">"cypress run"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>並且在 <code>angular.json</code> 裡的 <code>architect</code> 區段添加了以下設定：</p>
<figure class="highlight json hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="hljs-attr">"cypress-run"</span>: &#123;</span><br><span class="line">    <span class="hljs-attr">"builder"</span>: <span class="hljs-string">"@cypress/schematic:cypress"</span>,</span><br><span class="line">    <span class="hljs-attr">"options"</span>: &#123;</span><br><span class="line">      <span class="hljs-attr">"devServerTarget"</span>: <span class="hljs-string">"ng-with-cypress:serve"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="hljs-attr">"configurations"</span>: &#123;</span><br><span class="line">      <span class="hljs-attr">"production"</span>: &#123;</span><br><span class="line">        <span class="hljs-attr">"devServerTarget"</span>: <span class="hljs-string">"ng-with-cypress:serve:production"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="hljs-attr">"cypress-open"</span>: &#123;</span><br><span class="line">    <span class="hljs-attr">"builder"</span>: <span class="hljs-string">"@cypress/schematic:cypress"</span>,</span><br><span class="line">    <span class="hljs-attr">"options"</span>: &#123;</span><br><span class="line">      <span class="hljs-attr">"watch"</span>: <span class="hljs-literal">true</span>,</span><br><span class="line">      <span class="hljs-attr">"headless"</span>: <span class="hljs-literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="hljs-attr">"e2e"</span>: &#123;</span><br><span class="line">    <span class="hljs-attr">"builder"</span>: <span class="hljs-string">"@cypress/schematic:cypress"</span>,</span><br><span class="line">    <span class="hljs-attr">"options"</span>: &#123;</span><br><span class="line">      <span class="hljs-attr">"devServerTarget"</span>: <span class="hljs-string">"ng-with-cypress:serve"</span>,</span><br><span class="line">      <span class="hljs-attr">"watch"</span>: <span class="hljs-literal">true</span>,</span><br><span class="line">      <span class="hljs-attr">"headless"</span>: <span class="hljs-literal">false</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="hljs-attr">"configurations"</span>: &#123;</span><br><span class="line">      <span class="hljs-attr">"production"</span>: &#123;</span><br><span class="line">        <span class="hljs-attr">"devServerTarget"</span>: <span class="hljs-string">"ng-with-cypress:serve:production"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>e2e</code> 的部份如果原本是使用 <code>Protractor</code> ，也會被調整過來。</p>
</blockquote>
<p>這段設定的用意是讓 Angular CLI 知道，當我們要執行 <code>cypress run</code> 、 <code>cypress open</code> 或是 <code>ng e2e</code> 的指令時，會連帶啟動 Angular 的服務，方便開發者使用時，不需額外自己啟動。</p>
<blockquote>
<p><del>葛來芬多</del> Cypress 加 10 分！</p>
</blockquote>
<p>此外，不可少的 <code>cypress.json</code> 與 <code>/cypress</code> 資料夾當然也已經新增好了，而且 <code>cypress.json</code> 裡還已經幫我們配置了以下設定：</p>
<figure class="highlight json hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="hljs-attr">"integrationFolder"</span>: <span class="hljs-string">"cypress/integration"</span>,</span><br><span class="line">  <span class="hljs-attr">"supportFile"</span>: <span class="hljs-string">"cypress/support/index.ts"</span>,</span><br><span class="line">  <span class="hljs-attr">"videosFolder"</span>: <span class="hljs-string">"cypress/videos"</span>,</span><br><span class="line">  <span class="hljs-attr">"screenshotsFolder"</span>: <span class="hljs-string">"cypress/screenshots"</span>,</span><br><span class="line">  <span class="hljs-attr">"pluginsFile"</span>: <span class="hljs-string">"cypress/plugins/index.ts"</span>,</span><br><span class="line">  <span class="hljs-attr">"fixturesFolder"</span>: <span class="hljs-string">"cypress/fixtures"</span>,</span><br><span class="line">  <span class="hljs-attr">"baseUrl"</span>: <span class="hljs-string">"http://localhost:4200"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>原本 <code>/cypress</code> 資料夾裡的 <code>.js</code> 檔也都變成了 <code>.ts</code> 檔，至此，我們就成功地把 Cypress 加入的 Angular 專案之中了，是不是超方便、超簡單的？！</p>
<blockquote>
<p><del>Angular + Cypress 真的會把開發者寵壞</del></p>
<p>想知道什麼是 Angular Schematics 嗎？可以閱讀我的系列文：<a href="https://ithelp.ithome.com.tw/users/20090728/ironman/2149" target="_blank" rel="noopener">高效 Coding 術：Angular Schematics 實戰三十天</a>。</p>
<p>其他更多資訊，可以參考 Cypress 官方文件：<a href="https://docs.cypress.io/guides/migrating-to-cypress/protractor#Recommended-Installation" target="_blank" rel="noopener">https://docs.cypress.io/guides/migrating-to-cypress/protractor#Recommended-Installation</a></p>
</blockquote>
<p>額外告訴大家一個小故事：其實這個 Schematics 原本不是官方維護的，這個 Schematics 的原身一開始是這個 <a href="https://www.npmjs.com/package/@briebug/cypress-schematic" target="_blank" rel="noopener">@briebug/cypress-schematic</a> ，不過後來被官方採用，才改由 Cypress 團隊維護。</p>
<blockquote>
<p>衷心感謝所有曾經或正在為 Open Source 貢獻心力的每一個人。</p>
</blockquote>
<h2 id="其他類型專案"><a href="#其他類型專案" class="headerlink" title="其他類型專案"></a>其他類型專案</h2><p>Angular 專案有 Angular Schematics ，但其他類型的專案或者是單單只有 Cypress 的專案怎辦？</p>
<p>別擔心，其實要做的事情也不會太繁瑣或困難。</p>
<p>首先，我們可以先在專案裡輸入以下指令以安裝 TypeScript ：</p>
<figure class="highlight shell hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">$</span> npm install typescript --save-dev</span><br></pre></td></tr></table></figure>

<p>or</p>
<figure class="highlight shell hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">$</span> yarn add typescript --dev</span><br></pre></td></tr></table></figure>

<blockquote>
<p>如果你的專案裡已經有安裝 TypeScript 的話請略過此步驟</p>
</blockquote>
<p>然後在 <code>/cypress</code> 資料夾內新增一個 <code>tsconfig.json</code> 檔，並添加以下內容：</p>
<figure class="highlight json hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="hljs-attr">"compilerOptions"</span>: &#123;</span><br><span class="line">    <span class="hljs-attr">"target"</span>: <span class="hljs-string">"es5"</span>,</span><br><span class="line">    <span class="hljs-attr">"lib"</span>: [<span class="hljs-string">"es5"</span>, <span class="hljs-string">"dom"</span>],</span><br><span class="line">    <span class="hljs-attr">"types"</span>: [<span class="hljs-string">"cypress"</span>]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="hljs-attr">"include"</span>: [<span class="hljs-string">"**/*.ts"</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然後就可以把我們的 <code>.js</code> 檔都改成 <code>.ts</code> 檔，並把所有的 <code>/// &lt;reference types=&quot;cypress&quot; /&gt;</code> 都拿掉囉！</p>
<p>不過如果你本來的專案就是 TypeScript 的，這時候你可能會發現你原本非 E2E 測試的 <code>.spec.ts</code> 檔案多了一堆紅色毛毛蟲：</p>
<p><img src="https://i.imgur.com/iDsSEXC.jpg" alt="VSCode Capture"></p>
<p>然後你將滑鼠游標移到紅色毛毛蟲上， VSCode 會跟你說：</p>
<p><img src="https://i.imgur.com/2ctqNxt.jpg" alt="VSCode Capture"></p>
<p>但是如果我們實際跑測試的話，又都會通過，那到底為什麼會有紅色毛毛蟲呢？</p>
<p>其實這是因為， VSCode 以為原本非 E2E 測試的 <code>.spec.ts</code> 是 Cypress 的檔案，所以它把原本是 <a href="https://jasmine.github.io/" target="_blank" rel="noopener">Jasmine</a> 的 <code>expect()</code> ：</p>
<p><img src="https://i.imgur.com/8Q2HqrU.jpg" alt="VSCode Capture"></p>
<p>誤認為是 <a href="https://www.chaijs.com/" target="_blank" rel="noopener">Chai</a> 的 <code>expect()</code> ：</p>
<p><img src="https://i.imgur.com/MrFpRUK.jpg" alt="VSCode Capture"></p>
<p>那該怎麼辦才好呢？</p>
<p>其實會造成這個狀況是因為 VSCode 它預設會吃 <code>tsconfig.json</code> 的設定，而如果原本根目錄就有 <code>tsconfig.json</code> ，然後又在 <code>/cypress</code> 裡加了 <code>tsconfig.json</code> 的話，就會出現這種狀況。</p>
<p>這時我們只需要在根目錄的 <code>tsconfig.json</code> 加上這個設定就可以恢復正常了：</p>
<figure class="highlight json hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="hljs-attr">"include"</span>: [</span><br><span class="line">    <span class="hljs-string">"src"</span>,</span><br><span class="line">    <span class="hljs-string">"node_modules/cypress"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="hljs-attr">"exclude"</span>: [</span><br><span class="line">    <span class="hljs-string">"node_modules/cypress"</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>如果這部份有遇到問題的話，可以參考我的 Source Code 的設定。</p>
</blockquote>
<p>不過別高興地太早，還有一件事情需要我們留意與調整。</p>
<h3 id="自訂-Command"><a href="#自訂-Command" class="headerlink" title="自訂 Command"></a>自訂 Command</h3><p>之前在 JS 版本使用自訂 Command 時，自訂的 Command 沒有 Intellisense 很不方便，而且參數也都沒有辦法定義型別，也增加了後續維護的困難度。</p>
<p>而現在我們升級成 TS 版本後，想要享受 TS 所帶來的好處之前，我們需要在我們的 <code>command.ts</code> 檔的開頭增加以下程式碼：</p>
<figure class="highlight typescript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">declare</span> <span class="hljs-keyword">namespace</span> Cypress &#123;</span><br><span class="line">  <span class="hljs-keyword">interface</span> Chainable &#123;</span><br><span class="line">    <span class="hljs-comment">// 這裡面擺放的是自訂 Command 的宣告</span></span><br><span class="line">    <span class="hljs-comment">// 例如：</span></span><br><span class="line">    fillWith(account: <span class="hljs-built_in">string</span>, password: <span class="hljs-built_in">string</span>): Chainable&lt;<span class="hljs-built_in">string</span>&gt;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>原本的自訂 Command 的區塊也可以一併調整成這樣：</p>
<figure class="highlight typescript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Cypress.Commands.add(<span class="hljs-string">'fillWith'</span>, <span class="hljs-function">(<span class="hljs-params">account: <span class="hljs-built_in">string</span>, password: <span class="hljs-built_in">string</span></span>) =&gt;</span> &#123;</span><br><span class="line">  cy.get(<span class="hljs-string">'#account'</span>).type(account);</span><br><span class="line">  cy.get(<span class="hljs-string">'#password'</span>).type(password);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>如此一來，我們在寫測試案例的時候即可享有 Intellisense 與型別檢查的好處囉！</p>
<blockquote>
<p>想知道更多可以參考官方的 <a href="https://docs.cypress.io/guides/tooling/typescript-support" target="_blank" rel="noopener">TypeScript Support</a> 文件</p>
</blockquote>
<h2 id="本日小結"><a href="#本日小結" class="headerlink" title="本日小結"></a>本日小結</h2><p>今天的重點主要是升級完成後，千萬記得要在 <code>command.ts</code> 加上 <code>namespace</code> 的宣告，這點可能會是很多人會不小心忘記的地方。</p>
<p>此外，也記得將 <code>/// &lt;reference types=&quot;cypress&quot; /&gt;</code> 從程式碼中移除，這個語法主要是針對 JS 的，升級 TS 之後有它反而會錯。</p>
<p>我今天的實作程式碼會放在 <a href="https://github.com/leochen0818/angular-30days-form-and-testing/tree/day22" target="_blank" rel="noopener">Github - Branch: day22</a> 上供大家參考，不過雖然該專案是 Angular 專案，但我是使用「其他專案」的方式，所以在測試時會需要自己啟動 Angular 的服務。</p>
<p>同時也建議大家在看我的實作之前，先按照需求規格自己做一遍，之後再跟我的對照，看看自己的實作跟我的實作不同的地方在哪裡、有什麼好處與壞處，如此反覆咀嚼消化後，我相信你一定可以進步地非常快！</p>
<p>如果你有任何的問題或是回饋，還請麻煩留言給我讓我知道！</p>

        </div>
        
        
        
    </div>
</div>








    <div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2021-10-06T01:09:41.000Z">2021-10-06</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/Web-前端/">Web 前端</a>&nbsp;/&nbsp;<a class="has-link-grey -link" href="/categories/Web-前端/iThome2021鐵人賽/">iThome2021鐵人賽</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    16 分鐘 閱讀文 (大約 2335 個字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2021/10/06/angular-30days-form-and-test-21/">Angular 深入淺出三十天：表單與測試 Day21 - E2E 測試實作 - 被保人表單</a>
            
        </h1>
        <div class="content">
            <p><img src="https://i.imgur.com/UGk2uOx.jpg" alt="Day21"></p>
<p>大家如果對於昨天的 E2E 測試如果沒有什麼問題的話，今天就來為我們的被保人表單撰寫 E2E 測試吧！</p>
<h2 id="實作開始"><a href="#實作開始" class="headerlink" title="實作開始"></a>實作開始</h2><blockquote>
<p>撰寫測試前的準備昨天有說過了，今天就不再贅述囉！不知道該幹嘛的朋友可以參考昨天實作開始的一開始的做了些什麼事情。</p>
</blockquote>
<p>首先我們一樣先建立一個測試檔 <code>insured-form.spec.js</code>，然後打開剛建立的測試檔加上此句語法讓編輯器可以知道我們在寫 Cypress 以方便撰寫測試程式碼：</p>
<figure class="highlight javascript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/// &lt;reference types="cypress" /&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>原理昨天一樣有介紹過了，忘記或不知道的朋友可以複習一下<a href="https://ithelp.ithome.com.tw/articles/10277741" target="_blank" rel="noopener">昨天的文章</a>。</p>
</blockquote>
<h3 id="被保人表單的第一個-E2E-測試的測試案例"><a href="#被保人表單的第一個-E2E-測試的測試案例" class="headerlink" title="被保人表單的第一個 E2E 測試的測試案例"></a>被保人表單的第一個 E2E 測試的測試案例</h3><p>接著我們打開剛建立的測試檔，來寫我們的第一個 E2E 測試的測試案例，以驗證我們的環境已準備好。</p>
<p>程式碼如下：</p>
<figure class="highlight javascript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">describe(<span class="hljs-string">'Insured Form'</span>, () =&gt; &#123;</span><br><span class="line">  beforeEach(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;</span><br><span class="line">    cy.visit(<span class="hljs-string">'http://localhost:4200'</span>);</span><br><span class="line">    cy.get(<span class="hljs-string">'ul li'</span>).contains(title).click();</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  it(<span class="hljs-string">'have title "Reactive Forms 實作 ─ 被保險人"'</span>, () =&gt; &#123;</span><br><span class="line">    <span class="hljs-comment">// Arrange</span></span><br><span class="line">    <span class="hljs-keyword">const</span> title = <span class="hljs-string">'Reactive Forms 實作 ─ 被保險人'</span>;</span><br><span class="line">    <span class="hljs-comment">// Assert</span></span><br><span class="line">    cy.get(<span class="hljs-string">'h1'</span>).should(<span class="hljs-string">'have.text'</span>, title);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>執行結果：</p>
<p><img src="https://i.imgur.com/nDuYWb3.jpg" alt="Testing Result"></p>
<p>還記得之前在介紹 Test Runner 的時候有稍稍帶過 <code>contains</code> 這個 Command 嗎？</p>
<blockquote>
<p>確切是在第 19 天的文章： <a href="https://ithelp.ithome.com.tw/articles/10277229" target="_blank" rel="noopener">與 Cypress 的初次見面（下）</a></p>
</blockquote>
<p>這次特別使用一次給大家看，因為如果不使用這個方式， CSS Selector 可能就要寫成： <code>cy.get(&#39;ul li:last-child &gt; a&#39;).click();</code> ，滿醜的。</p>
<p>當然根據官方的 Best Practice ，直接在上面加個 <code>data-cy=&quot;insured-form-page-link&quot;</code> 的屬性是最好的。</p>
<blockquote>
<p>原因一樣在第 19 天的文章： <a href="https://ithelp.ithome.com.tw/articles/10277229" target="_blank" rel="noopener">與 Cypress 的初次見面（下）</a> 有說明過，不知道的朋友可以回去複習一下。</p>
</blockquote>
<h3 id="撰寫測試案例"><a href="#撰寫測試案例" class="headerlink" title="撰寫測試案例"></a>撰寫測試案例</h3><p>藉由第一個測試案例來驗證環境沒問題後，我們就可以正式來寫需求的測試案例了。</p>
<p>複習並整理一下要驗的案例：</p>
<ul>
<li>要可以新增被保險人</li>
<li>要可以刪除被保險人</li>
<li>輸入正確姓名與選擇年齡後，但沒選擇性別，送出按鈕為 disabled 的狀態</li>
<li>輸入正確姓名與選擇性別後，但沒選擇年齡，送出按鈕為 disabled 的狀態</li>
<li>選擇性別與年齡後，但沒輸入姓名，送出按鈕為 disabled 的狀態</li>
</ul>
<p>程式碼如下：</p>
<figure class="highlight typescript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">describe(<span class="hljs-string">'Insured Form'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;</span><br><span class="line">  beforeEach(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;</span><br><span class="line">    cy.visit(<span class="hljs-string">'http://localhost:4200'</span>);</span><br><span class="line">    cy.get(<span class="hljs-string">'ul li'</span>).contains(<span class="hljs-string">'Reactive Forms 實作 ─ 被保險人'</span>).click();</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  it(<span class="hljs-string">'have title "Reactive Forms 實作 ─ 被保險人"'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="hljs-comment">// Arrange</span></span><br><span class="line">    <span class="hljs-keyword">const</span> title = <span class="hljs-string">'Reactive Forms 實作 ─ 被保險人'</span>;</span><br><span class="line">    <span class="hljs-comment">// Assert</span></span><br><span class="line">    cy.get(<span class="hljs-string">'h1'</span>).should(<span class="hljs-string">'have.text'</span>, title);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  it(<span class="hljs-string">'should can add the insured'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="hljs-comment">// Arrange</span></span><br><span class="line">    <span class="hljs-keyword">const</span> name = <span class="hljs-string">'Leo'</span>;</span><br><span class="line">    <span class="hljs-keyword">const</span> gender = <span class="hljs-string">'male'</span>;</span><br><span class="line">    <span class="hljs-keyword">const</span> age = <span class="hljs-string">'18'</span>;</span><br><span class="line">    <span class="hljs-comment">// Act</span></span><br><span class="line">    cy.get(<span class="hljs-string">'[type="button"]'</span>).click();</span><br><span class="line">    cy.get(<span class="hljs-string">'#name-0'</span>).type(name);</span><br><span class="line">    cy.get(<span class="hljs-string">`[for="<span class="hljs-subst">$&#123;gender&#125;</span>-0"]`</span>).click();</span><br><span class="line">    cy.get(<span class="hljs-string">'#age-0'</span>).select(age);</span><br><span class="line">    <span class="hljs-comment">// Assert</span></span><br><span class="line">    cy.get(<span class="hljs-string">'[type="submit"]'</span>).should(<span class="hljs-string">'be.enabled'</span>);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  it(<span class="hljs-string">'should can delete the insured'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="hljs-comment">// Act</span></span><br><span class="line">    cy.get(<span class="hljs-string">'[type="button"]'</span>).click();</span><br><span class="line">    cy.get(<span class="hljs-string">'fieldset'</span>).contains(<span class="hljs-string">'刪除'</span>).click();</span><br><span class="line">    <span class="hljs-comment">// Assert</span></span><br><span class="line">    cy.get(<span class="hljs-string">'fieldset'</span>).should(<span class="hljs-string">'have.length'</span>, <span class="hljs-number">0</span>);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  it(<span class="hljs-string">'should can not add the insured when the age is not valid'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="hljs-comment">// Arrange</span></span><br><span class="line">    <span class="hljs-keyword">const</span> name = <span class="hljs-string">'Leo'</span>;</span><br><span class="line">    <span class="hljs-keyword">const</span> gender = <span class="hljs-string">'male'</span>;</span><br><span class="line">    <span class="hljs-comment">// Act</span></span><br><span class="line">    cy.get(<span class="hljs-string">'[type="button"]'</span>).click();</span><br><span class="line">    cy.get(<span class="hljs-string">'#name-0'</span>).type(name);</span><br><span class="line">    cy.get(<span class="hljs-string">`[for="<span class="hljs-subst">$&#123;gender&#125;</span>-0"]`</span>).click();</span><br><span class="line">    <span class="hljs-comment">// Assert</span></span><br><span class="line">    cy.get(<span class="hljs-string">'[type="submit"]'</span>).should(<span class="hljs-string">'be.disabled'</span>);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  it(<span class="hljs-string">'should can not add the insured when the gender is not valid'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="hljs-comment">// Arrange</span></span><br><span class="line">    <span class="hljs-keyword">const</span> name = <span class="hljs-string">'Leo'</span>;</span><br><span class="line">    <span class="hljs-keyword">const</span> age = <span class="hljs-string">'18'</span>;</span><br><span class="line">    <span class="hljs-comment">// Act</span></span><br><span class="line">    cy.get(<span class="hljs-string">'[type="button"]'</span>).click();</span><br><span class="line">    cy.get(<span class="hljs-string">'#name-0'</span>).type(name);</span><br><span class="line">    cy.get(<span class="hljs-string">'#age-0'</span>).select(age);</span><br><span class="line">    <span class="hljs-comment">// Assert</span></span><br><span class="line">    cy.get(<span class="hljs-string">'[type="submit"]'</span>).should(<span class="hljs-string">'be.disabled'</span>);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  it(<span class="hljs-string">'should can not add the insured when the name is not valid'</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="hljs-comment">// Arrange</span></span><br><span class="line">    <span class="hljs-keyword">const</span> gender = <span class="hljs-string">'male'</span>;</span><br><span class="line">    <span class="hljs-keyword">const</span> age = <span class="hljs-string">'18'</span>;</span><br><span class="line">    <span class="hljs-comment">// Act</span></span><br><span class="line">    cy.get(<span class="hljs-string">'[type="button"]'</span>).click();</span><br><span class="line">    cy.get(<span class="hljs-string">`[for="<span class="hljs-subst">$&#123;gender&#125;</span>-0"]`</span>).click();</span><br><span class="line">    cy.get(<span class="hljs-string">'#age-0'</span>).select(age);</span><br><span class="line">    <span class="hljs-comment">// Assert</span></span><br><span class="line">    cy.get(<span class="hljs-string">'[type="submit"]'</span>).should(<span class="hljs-string">'be.disabled'</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>執行結果：</p>
<p><img src="https://i.imgur.com/yZ5NiCZ.jpg" alt="Testing Result"></p>
<p>大家有覺得昨天寫過一次後，今天再寫一次有比較熟悉一點了嗎？</p>
<p>雖然這次驗的情境比較多，但我覺得如果大多的情境都已經有被整合測試覆蓋到的話，或許只需要驗證第一個情境就好。</p>
<p>不過在現實中，寫整合測試的人不一定跟寫 E2E 測試的人是同一個，所以寫 E2E 的人照著需求規格寫，多驗一點情境也是很好的。</p>
<p>在今天的測試程式碼中，比較值得一提的是使用 <code>cy.select()</code> 的使用，它的參數可以欲選擇選項的 <code>value</code> 值，或者是選項的名稱，更可以是選項的 <code>index</code> ，是非常方便的一個 Command 。</p>
<p>此外，在選年齡時，如果大家不是跟我一樣是點擊 <code>Label</code> ，而是直接點選 Radio Button 的話，記得要使用 <code>cy.check()</code> 的 Command。</p>
<h3 id="Cypress-的錯誤訊息"><a href="#Cypress-的錯誤訊息" class="headerlink" title="Cypress 的錯誤訊息"></a>Cypress 的錯誤訊息</h3><p>不過就算寫錯也無所謂，因為 Cypress 這個貼心鬼其實都會跟你說你哪裡寫錯、可以怎麼寫。</p>
<p>例如剛剛說的 <code>cy.select()</code> ，如果我們使用 <code>cy.click()</code> ， Cypress 就會跟你說你可以用 <code>cy.select()</code> 來替代唷！而且還會跟你說你寫錯的地方是在哪一行：</p>
<p><img src="https://i.imgur.com/Hhmk0Wc.jpg" alt="Error Message"></p>
<p>又或者你使用了 <code>cy.select()</code> ，但忘記帶參數，它也會跟你說你漏了什麼參數：</p>
<p><img src="https://i.imgur.com/ZmF5HeG.jpg" alt="Error Message"></p>
<blockquote>
<p>Cypress 真是個貼心鬼</p>
</blockquote>
<p>撰寫了兩次的 E2E 測試之後，也累積了不少測試案例，這時候大家應該會發現有一些重複的東西散落在不同的測試檔案之中，又或者會有某些 <strong>Hard Code</strong> 在測試程式碼裡的東西應該要被抽出來，以利後續維護。</p>
<p>這時我們就可以善用在<a href="https://ithelp.ithome.com.tw/articles/10276874" target="_blank" rel="noopener">第 18 天的文章</a>裡曾經提過 <code>fixtures</code> 與 Cypress 的 <code>cypress.json</code> 的配置來達成。</p>
<h3 id="E2E-測試小技巧-─-環境變數"><a href="#E2E-測試小技巧-─-環境變數" class="headerlink" title="E2E 測試小技巧 ─ 環境變數"></a>E2E 測試小技巧 ─ 環境變數</h3><p>舉例來說，如果你的 E2E 的測試專案都是在測同一個網域的網頁，那我們就可以在 <code>cypress.json</code> 加上 <code>baseUrl</code> 的設置：</p>
<figure class="highlight json hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="hljs-attr">"baseUrl"</span>: <span class="hljs-string">"http://localhost:4200"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如此就可讓我們後續使用 <code>cy.visit()</code> 、 <code>cy.request()</code> 或是 <code>cy.intercept()</code> 時，就可以不用再傳入一樣的字串。</p>
<p>而且這個用法還會有一個好處，就是當需要執行不同環境的測試時，我們可以用像是這樣子的方式來替換掉該變數：</p>
<figure class="highlight shell hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">$</span> CYPRESS_BASE_URL=https://product.domain.com cypress run</span><br></pre></td></tr></table></figure>

<blockquote>
<p>更多的環境變數小技巧請詳閱官方的 <a href="https://docs.cypress.io/guides/guides/environment-variables" target="_blank" rel="noopener">Environment Variables</a> 文件。</p>
</blockquote>
<h3 id="E2E-測試小技巧-─-fixtures"><a href="#E2E-測試小技巧-─-fixtures" class="headerlink" title="E2E 測試小技巧 ─ fixtures"></a>E2E 測試小技巧 ─ fixtures</h3><p>上述提到的環境變數一般常用在會因為測試環境改變時需要改變的值上，但其實還有很多值是不會因為環境改變而改變的，這時就可以用上現在這個小技巧。</p>
<p>這個小技巧其實我也有在第 18 天的文章 ─ <a href="https://ithelp.ithome.com.tw/articles/10276874" target="_blank" rel="noopener">與 Cypress 的初次見面（上）</a> 裡稍微提到過，就是我們可以在 <code>/fixtures</code> 的資料夾底下新增 <code>.json</code> 檔，然後我們可以將值放在裡面，需要的時候再從裡面拿。</p>
<p>像現在我們可以在 <code>/fixtures</code> 裡新增一個 <code>insured-form.json</code> 的檔案，然後內容大概會是這樣：</p>
<figure class="highlight json hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="hljs-attr">"title"</span>: <span class="hljs-string">"Reactive Forms 實作 ─ 被保險人"</span>,</span><br><span class="line">  <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Leo"</span>,</span><br><span class="line">  <span class="hljs-attr">"gender"</span>: <span class="hljs-string">"male"</span>,</span><br><span class="line">  <span class="hljs-attr">"age"</span>: <span class="hljs-string">"18"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然後在 <code>insured-form.spec.js</code> 就可以改成這樣：</p>
<figure class="highlight javascript hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">import</span> insuredForm <span class="hljs-keyword">from</span> <span class="hljs-string">'../fixtures/insured-form.json'</span>;</span><br><span class="line"></span><br><span class="line">describe(<span class="hljs-string">'Insured Form'</span>, () =&gt; &#123;</span><br><span class="line">  beforeEach(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;</span><br><span class="line">    cy.visit(<span class="hljs-string">''</span>);</span><br><span class="line">    cy.get(<span class="hljs-string">'ul li'</span>).contains(insuredForm.title).click();</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  it(<span class="hljs-string">'have title "Reactive Forms 實作 ─ 被保險人"'</span>, () =&gt; &#123;</span><br><span class="line">    <span class="hljs-comment">// Arrange</span></span><br><span class="line">    <span class="hljs-keyword">const</span> title = insuredForm.title;</span><br><span class="line">    <span class="hljs-comment">// Assert</span></span><br><span class="line">    cy.get(<span class="hljs-string">'h1'</span>).should(<span class="hljs-string">'have.text'</span>, title);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  it(<span class="hljs-string">'should can add the insured'</span>, () =&gt; &#123;</span><br><span class="line">    <span class="hljs-comment">// Arrange</span></span><br><span class="line">    <span class="hljs-keyword">const</span> name = insuredForm.name;</span><br><span class="line">    <span class="hljs-keyword">const</span> gender = insuredForm.gender;</span><br><span class="line">    <span class="hljs-keyword">const</span> age = insuredForm.age;</span><br><span class="line">    <span class="hljs-comment">// Act</span></span><br><span class="line">    cy.get(<span class="hljs-string">'[type="button"]'</span>).click();</span><br><span class="line">    cy.get(<span class="hljs-string">'#name-0'</span>).type(name);</span><br><span class="line">    cy.get(<span class="hljs-string">`[for="<span class="hljs-subst">$&#123;gender&#125;</span>-0"]`</span>).click();</span><br><span class="line">    cy.get(<span class="hljs-string">'#age-0'</span>).select(age);</span><br><span class="line">    <span class="hljs-comment">// Assert</span></span><br><span class="line">    cy.get(<span class="hljs-string">'[type="submit"]'</span>).should(<span class="hljs-string">'be.enabled'</span>);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">// 以下省略...</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>如此一來，未來當驗證的資料需要改變時，就只要到 <code>/fixtures</code> 裡的 <code>insured-form.json</code> 改就好，維護起來就更加輕鬆愉快囉！</p>
<blockquote>
<p>今天我故意沒有用自訂 Command 的技巧來重構我的測試程式碼，大家不妨試著自己自訂看看吧！</p>
</blockquote>
<h2 id="本日小結"><a href="#本日小結" class="headerlink" title="本日小結"></a>本日小結</h2><p>今天的重點主要是後面的兩個小技巧，這兩個小技巧對於日後大家真的在自己的專案或為公司專案撰寫 E2E 測試會非常有幫助，請務必多加熟悉。</p>
<p>不過平常都用 TypeScript 寫的我覺得很不習慣，明天就來分享怎麼樣把它變成 TypeScript 的版本吧！</p>
<p>今天的實作程式碼會放在 <a href="https://github.com/leochen0818/angular-30days-form-and-testing/tree/day21" target="_blank" rel="noopener">Github - Branch: day21</a> 上供大家參考，建議大家在看我的實作之前，先按照需求規格自己做一遍，之後再跟我的對照，看看自己的實作跟我的實作不同的地方在哪裡、有什麼好處與壞處，如此反覆咀嚼消化後，我相信你一定可以進步地非常快！</p>
<p>如果你有任何的問題或是回饋，還請麻煩留言給我讓我知道！</p>

        </div>
        
        
        
    </div>
</div>









    
<div class="card card-transparent">
    <nav class="pagination is-centered" role="navigation" aria-label="pagination">
        <div class="pagination-previous is-invisible is-hidden-mobile">
            <a class="is-flex-grow has-text-black-ter" href="/tags/testing/page/0/">上一頁</a>
        </div>
        <div class="pagination-next">
            <a class="is-flex-grow has-text-black-ter" href="/tags/testing/page/2/">下一頁</a>
        </div>
        <ul class="pagination-list is-hidden-mobile">
            
            <li><a class="pagination-link is-current" href="/tags/testing/">1</a></li>
            
            <li><a class="pagination-link has-text-black-ter" href="/tags/testing/page/2/">2</a></li>
            
            <li><a class="pagination-link has-text-black-ter" href="/tags/testing/page/3/">3</a></li>
            
        </ul>
    </nav>
</div>
</div>
                




<div class="column is-4-tablet is-4-desktop is-3-widescreen  has-order-1 column-left ">
    
        
<div class="card widget">
    <div class="card-content">
        <nav class="level">
            <div class="level-item has-text-centered" style="flex-shrink: 1">
                <div>
                    
                        <figure class="image is-128x128 margin-center has-mb-6">
                            <img class="is-rounded" src="/images/avatar.JPG" alt="Leo">
                        </figure>
                    
                    
                    <p class="is-size-4 is-block has-mb-6">
                        Leo
                    </p>
                    
                    
                    <p class="is-size-6 is-block has-mb-6">
                        Lilee Systems Sr. Front-end Engineer
                    </p>
                    
                    
                    <p class="is-size-6 is-flex is-flex-center has-text-grey">
                        <i class="fas fa-map-marker-alt has-mr-7"></i>
                        <span>Taiwan</span>
                    </p>
                    
                </div>
            </div>
        </nav>
        <nav class="level is-mobile">
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        文章
                    </p>
                    <p class="title has-text-weight-normal">
                        35
                    </p>
                </div>
            </div>
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        分類
                    </p>
                    <p class="title has-text-weight-normal">
                        6
                    </p>
                </div>
            </div>
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        標籤
                    </p>
                    <p class="title has-text-weight-normal">
                        12
                    </p>
                </div>
            </div>
        </nav>
        <!-- <div class="level">
            <a class="level-item button is-link is-rounded" href="/" target="_blank">
                追蹤</a>
        </div> -->
        
        
    </div>
</div>
    
        
    
        


    
        
<div class="card widget">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                分類
            </h3>
            <ul class="menu-list">
            <li>
        <a class="level is-marginless" href="/categories/Git/">
            <span class="level-start">
                <span class="level-item">Git</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Web-前端/">
            <span class="level-start">
                <span class="level-item">Web 前端</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">34</span>
            </span>
        </a><ul><li>
        <a class="level is-marginless" href="/categories/Web-前端/Angular-之深入解析/">
            <span class="level-start">
                <span class="level-item">Angular 之深入解析</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Web-前端/Nx/">
            <span class="level-start">
                <span class="level-item">Nx</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">2</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Web-前端/iThome2021鐵人賽/">
            <span class="level-start">
                <span class="level-item">iThome2021鐵人賽</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">30</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Web-前端/新聞/">
            <span class="level-start">
                <span class="level-item">新聞</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li></ul></li>
            </ul>
        </div>
    </div>
</div>
    
        
<div class="card widget">
    <div class="card-content">
        <h3 class="menu-label">
            標籤雲
        </h3>
        <a href="/tags/angular/" style="font-size: 20px;">angular</a> <a href="/tags/form/" style="font-size: 16.67px;">form</a> <a href="/tags/frontend/" style="font-size: 16.67px;">frontend</a> <a href="/tags/git/" style="font-size: 10px;">git</a> <a href="/tags/homebrew/" style="font-size: 10px;">homebrew</a> <a href="/tags/library/" style="font-size: 13.33px;">library</a> <a href="/tags/macos/" style="font-size: 10px;">macos</a> <a href="/tags/nx/" style="font-size: 13.33px;">nx</a> <a href="/tags/scss/" style="font-size: 10px;">scss</a> <a href="/tags/testing/" style="font-size: 16.67px;">testing</a> <a href="/tags/typescript/" style="font-size: 10px;">typescript</a> <a href="/tags/web/" style="font-size: 16.67px;">web</a>
    </div>
</div>

    
    
        <div class="column-right-shadow is-hidden-widescreen ">
        
            
<div class="card widget">
    <div class="card-content">
        <h3 class="menu-label">
            最新文章
        </h3>
        
        <article class="media">
            
            <a href="/2021/10/15/angular-30days-form-and-test-30/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt="Angular 深入淺出三十天：表單與測試 Day30 - 表單原理">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2021-10-15T15:30:20.000Z">2021-10-15</time></div>
                    <a href="/2021/10/15/angular-30days-form-and-test-30/" class="title has-link-black-ter is-size-6 has-text-weight-normal">Angular 深入淺出三十天：表單與測試 Day30 - 表單原理</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Web-前端/">Web 前端</a> / <a class="has-link-grey -link" href="/categories/Web-前端/iThome2021鐵人賽/">iThome2021鐵人賽</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/2021/10/14/angular-30days-form-and-test-29/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt="Angular 深入淺出三十天：表單與測試 Day29 - ControlContainer">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2021-10-14T14:45:12.000Z">2021-10-14</time></div>
                    <a href="/2021/10/14/angular-30days-form-and-test-29/" class="title has-link-black-ter is-size-6 has-text-weight-normal">Angular 深入淺出三十天：表單與測試 Day29 - ControlContainer</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Web-前端/">Web 前端</a> / <a class="has-link-grey -link" href="/categories/Web-前端/iThome2021鐵人賽/">iThome2021鐵人賽</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/2021/10/13/angular-30days-form-and-test-28/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt="Angular 深入淺出三十天：表單與測試 Day28 - 自訂表單元件">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2021-10-13T15:38:05.000Z">2021-10-13</time></div>
                    <a href="/2021/10/13/angular-30days-form-and-test-28/" class="title has-link-black-ter is-size-6 has-text-weight-normal">Angular 深入淺出三十天：表單與測試 Day28 - 自訂表單元件</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Web-前端/">Web 前端</a> / <a class="has-link-grey -link" href="/categories/Web-前端/iThome2021鐵人賽/">iThome2021鐵人賽</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/2021/10/12/angular-30days-form-and-test-27/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt="Angular 深入淺出三十天：表單與測試 Day27 - Reactive Forms 進階技巧 - 跨欄位驗證">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2021-10-12T01:14:51.000Z">2021-10-12</time></div>
                    <a href="/2021/10/12/angular-30days-form-and-test-27/" class="title has-link-black-ter is-size-6 has-text-weight-normal">Angular 深入淺出三十天：表單與測試 Day27 - Reactive Forms 進階技巧 - 跨欄位驗證</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Web-前端/">Web 前端</a> / <a class="has-link-grey -link" href="/categories/Web-前端/iThome2021鐵人賽/">iThome2021鐵人賽</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/2021/10/11/angular-30days-form-and-test-26/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt="Angular 深入淺出三十天：表單與測試 Day26 - 進階表單開發技巧 - 自訂驗證器">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2021-10-11T11:32:17.000Z">2021-10-11</time></div>
                    <a href="/2021/10/11/angular-30days-form-and-test-26/" class="title has-link-black-ter is-size-6 has-text-weight-normal">Angular 深入淺出三十天：表單與測試 Day26 - 進階表單開發技巧 - 自訂驗證器</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Web-前端/">Web 前端</a> / <a class="has-link-grey -link" href="/categories/Web-前端/iThome2021鐵人賽/">iThome2021鐵人賽</a>
                    </p>
                </div>
            </div>
        </article>
        
    </div>
</div>

        
            <div class="card widget">
    <div class="card-content">
        <div class="menu">
        <h3 class="menu-label">
            彙整
        </h3>
        <ul class="menu-list">
        
        <li>
            <a class="level is-marginless" href="/archives/2021/10/">
                <span class="level-start">
                    <span class="level-item">十月 2021</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">15</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2021/09/">
                <span class="level-start">
                    <span class="level-item">九月 2021</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">15</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2021/05/">
                <span class="level-start">
                    <span class="level-item">五月 2021</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2021/03/">
                <span class="level-start">
                    <span class="level-item">三月 2021</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/12/">
                <span class="level-start">
                    <span class="level-item">十二月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/10/">
                <span class="level-start">
                    <span class="level-item">十月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        </ul>
        </div>
    </div>
</div>
        
            <div class="card widget">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                標籤
            </h3>
            <div class="field is-grouped is-grouped-multiline">
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/angular/">
                        <span class="tag">angular</span>
                        <span class="tag is-grey">34</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/form/">
                        <span class="tag">form</span>
                        <span class="tag is-grey">30</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/frontend/">
                        <span class="tag">frontend</span>
                        <span class="tag is-grey">30</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/git/">
                        <span class="tag">git</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/homebrew/">
                        <span class="tag">homebrew</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/library/">
                        <span class="tag">library</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/macos/">
                        <span class="tag">macos</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/nx/">
                        <span class="tag">nx</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/scss/">
                        <span class="tag">scss</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/testing/">
                        <span class="tag">testing</span>
                        <span class="tag is-grey">30</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/typescript/">
                        <span class="tag">typescript</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/web/">
                        <span class="tag">web</span>
                        <span class="tag is-grey">30</span>
                    </a>
                </div>
                
            </div>
        </div>
    </div>
</div>
        
        </div>
    
</div>

                




<div class="column is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only has-order-3 column-right ">
    
        
<div class="card widget">
    <div class="card-content">
        <h3 class="menu-label">
            最新文章
        </h3>
        
        <article class="media">
            
            <a href="/2021/10/15/angular-30days-form-and-test-30/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt="Angular 深入淺出三十天：表單與測試 Day30 - 表單原理">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2021-10-15T15:30:20.000Z">2021-10-15</time></div>
                    <a href="/2021/10/15/angular-30days-form-and-test-30/" class="title has-link-black-ter is-size-6 has-text-weight-normal">Angular 深入淺出三十天：表單與測試 Day30 - 表單原理</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Web-前端/">Web 前端</a> / <a class="has-link-grey -link" href="/categories/Web-前端/iThome2021鐵人賽/">iThome2021鐵人賽</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/2021/10/14/angular-30days-form-and-test-29/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt="Angular 深入淺出三十天：表單與測試 Day29 - ControlContainer">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2021-10-14T14:45:12.000Z">2021-10-14</time></div>
                    <a href="/2021/10/14/angular-30days-form-and-test-29/" class="title has-link-black-ter is-size-6 has-text-weight-normal">Angular 深入淺出三十天：表單與測試 Day29 - ControlContainer</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Web-前端/">Web 前端</a> / <a class="has-link-grey -link" href="/categories/Web-前端/iThome2021鐵人賽/">iThome2021鐵人賽</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/2021/10/13/angular-30days-form-and-test-28/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt="Angular 深入淺出三十天：表單與測試 Day28 - 自訂表單元件">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2021-10-13T15:38:05.000Z">2021-10-13</time></div>
                    <a href="/2021/10/13/angular-30days-form-and-test-28/" class="title has-link-black-ter is-size-6 has-text-weight-normal">Angular 深入淺出三十天：表單與測試 Day28 - 自訂表單元件</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Web-前端/">Web 前端</a> / <a class="has-link-grey -link" href="/categories/Web-前端/iThome2021鐵人賽/">iThome2021鐵人賽</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/2021/10/12/angular-30days-form-and-test-27/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt="Angular 深入淺出三十天：表單與測試 Day27 - Reactive Forms 進階技巧 - 跨欄位驗證">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2021-10-12T01:14:51.000Z">2021-10-12</time></div>
                    <a href="/2021/10/12/angular-30days-form-and-test-27/" class="title has-link-black-ter is-size-6 has-text-weight-normal">Angular 深入淺出三十天：表單與測試 Day27 - Reactive Forms 進階技巧 - 跨欄位驗證</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Web-前端/">Web 前端</a> / <a class="has-link-grey -link" href="/categories/Web-前端/iThome2021鐵人賽/">iThome2021鐵人賽</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/2021/10/11/angular-30days-form-and-test-26/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="/images/thumbnail.svg" alt="Angular 深入淺出三十天：表單與測試 Day26 - 進階表單開發技巧 - 自訂驗證器">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2021-10-11T11:32:17.000Z">2021-10-11</time></div>
                    <a href="/2021/10/11/angular-30days-form-and-test-26/" class="title has-link-black-ter is-size-6 has-text-weight-normal">Angular 深入淺出三十天：表單與測試 Day26 - 進階表單開發技巧 - 自訂驗證器</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Web-前端/">Web 前端</a> / <a class="has-link-grey -link" href="/categories/Web-前端/iThome2021鐵人賽/">iThome2021鐵人賽</a>
                    </p>
                </div>
            </div>
        </article>
        
    </div>
</div>

    
        <div class="card widget">
    <div class="card-content">
        <div class="menu">
        <h3 class="menu-label">
            彙整
        </h3>
        <ul class="menu-list">
        
        <li>
            <a class="level is-marginless" href="/archives/2021/10/">
                <span class="level-start">
                    <span class="level-item">十月 2021</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">15</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2021/09/">
                <span class="level-start">
                    <span class="level-item">九月 2021</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">15</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2021/05/">
                <span class="level-start">
                    <span class="level-item">五月 2021</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2021/03/">
                <span class="level-start">
                    <span class="level-item">三月 2021</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/12/">
                <span class="level-start">
                    <span class="level-item">十二月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/10/">
                <span class="level-start">
                    <span class="level-item">十月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        </ul>
        </div>
    </div>
</div>
    
        <div class="card widget">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                標籤
            </h3>
            <div class="field is-grouped is-grouped-multiline">
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/angular/">
                        <span class="tag">angular</span>
                        <span class="tag is-grey">34</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/form/">
                        <span class="tag">form</span>
                        <span class="tag is-grey">30</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/frontend/">
                        <span class="tag">frontend</span>
                        <span class="tag is-grey">30</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/git/">
                        <span class="tag">git</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/homebrew/">
                        <span class="tag">homebrew</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/library/">
                        <span class="tag">library</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/macos/">
                        <span class="tag">macos</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/nx/">
                        <span class="tag">nx</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/scss/">
                        <span class="tag">scss</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/testing/">
                        <span class="tag">testing</span>
                        <span class="tag is-grey">30</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/typescript/">
                        <span class="tag">typescript</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/web/">
                        <span class="tag">web</span>
                        <span class="tag is-grey">30</span>
                    </a>
                </div>
                
            </div>
        </div>
    </div>
</div>
    
    
</div>

            </div>
        </div>
    </section>
    <footer class="footer">
    <div class="container">
        <div class="level">
            <div class="level-start has-text-centered-mobile">
                <a class="footer-logo is-block has-mb-6" href="/">
                
                    <img src="/images/logo.png" alt="Leo&#39;s Coding Life" height="28">
                
                </a>
                <p class="is-size-7">
                &copy; 2021 Leo Chen&nbsp;
                Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> & <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank">Icarus</a>
                
                </p>
            </div>
            <div class="level-end">
            
                <div class="field has-addons is-flex-center-mobile has-mt-5-mobile is-flex-wrap is-flex-middle">
                
                
                <p class="control">
                    <a class="button is-white is-large" target="_blank" title="Creative Commons" href="https://creativecommons.org/">
                        
                        <i class="fab fa-creative-commons"></i>
                        
                    </a>
                </p>
                
                <p class="control">
                    <a class="button is-white is-large" target="_blank" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/">
                        
                        <i class="fab fa-creative-commons-by"></i>
                        
                    </a>
                </p>
                
                <p class="control">
                    <a class="button is-white is-large" target="_blank" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus">
                        
                        <i class="fab fa-github"></i>
                        
                    </a>
                </p>
                
                </div>
            
            </div>
        </div>
    </div>
</footer>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script>
<script>moment.locale("zh-TW");</script>


    
    
    
    <script src="/js/animation.js"></script>
    

    
    
    
    <script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script>
    <script src="/js/gallery.js" defer></script>
    

    
    

<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" href="http://outdatedbrowser.com/">Update
            my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.js" defer></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        });
    });
</script>


    
    
<script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    MathJax.Hub.Config({
        'HTML-CSS': {
            matchFontHeight: false
        },
        SVG: {
            matchFontHeight: false
        },
        CommonHTML: {
            matchFontHeight: false
        },
        tex2jax: {
            inlineMath: [
                ['$','$'],
                ['\\(','\\)']
            ]
        }
    });
});
</script>

    
    

<a id="back-to-top" title="回到頁首" href="javascript:;">
    <i class="fas fa-chevron-up"></i>
</a>
<script src="/js/back-to-top.js" defer></script>


    
    

    
    
    
    

    
    
    
    
    
    <script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script>
    <script src="/js/clipboard.js" defer></script>
    

    
    
    


<script src="/js/main.js" defer></script>

    
    <div class="searchbox ins-search">
    <div class="searchbox-container ins-search-container">
        <div class="searchbox-input-wrapper">
            <input type="text" class="searchbox-input ins-search-input" placeholder="請輸入關鍵字...">
            <span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="searchbox-result-wrapper ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: '文章',
                PAGES: '頁面',
                CATEGORIES: '分類',
                TAGS: '標籤',
                UNTITLED: '(無標題)',
            },
            CONTENT_URL: '/content.json',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>
<script src="/js/insight.js" defer></script>
<link rel="stylesheet" href="/css/search.css">
<link rel="stylesheet" href="/css/insight.css">
    
</body>
</html>